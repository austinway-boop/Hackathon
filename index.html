<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grow A Beanstock</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #87CEEB;
        }

        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .start-screen h1 {
            font-size: 4rem;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .start-button {
            padding: 20px 40px;
            font-size: 2rem;
            background: #FFA726;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background: #FF9800;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: none;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('Assets/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 1;
        }

        .clouds-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .cloud {
            position: absolute;
            pointer-events: none;
        }

        .grass-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background-image: url('Assets/grass.png');
            background-repeat: repeat-x;
            background-position: bottom;
            background-size: auto 250px;
            z-index: 6;
            pointer-events: none;
        }

        .pots-container {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            z-index: 5;
            width: 95%;
            max-width: 1400px;
            height: 120px;
        }

        .pot {
            background-image: url('Assets/pot.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom;
            width: 100px;
            height: 100px;
            cursor: default; /* No longer clickable - just show growth progress on hover */
            transition: all 0.3s ease;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            position: relative;
            z-index: 10; /* Definitively in front of vines (z-index: 1) */
        }

        .pot:hover:not(.ready):not(.growing) {
            transform: scale(1.15) translateY(-5px);
            filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.4));
        }

        .pot.drag-hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(76, 175, 80, 0.6));
            transition: all 0.2s ease;
        }

        /* Vine Growing System */
        .vine {
            position: absolute;
            bottom: 40px; /* Start at pot level */
            left: 50%;
            transform: translateX(-50%) scale(0.3, 0); /* Start narrow and no height */
            transform-origin: bottom center; /* Grow upward from bottom */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom center;
            width: 250px; /* Much bigger width */
            height: 500px; /* Much bigger height */
            pointer-events: none; /* Default no pointer events during growth */
            z-index: 1; /* Definitely behind pot images */
            transition: transform 0.3s ease;
            visibility: visible; /* Ensure vine stays visible */
            opacity: 1; /* Ensure vine stays opaque */
        }

        .vine.growing {
            animation: vineGrowth linear forwards;
        }

        .vine.ready {
            transform: translateX(-50%) scale(1, 1) !important;
            animation: none; /* Remove golden glow animation */
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto; /* Enable hover for ready vines */
        }

        .vine.grown {
            transform: translateX(-50%) scale(1, 1) !important;
            animation: none; /* Stop any animations */
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto; /* Enable hover for grown vines */
        }

        /* Vine Hover Effect - like pot hover */
        .vine.ready:hover, .vine.grown:hover {
            transform: translateX(-50%) scale(1.1, 1.05) translateY(-3px) !important;
            filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.4));
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes vineGrowth {
            0% {
                transform: translateX(-50%) scale(0.3, 0); /* Start narrow and no height */
            }
            50% {
                transform: translateX(-50%) scale(0.7, 0.5); /* Mid growth - getting wider and taller */
            }
            100% {
                transform: translateX(-50%) scale(1, 1); /* Full size both ways */
            }
        }

        @keyframes readyPulse {
            from {
                filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
            }
            to {
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.9));
            }
        }



        .pot.growing {
            filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.6));
        }

        @keyframes readyGlow {
            from {
                filter: drop-shadow(0 0 15px gold) drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            }
            to {
                filter: drop-shadow(0 0 25px orange) drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            }
        }

        @keyframes cloudMoveRight {
            0% {
                transform: translateX(-200px) scale(var(--start-scale)) translateY(0px);
            }
            25% {
                transform: translateX(25vw) scale(var(--mid-scale)) translateY(var(--drift-1));
            }
            50% {
                transform: translateX(50vw) scale(var(--end-scale)) translateY(var(--drift-2));
            }
            75% {
                transform: translateX(75vw) scale(var(--mid-scale)) translateY(var(--drift-1));
            }
            100% {
                transform: translateX(calc(100vw + 200px)) scale(var(--start-scale)) translateY(0px);
            }
        }

        @keyframes cloudMoveLeft {
            0% {
                transform: translateX(calc(100vw + 200px)) scale(var(--start-scale)) translateY(0px);
            }
            25% {
                transform: translateX(75vw) scale(var(--mid-scale)) translateY(var(--drift-1));
            }
            50% {
                transform: translateX(50vw) scale(var(--end-scale)) translateY(var(--drift-2));
            }
            75% {
                transform: translateX(25vw) scale(var(--mid-scale)) translateY(var(--drift-1));
            }
            100% {
                transform: translateX(-200px) scale(var(--start-scale)) translateY(0px);
            }
        }

        .cloud.moving-right {
            animation: cloudMoveRight linear infinite;
        }

        .cloud.moving-left {
            animation: cloudMoveLeft linear infinite;
        }

        .hidden {
            display: none !important;
        }

        /* UI Container Styles */
        .ui-container {
            position: absolute;
            top: 30px;
            right: 40px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-end;
        }

        .money-display {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 4px solid #8B4513;
            border-radius: 15px;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.4),
                inset 0 -2px 4px rgba(0,0,0,0.2);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 24px;
            color: #4A4A4A;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            animation: moneyGlow 3s ease-in-out infinite alternate;
            min-width: 150px;
            pointer-events: none;
        }

        .shop-button {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border: 4px solid #1B5E20;
            border-radius: 15px;
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 20px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -2px 4px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            min-width: 120px;
            animation: shopGlow 4s ease-in-out infinite alternate;
        }

        .shop-button:hover {
            background: linear-gradient(135deg, #66BB6A, #388E3C);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 12px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.3);
        }

        .shop-button:active {
            transform: translateY(0px);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .inventory-button {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border: 4px solid #0D47A1;
            border-radius: 15px;
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 20px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -2px 4px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            min-width: 120px;
            animation: inventoryGlow 5s ease-in-out infinite alternate;
        }

        .inventory-button:hover {
            background: linear-gradient(135deg, #42A5F5, #1E88E5);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 12px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.3);
        }

        .inventory-button:active {
            transform: translateY(0px);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Fire Tool Styles - No Box */
        .fire-tool {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 80px;
            transition: all 0.3s ease;
        }

        /* Level 3 Tools Container */
        .level3-tools {
            position: fixed;
            top: 240px;
            right: 40px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
            z-index: 15;
        }

        .fire-emoji {
            font-size: 48px;
            cursor: grab;
            user-select: none;
            transition: all 0.3s ease;
            text-shadow: 
                0 0 10px rgba(255, 87, 34, 0.8),
                0 0 20px rgba(255, 87, 34, 0.6),
                0 0 30px rgba(255, 87, 34, 0.4);
            animation: fireFlicker 2s ease-in-out infinite alternate;
        }

        .fire-emoji:hover {
            font-size: 52px;
            transform: scale(1.1);
            text-shadow: 
                0 0 15px rgba(255, 87, 34, 1),
                0 0 25px rgba(255, 87, 34, 0.8),
                0 0 35px rgba(255, 87, 34, 0.6);
        }

        .fire-emoji:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .fire-emoji.dragging {
            opacity: 0.8;
            transform: scale(1.3);
            z-index: 1000;
            position: fixed;
            pointer-events: none;
            text-shadow: 
                0 0 20px rgba(255, 87, 34, 1),
                0 0 40px rgba(255, 87, 34, 0.8),
                0 0 60px rgba(255, 87, 34, 0.6);
        }

        /* Fire label removed - emoji is self-explanatory */

        @keyframes fireFlicker {
            0% {
                text-shadow: 
                    0 0 10px rgba(255, 87, 34, 0.8),
                    0 0 20px rgba(255, 87, 34, 0.6),
                    0 0 30px rgba(255, 87, 34, 0.4);
            }
            50% {
                text-shadow: 
                    0 0 15px rgba(255, 140, 0, 0.9),
                    0 0 25px rgba(255, 140, 0, 0.7),
                    0 0 35px rgba(255, 140, 0, 0.5);
            }
            100% {
                text-shadow: 
                    0 0 12px rgba(255, 69, 0, 0.85),
                    0 0 22px rgba(255, 69, 0, 0.65),
                    0 0 32px rgba(255, 69, 0, 0.45);
            }
        }

        /* Remove old fireGlow animation */

        @keyframes fireUnlock {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translateY(-5px) scale(1.1);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes burnShrink {
            0% {
                opacity: 1;
                transform: translateX(-50%) scale(1, 1); /* Full size - exactly like vineGrowth end */
                filter: brightness(1) sepia(0.3) hue-rotate(15deg);
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(0.7, 0.5); /* Mid shrink - exactly like vineGrowth middle */
                filter: brightness(0.8) sepia(0.6) hue-rotate(25deg);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) scale(0.3, 0); /* Back in pot - exactly like vineGrowth start */
                filter: brightness(0.6) sepia(1) hue-rotate(35deg);
            }
        }

        .vine.burning {
            transform-origin: bottom center !important;
            animation-fill-mode: forwards !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Force the burnShrink animation to take precedence */
        .vine.burning[style*="burnShrink"] {
            animation-duration: 2s !important;
            animation-timing-function: ease-in-out !important;
            animation-fill-mode: forwards !important;
        }

        .pot.burn-target {
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.8);
            border: 2px solid #FF5722;
            animation: burnTargetPulse 1s ease-in-out infinite alternate;
        }

        @keyframes burnTargetPulse {
            0% {
                box-shadow: 0 0 20px rgba(255, 87, 34, 0.8);
            }
            100% {
                box-shadow: 0 0 30px rgba(255, 87, 34, 1);
            }
        }

        .vine.burning {
            animation: burning 0.5s ease-in-out;
        }

        @keyframes burning {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.5) saturate(2) hue-rotate(20deg); }
            100% { filter: brightness(0.8) saturate(0.5); }
        }

        /* Burnt remnant state - stays shrunken in pot */
        .vine.burnt-remnant {
            transform: translateX(-50%) scale(0.3, 0) !important;
            filter: brightness(0.6) sepia(1) hue-rotate(35deg) !important;
            opacity: 0.8 !important;
            animation: none !important;
            pointer-events: none; /* Can't interact with burnt remnants */
        }

        /* Pot with burnt plant styling */
        .pot.burnt {
            filter: drop-shadow(0 0 8px rgba(139, 69, 19, 0.6));
            cursor: pointer; /* Allow replanting over burnt remnant */
        }

        .pot.burnt:hover {
            transform: scale(1.1) translateY(-3px);
            filter: drop-shadow(4px 4px 12px rgba(139, 69, 19, 0.8));
        }

        .money-amount {
            letter-spacing: 1px;
            text-align: center;
            transition: all 0.3s ease;
        }

        @keyframes moneyGlow {
            0% {
                box-shadow: 
                    0 4px 8px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.4),
                    inset 0 -2px 4px rgba(0,0,0,0.2),
                    0 0 15px rgba(255, 215, 0, 0.6);
            }
            100% {
                box-shadow: 
                    0 4px 8px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.4),
                    inset 0 -2px 4px rgba(0,0,0,0.2),
                    0 0 25px rgba(255, 215, 0, 0.9);
            }
        }

        @keyframes shopGlow {
            0% {
                box-shadow: 
                    0 4px 8px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.2),
                    inset 0 -2px 4px rgba(0,0,0,0.3),
                    0 0 10px rgba(76, 175, 80, 0.4);
            }
            100% {
                box-shadow: 
                    0 4px 8px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.2),
                    inset 0 -2px 4px rgba(0,0,0,0.3),
                    0 0 20px rgba(76, 175, 80, 0.7);
            }
        }

        @keyframes inventoryGlow {
            0% {
                box-shadow: 
                    0 4px 8px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.2),
                    inset 0 -2px 4px rgba(0,0,0,0.3),
                    0 0 10px rgba(33, 150, 243, 0.4);
            }
            100% {
                box-shadow: 
                    0 4px 8px rgba(0,0,0,0.3),
                    inset 0 2px 4px rgba(255,255,255,0.2),
                    inset 0 -2px 4px rgba(0,0,0,0.3),
                    0 0 20px rgba(33, 150, 243, 0.7);
            }
        }

        /* Money change animation */
        .money-amount.changing {
            animation: moneyChange 0.5s ease-in-out;
        }

        @keyframes moneyChange {
            0% { 
                transform: scale(1);
                color: #4A4A4A;
            }
            50% { 
                transform: scale(1.2);
                color: #FF6B35;
                text-shadow: 0 0 8px rgba(255, 107, 53, 0.8);
            }
            100% { 
                transform: scale(1);
                color: #4A4A4A;
            }
        }

        /* Bean spawn system styles */
        .vine-bean {
            position: absolute !important;
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 15; /* Above pots (z-index: 10) so hitboxes work properly */
            pointer-events: auto !important; /* Enable hover interactions */
            transform-origin: center;
            transition: all 0.3s ease; /* Smooth hover transition */
            cursor: pointer; /* Show it's interactive */
            /* NO DEFAULT ANIMATION - will be added after spawning */
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
        }

        /* Hover effect for beans - expand slightly while preserving rotation (but not when clicked or flying) */
        .vine-bean:hover:not(.clicked):not(.flying-to-money) {
            transform: scale(calc(var(--final-scale) * 1.3)) rotate(var(--final-rotation)) !important;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.9)) !important;
            z-index: 20; /* Bring hovered bean to front, above all other elements */
        }

        /* Satisfying click effect for beans */
        .vine-bean.clicked {
            animation: beanClickPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards !important;
        }

        @keyframes beanClickPop {
            0% {
                transform: scale(var(--final-scale)) rotate(var(--final-rotation));
                filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
            }
            50% {
                transform: scale(calc(var(--final-scale) * 1.8)) rotate(calc(var(--final-rotation) + 15deg));
                filter: drop-shadow(0 0 25px rgba(255, 215, 0, 1.2)) drop-shadow(0 0 50px rgba(255, 215, 0, 0.8));
            }
            100% {
                transform: scale(calc(var(--final-scale) * 1.3)) rotate(calc(var(--final-rotation) + 10deg));
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1.0)) drop-shadow(0 0 40px rgba(255, 215, 0, 0.6));
            }
        }

        /* Click burst effect around bean */
        .click-burst {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 99;
            animation: clickBurstAnimation 0.4s ease-out forwards;
        }

        @keyframes clickBurstAnimation {
            0% {
                transform: scale(0);
                opacity: 1;
                background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0.4) 30%, rgba(255,255,255,0.2) 60%, transparent 100%);
                box-shadow: 0 0 20px rgba(255,215,0,0.8);
            }
            50% {
                transform: scale(1);
                opacity: 0.8;
                background: radial-gradient(circle, rgba(255,215,0,0.6) 0%, rgba(255,215,0,0.3) 30%, rgba(255,255,255,0.1) 60%, transparent 100%);
                box-shadow: 0 0 40px rgba(255,215,0,0.6);
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
                background: radial-gradient(circle, transparent 0%, transparent 30%, transparent 60%, transparent 100%);
                box-shadow: 0 0 60px rgba(255,215,0,0.2);
            }
        }

        /* Amazing bean-to-money flying animation */
        .vine-bean.flying-to-money {
            z-index: 100 !important; /* Above everything */
            pointer-events: none !important; /* No more interactions */
            animation: none !important; /* Stop pulsing */
            transition: none !important; /* Disable normal transitions */
            /* Make the flying bean more prominent while preserving rotation */
            transform: scale(calc(var(--final-scale) * 1.2)) rotate(var(--final-rotation)) !important;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 1.0)) drop-shadow(0 0 30px rgba(255, 215, 0, 0.7)) !important;
        }

        @keyframes beanFlyToMoney {
            0% {
                transform: scale(calc(var(--final-scale) * 1.2)) rotate(var(--final-rotation));
                opacity: 1;
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 1.0)) drop-shadow(0 0 30px rgba(255, 215, 0, 0.7));
            }
            25% {
                transform: scale(calc(var(--final-scale) * 1.5)) rotate(calc(var(--final-rotation) + 180deg));
                opacity: 1;
                filter: drop-shadow(0 0 25px rgba(255, 215, 0, 1.2)) drop-shadow(0 0 50px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 75px rgba(255, 255, 255, 0.4));
            }
            50% {
                transform: scale(calc(var(--final-scale) * 1.3)) rotate(calc(var(--final-rotation) + 360deg));
                opacity: 1;
                filter: drop-shadow(0 0 30px rgba(255, 215, 0, 1.4)) drop-shadow(0 0 60px rgba(255, 215, 0, 0.9)) drop-shadow(0 0 90px rgba(255, 255, 255, 0.5));
            }
            75% {
                transform: scale(calc(var(--final-scale) * 1.1)) rotate(calc(var(--final-rotation) + 540deg));
                opacity: 0.9;
                filter: drop-shadow(0 0 35px rgba(255, 215, 0, 1.5)) drop-shadow(0 0 70px rgba(255, 215, 0, 1.0)) drop-shadow(0 0 105px rgba(255, 255, 255, 0.6));
            }
            100% {
                transform: scale(calc(var(--final-scale) * 0.8)) rotate(calc(var(--final-rotation) + 720deg));
                opacity: 0.7;
                filter: drop-shadow(0 0 40px rgba(255, 215, 0, 1.6)) drop-shadow(0 0 80px rgba(255, 215, 0, 1.1)) drop-shadow(0 0 120px rgba(255, 255, 255, 0.7));
            }
        }

        /* Trail effect for flying beans */
        .vine-bean.flying-to-money::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            left: -10px;
            top: -10px;
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, rgba(255,215,0,0.1) 50%, transparent 100%);
            border-radius: 50%;
            animation: trailPulse 0.3s ease-out infinite;
        }

        @keyframes trailPulse {
            0% {
                transform: scale(0.8);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.3;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Subtle screen shake for satisfying feedback */
        @keyframes screenShake {
            0% { transform: translateX(0); }
            10% { transform: translateX(-2px) translateY(1px); }
            20% { transform: translateX(2px) translateY(-1px); }
            30% { transform: translateX(-1px) translateY(2px); }
            40% { transform: translateX(1px) translateY(-2px); }
            50% { transform: translateX(-2px) translateY(1px); }
            60% { transform: translateX(2px) translateY(-1px); }
            70% { transform: translateX(-1px) translateY(2px); }
            80% { transform: translateX(1px) translateY(-2px); }
            90% { transform: translateX(-1px) translateY(1px); }
            100% { transform: translateX(0); }
        }

        /* Money burst effect when beans are collected */
        .money-burst {
            position: fixed;
            color: #FFD700;
            font-weight: bold;
            font-size: 24px;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 101;
            pointer-events: none;
            animation: moneyBurst 1.5s ease-out forwards;
        }

        @keyframes moneyBurst {
            0% {
                transform: scale(0.5) translateY(0px);
                opacity: 0;
            }
            20% {
                transform: scale(1.2) translateY(-10px);
                opacity: 1;
            }
            100% {
                transform: scale(1.0) translateY(-40px);
                opacity: 0;
            }
        }

        /* Only apply pulsing animation after bean is spawned and positioned, but pause on hover and when clicked */
        .vine-bean.spawned:not(:hover):not(.clicked):not(.flying-to-money) {
            animation: beanPulse 2s ease-in-out infinite alternate;
        }

        @keyframes beanPulse {
            0% {
                /* Use CSS variables to preserve individual bean transforms */
                transform: scale(calc(var(--final-scale) * 0.9)) rotate(var(--final-rotation));
                opacity: 0.8;
                filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
            }
            50% {
                transform: scale(calc(var(--final-scale) * 1.1)) rotate(var(--final-rotation));
                opacity: 1;
                filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.8));
            }
            100% {
                transform: scale(calc(var(--final-scale) * 0.95)) rotate(var(--final-rotation));
                opacity: 0.9;
                filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7));
            }
        }

        /* Initial spawning state for beans */
        .vine-bean:not(.spawned) {
            transform-origin: center;
            /* Initial state - invisible and small */
            opacity: 0;
            transform: scale(0) rotate(0deg);
            transition: all 0.5s ease-out;
        }

        .vine-bean.spawned {
            /* Visible state after spawning */
            opacity: 0.8;
            transition: all 0.5s ease-out;
        }

        /* Special effects for shiny (silver) beans - 3% chance, 200% more valuable */
        .vine-bean.rarity-shiny {
            position: relative;
            filter: brightness(1.1) contrast(1.05) saturate(0.9);
            border: 1px solid rgba(192, 192, 192, 0.3);
            animation: beanPulse 2s ease-in-out infinite alternate !important;
        }
        
        /* Create glow effect behind the bean */
        .vine-bean.rarity-shiny::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            background: 
                linear-gradient(45deg, 
                    rgba(192, 192, 192, 0.6), 
                    rgba(255, 255, 255, 0.7), 
                    rgba(192, 192, 192, 0.6), 
                    rgba(255, 255, 255, 0.7)),
                radial-gradient(circle at center,
                    rgba(255, 255, 255, 0.4) 0%,
                    rgba(192, 192, 192, 0.2) 50%,
                    transparent 80%);
            background-size: 200% 200%, 100% 100%;
            border-radius: 50%;
            z-index: -1;
            box-shadow: 
                0 0 25px rgba(192, 192, 192, 0.8), 
                0 0 40px rgba(255, 255, 255, 0.6),
                inset 0 0 15px rgba(255, 255, 255, 0.3);
            animation: silverShimmer 1.8s ease-in-out infinite alternate;
        }

        .vine-bean.rarity-shiny:hover:not(.clicked):not(.flying-to-money) {
            transform: scale(calc(var(--final-scale) * 1.4)) rotate(var(--final-rotation)) !important;
            filter: drop-shadow(0 0 25px rgba(192, 192, 192, 1)) !important;
        }
        
        .vine-bean.rarity-shiny:hover:not(.clicked):not(.flying-to-money)::before {
            box-shadow: 
                0 0 45px rgba(192, 192, 192, 0.8), 
                0 0 70px rgba(255, 255, 255, 0.7),
                0 0 90px rgba(192, 192, 192, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.6);
            filter: brightness(1.9) contrast(1.6);
            transform: scale(1.1) rotate(2deg);
        }

        @keyframes silverShimmer {
            0% {
                background-position: -200% -200%, center;
                filter: brightness(1.3) contrast(1.2);
                transform: scale(1) rotate(0deg);
            }
            50% {
                background-position: 0% 0%, center;
                filter: brightness(1.6) contrast(1.4);
                transform: scale(1.05) rotate(1deg);
            }
            100% {
                background-position: 200% 200%, center;
                filter: brightness(1.8) contrast(1.5);
                transform: scale(1) rotate(0deg);
            }
        }

        /* Special effects for golden beans - 3% chance, 500% more valuable */
        .vine-bean.rarity-golden {
            position: relative;
            filter: brightness(1.15) contrast(1.1) saturate(1.1);
            border: 2px solid rgba(255, 215, 0, 0.4);
            animation: beanPulse 2s ease-in-out infinite alternate !important;
        }
        
        /* Create glow effect behind the bean */
        .vine-bean.rarity-golden::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: 
                linear-gradient(45deg, 
                    rgba(255, 215, 0, 0.7), 
                    rgba(255, 255, 255, 0.8), 
                    rgba(255, 140, 0, 0.6), 
                    rgba(255, 255, 255, 0.8)),
                radial-gradient(circle at center,
                    rgba(255, 255, 255, 0.6) 0%,
                    rgba(255, 215, 0, 0.4) 40%,
                    rgba(255, 140, 0, 0.2) 70%,
                    transparent 85%);
            background-size: 200% 200%, 100% 100%;
            border-radius: 50%;
            z-index: -1;
            box-shadow: 
                0 0 35px rgba(255, 215, 0, 0.8), 
                0 0 50px rgba(255, 140, 0, 0.6),
                0 0 70px rgba(255, 215, 0, 0.4),
                inset 0 0 20px rgba(255, 255, 255, 0.4);
            animation: goldenGlow 1.2s ease-in-out infinite alternate;
        }

        .vine-bean.rarity-golden:hover:not(.clicked):not(.flying-to-money) {
            transform: scale(calc(var(--final-scale) * 1.5)) rotate(var(--final-rotation)) !important;
            filter: drop-shadow(0 0 35px rgba(255, 215, 0, 1)) !important;
        }
        
        .vine-bean.rarity-golden:hover:not(.clicked):not(.flying-to-money)::before {
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.8), 
                0 0 85px rgba(255, 140, 0, 0.7),
                0 0 110px rgba(255, 215, 0, 0.5),
                inset 0 0 35px rgba(255, 255, 255, 0.6);
            filter: brightness(2.2) contrast(1.7) saturate(1.9);
            transform: scale(1.15) rotate(-2deg);
        }

        @keyframes goldenGlow {
            0% {
                background-position: -200% -200%, center;
                filter: brightness(1.4) contrast(1.3) saturate(1.3);
                transform: scale(1) rotate(0deg);
            }
            33% {
                background-position: 0% 0%, center;
                filter: brightness(1.8) contrast(1.5) saturate(1.6);
                transform: scale(1.08) rotate(-1deg);
            }
            66% {
                background-position: 100% 100%, center;
                filter: brightness(2.0) contrast(1.6) saturate(1.8);
                transform: scale(1.05) rotate(1deg);
            }
            100% {
                background-position: 200% 200%, center;
                filter: brightness(1.6) contrast(1.4) saturate(1.4);
                transform: scale(1) rotate(0deg);
            }
        }

        /* Enhanced flying effects for special beans */
        .vine-bean.rarity-shiny.flying-to-money {
            animation: silverTrail 0.1s linear infinite !important;
        }
        
        .vine-bean.rarity-shiny.flying-to-money::before {
            box-shadow: 0 0 60px rgba(192, 192, 192, 0.8), 0 0 90px rgba(255, 255, 255, 0.6), 0 0 120px rgba(192, 192, 192, 0.4) !important;
        }

        .vine-bean.rarity-golden.flying-to-money {
            animation: goldenTrail 0.1s linear infinite !important;
        }
        
        .vine-bean.rarity-golden.flying-to-money::before {
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.8), 0 0 110px rgba(255, 140, 0, 0.7), 0 0 140px rgba(255, 215, 0, 0.5) !important;
        }

        @keyframes silverTrail {
            0% { filter: brightness(1.4) contrast(1.2); }
            50% { filter: brightness(1.6) contrast(1.3); }
            100% { filter: brightness(1.4) contrast(1.2); }
        }

        @keyframes goldenTrail {
            0% { filter: brightness(1.5) contrast(1.3) saturate(1.3); }
            50% { filter: brightness(1.8) contrast(1.5) saturate(1.5); }
            100% { filter: brightness(1.5) contrast(1.3) saturate(1.3); }
        }

        /* Size-based bean effects - can compound with rarity! */
        /* Big beans - 2% chance, 200% more valuable (3x multiplier) */
        .vine-bean.size-big {
            transform: scale(1.8) !important;
        }

        /* Massive beans - 0.5% chance, 500% more valuable (6x multiplier) */
        .vine-bean.size-massive {
            transform: scale(3.5) !important;
        }

        /* Compound hover effects for size + rarity */
        .vine-bean.size-big:hover:not(.clicked):not(.flying-to-money) {
            transform: scale(calc(var(--final-scale) * 2.2)) rotate(var(--final-rotation)) !important;
        }

        .vine-bean.size-massive:hover:not(.clicked):not(.flying-to-money) {
            transform: scale(calc(var(--final-scale) * 4.0)) rotate(var(--final-rotation)) !important;
        }

        /* Bean Collection Button Styles */
        .bean-collection-button {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            border: 2px solid #D2691E;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
        }

        .bean-collection-button:hover {
            background: linear-gradient(135deg, #A0522D, #CD853F);
            border-color: #DEB887;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .bean-collection-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Bean Collection Modal Styles */
        .bean-collection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bean-collection-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .bean-collection-modal-content {
            background: linear-gradient(135deg, #2C3E50, #34495E);
            border: 3px solid #3498DB;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        .bean-modal-header {
            color: #3498DB;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(52, 152, 219, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .bean-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 87, 87, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bean-modal-close:hover {
            background: rgba(255, 87, 87, 1);
            transform: scale(1.1);
        }

        .bean-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .bean-slot {
            width: 80px;
            height: 80px;
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .bean-slot-image {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .bean-slot-name {
            font-size: 10px;
            color: #BDC3C7;
            text-align: center;
            margin-top: 4px;
            line-height: 1.1;
        }

        .bean-slot.unlocked {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.6);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
        }

        .bean-slot.unlocked:hover {
            transform: scale(1.05);
            background: rgba(76, 175, 80, 0.3);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        .bean-slot.locked {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
            opacity: 0.6;
        }

        .bean-slot.locked .bean-slot-image {
            filter: grayscale(100%) brightness(0.5);
        }

        .bean-slot.locked .bean-slot-name {
            color: #666;
        }

        @keyframes beanUnlock {
            0% {
                transform: scale(0.8);
                background: rgba(255, 215, 0, 0.1);
                border-color: rgba(255, 215, 0, 0.3);
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
            }
            50% {
                transform: scale(1.2);
                background: rgba(255, 215, 0, 0.4);
                border-color: rgba(255, 215, 0, 0.9);
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.7);
            }
            100% {
                transform: scale(1.0);
                background: rgba(76, 175, 80, 0.2);
                border-color: rgba(76, 175, 80, 0.6);
                box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
            }
        }

        @keyframes modalSlideIn {
            0% {
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
            100% {
                transform: scale(1.0) translateY(0);
                opacity: 1;
            }
        }

        /* Growth Tooltip Styles */
        .growth-tooltip {
            background: linear-gradient(135deg, #2C3E50, #34495E);
            border: 2px solid #3498DB;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-family: 'Arial', sans-serif;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease-out;
            max-width: 200px;
        }

        .growth-tooltip .tooltip-header {
            font-weight: bold;
            color: #3498DB;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .growth-tooltip .tooltip-progress {
            margin-bottom: 6px;
            color: #BDC3C7;
        }

        .growth-tooltip .tooltip-bar {
            width: 100%;
            height: 6px;
            background: rgba(52, 73, 94, 0.8);
            border-radius: 3px;
            overflow: hidden;
        }

        .growth-tooltip .tooltip-fill {
            height: 100%;
            background: linear-gradient(90deg, #27AE60, #2ECC71);
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.5);
        }

        @keyframes tooltipFadeIn {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(5px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }



        /* Inventory Panel Styles */
        .inventory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 15;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .inventory-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .inventory-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: linear-gradient(135deg, #2C3E50, #34495E);
            border-left: 4px solid #3498DB;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 20;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .inventory-panel.active {
            right: 0;
        }

        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #3498DB, #2980B9);
            border-bottom: 3px solid #1F618D;
            position: sticky;
            top: 0;
            z-index: 21;
        }

        .inventory-header h2 {
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .inventory-close {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .inventory-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .inventory-content {
            padding: 20px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .inventory-item {
            background: linear-gradient(135deg, #4A5A6A, #34495E);
            border: 2px solid #52708A;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .inventory-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
            border-color: #3498DB;
        }



        .inventory-item-icon {
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-item.rarity-common .inventory-item-icon {
            filter: drop-shadow(0 0 8px rgba(149, 165, 166, 0.7)) drop-shadow(0 0 16px rgba(149, 165, 166, 0.4));
        }

        .inventory-item.rarity-uncommon .inventory-item-icon {
            filter: drop-shadow(0 0 8px rgba(52, 152, 219, 0.7)) drop-shadow(0 0 16px rgba(52, 152, 219, 0.4));
        }

        .inventory-item.rarity-rare .inventory-item-icon {
            filter: drop-shadow(0 0 8px rgba(155, 89, 182, 0.7)) drop-shadow(0 0 16px rgba(155, 89, 182, 0.4));
        }

        .inventory-item.rarity-legendary .inventory-item-icon {
            filter: drop-shadow(0 0 8px rgba(243, 156, 18, 0.8)) drop-shadow(0 0 16px rgba(243, 156, 18, 0.5)) drop-shadow(0 0 24px rgba(243, 156, 18, 0.3));
        }

        .inventory-item:hover .inventory-item-icon {
            transform: scale(1.15);
        }

        .inventory-item:hover.rarity-common .inventory-item-icon {
            filter: drop-shadow(0 0 12px rgba(149, 165, 166, 0.9)) drop-shadow(0 0 24px rgba(149, 165, 166, 0.6));
        }

        .inventory-item:hover.rarity-uncommon .inventory-item-icon {
            filter: drop-shadow(0 0 12px rgba(52, 152, 219, 0.9)) drop-shadow(0 0 24px rgba(52, 152, 219, 0.6));
        }

        .inventory-item:hover.rarity-rare .inventory-item-icon {
            filter: drop-shadow(0 0 12px rgba(155, 89, 182, 0.9)) drop-shadow(0 0 24px rgba(155, 89, 182, 0.6));
        }

        .inventory-item:hover.rarity-legendary .inventory-item-icon {
            filter: drop-shadow(0 0 12px rgba(243, 156, 18, 1.0)) drop-shadow(0 0 24px rgba(243, 156, 18, 0.7)) drop-shadow(0 0 36px rgba(243, 156, 18, 0.4));
        }

        .inventory-item-quantity {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Empty inventory message */
        .inventory-empty {
            text-align: center;
            color: #BDC3C7;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin-top: 40px;
            opacity: 0.7;
        }

        .inventory-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Seed Tooltip Styles */
        .seed-tooltip {
            position: fixed;
            background: linear-gradient(135deg, #2C3E50, #34495E);
            border: 3px solid #3498DB;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(52, 152, 219, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.1);
            z-index: 1500;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.8) translateY(10px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 280px;
            max-width: 320px;
            color: white;
            font-family: 'Courier New', monospace;
        }

        .seed-tooltip.visible {
            opacity: 1;
            transform: scale(1) translateY(0px);
        }

        .tooltip-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(52, 152, 219, 0.3);
        }

        .tooltip-icon {
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-right: 12px;
            border-radius: 8px;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
        }

        .tooltip-title {
            flex: 1;
        }

        .tooltip-name {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .tooltip-rarity {
            font-size: 12px;
            margin: 2px 0 0 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tooltip-rarity.common { color: #95A5A6; }
        .tooltip-rarity.uncommon { color: #3498DB; }
        .tooltip-rarity.rare { color: #9B59B6; }
        .tooltip-rarity.legendary { color: #F39C12; }
        .tooltip-rarity.mythical { color: #E74C3C; }
        .tooltip-rarity.ultra-mythical { color: #8E44AD; }
        .tooltip-rarity.godly { 
            background: linear-gradient(45deg, #F39C12, #E74C3C, #9B59B6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .tooltip-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tooltip-stat {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .stat-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            opacity: 0.7;
        }

        .tooltip-description {
            font-size: 12px;
            font-style: italic;
            color: #BDC3C7;
            text-align: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(52, 152, 219, 0.2);
        }

        /* Drag and Drop Styles */
        .dragging-seed {
            position: fixed;
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.9;
            transform: translate(-50%, -50%);
            transition: none;
        }

        .dragging-seed.rarity-common {
            filter: drop-shadow(0 0 10px rgba(149, 165, 166, 0.9)) drop-shadow(0 0 20px rgba(149, 165, 166, 0.6));
        }

        .dragging-seed.rarity-uncommon {
            filter: drop-shadow(0 0 10px rgba(52, 152, 219, 0.9)) drop-shadow(0 0 20px rgba(52, 152, 219, 0.6));
        }

        .dragging-seed.rarity-rare {
            filter: drop-shadow(0 0 10px rgba(155, 89, 182, 0.9)) drop-shadow(0 0 20px rgba(155, 89, 182, 0.6));
        }

        .dragging-seed.rarity-legendary {
            filter: drop-shadow(0 0 10px rgba(243, 156, 18, 1.0)) drop-shadow(0 0 20px rgba(243, 156, 18, 0.8)) drop-shadow(0 0 30px rgba(243, 156, 18, 0.5));
        }

        .inventory-item.dragging {
            opacity: 0.5;
            transform: scale(0.9);
        }

        .dragging-seed.pouring {
            transform: translate(-50%, -50%) rotate(45deg);
            transition: transform 0.2s ease;
        }

        /* Shop Panel Styles */
        .shop-panel {
            position: fixed;
            top: 0;
            left: -450px;
            width: 450px;
            height: 100vh;
            background: linear-gradient(135deg, #2C3E50, #34495E);
            border-right: 4px solid #4CAF50;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 20;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .shop-panel.active {
            left: 0;
        }

        .shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 15;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .shop-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border-bottom: 3px solid #1B5E20;
            position: sticky;
            top: 0;
            z-index: 21;
        }

        .shop-header h2 {
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Shop Notification Banner */
        .shop-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 10000;
            animation: slideInFromTop 0.5s ease-out;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .shop-notification.show {
            opacity: 1;
        }

        .shop-notification.warning-2min {
            background: linear-gradient(135deg, #ffa500, #ffcc02);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(255, 165, 0, 0.6),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
        }

        .shop-notification.warning-1min {
            background: linear-gradient(135deg, #ff6b6b, #ff3737);
            animation: pulseUrgent 1s ease-in-out infinite alternate;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.4),
                0 0 35px rgba(255, 55, 55, 0.8),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
        }

        .shop-notification.refresh {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(76, 175, 80, 0.6),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
        }

        @keyframes pulseUrgent {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 
                    0 6px 20px rgba(0, 0, 0, 0.4),
                    0 0 35px rgba(255, 55, 55, 0.8);
            }
            100% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 
                    0 8px 25px rgba(0, 0, 0, 0.5),
                    0 0 45px rgba(255, 55, 55, 1);
            }
        }

        /* Tutorial Objective Display */
        .tutorial-objective {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px 30px 22px 30px;
            border-radius: 30px;
            font-family: 'Arial', sans-serif;
            font-size: 17px;
            font-weight: bold;
            text-align: left;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            z-index: 15000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            max-width: 480px;
            min-width: 340px;
        }

        .tutorial-objective.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .tutorial-objective-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .tutorial-objective-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
        }

        .tutorial-objective-icon {
            font-size: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .tutorial-objective-text {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
            font-size: 16px;
        }

        .tutorial-progress-container {
            width: 100%;
            margin-top: 8px;
        }

        .tutorial-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tutorial-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        .tutorial-progress-fill.complete {
            background: linear-gradient(90deg, #32CD32, #228B22);
            box-shadow: 0 0 12px rgba(50, 205, 50, 0.8);
            animation: progressGlow 1s ease-in-out;
        }

        @keyframes progressGlow {
            0% { box-shadow: 0 0 8px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 20px rgba(50, 205, 50, 1); }
            100% { box-shadow: 0 0 12px rgba(50, 205, 50, 0.8); }
        }

        /* Tutorial Completion Message Styles */
        .tutorial-objective.tutorial-completed {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 2px solid #FF8C00;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
            max-width: 520px;
        }

        .tutorial-completion-message {
            text-align: center;
        }

        .tutorial-completion-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #1a1a1a;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);
        }

        .tutorial-completion-content {
            font-size: 16px;
            line-height: 1.5;
            color: #2c2c2c;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.2);
        }

        .tutorial-dismiss-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .tutorial-dismiss-btn:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        .tutorial-dismiss-btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        /* Level Bar Styles */
        .level-bar-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: 3px solid #1a252f;
            border-radius: 15px;
            padding: 15px 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
            min-width: 320px;
            user-select: none;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .level-label {
            font-size: 16px;
            color: #f39c12;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .xp-label {
            font-size: 14px;
            color: #bdc3c7;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .level-bar {
            position: relative;
            width: 100%;
            height: 20px;
            background: linear-gradient(135deg, #1a252f, #2c3e50);
            border-radius: 10px;
            border: 2px solid #34495e;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .level-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71, #58d68d);
            border-radius: 8px;
            transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
            width: 0%;
        }

        .level-bar-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 8px;
            animation: levelGlow 2s ease-in-out infinite;
        }

        @keyframes levelGlow {
            0%, 100% {
                transform: translateX(-100%);
            }
            50% {
                transform: translateX(100%);
            }
        }

        /* Level up animation */
        .level-bar-fill.level-up {
            animation: levelUpFlash 1s ease-in-out;
        }

        @keyframes levelUpFlash {
            0% { box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4); }
            50% { 
                box-shadow: 0 4px 20px rgba(241, 196, 15, 1);
                background: linear-gradient(90deg, #f1c40f, #f39c12, #e67e22);
            }
            100% { box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4); }
        }

        .tutorial-progress-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin-top: 4px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        @keyframes slideInFromTop {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            from {
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            }
            to {
                box-shadow: 0 4px 25px rgba(255, 0, 0, 0.5);
            }
        }

        /* Tutorial System - Hidden since we only use top-left objective box */
        .tutorial-overlay {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }

        .tutorial-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .tutorial-modal {
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .tutorial-overlay.show .tutorial-modal {
            transform: scale(1);
        }

        .tutorial-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .tutorial-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .tutorial-close {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .tutorial-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tutorial-content {
            margin-bottom: 25px;
        }

        .tutorial-step {
            margin-bottom: 20px;
        }

        .tutorial-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .tutorial-step p {
            font-size: 18px;
            line-height: 1.6;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .tutorial-progress {
            margin-top: 20px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #FFA726, #FFD54F);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .tutorial-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .tutorial-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .skip-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .skip-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .next-btn {
            background: linear-gradient(135deg, #FFA726, #FFD54F);
            color: #2E7D32;
            border: 2px solid transparent;
        }

        .next-btn:hover {
            background: linear-gradient(135deg, #FFB74D, #FFF176);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .shop-close {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .shop-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .shop-content {
            padding: 20px;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .shop-item {
            background: linear-gradient(135deg, #4A5A6A, #34495E);
            border: 2px solid #52708A;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }



        .shop-item-icon {
            width: 90px;
            height: 90px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto 10px auto;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .shop-item.rarity-common .shop-item-icon {
            filter: drop-shadow(0 0 8px rgba(149, 165, 166, 0.7)) drop-shadow(0 0 16px rgba(149, 165, 166, 0.4));
        }

        .shop-item.rarity-uncommon .shop-item-icon {
            filter: drop-shadow(0 0 8px rgba(52, 152, 219, 0.7)) drop-shadow(0 0 16px rgba(52, 152, 219, 0.4));
        }

        .shop-item.rarity-rare .shop-item-icon {
            filter: drop-shadow(0 0 8px rgba(155, 89, 182, 0.7)) drop-shadow(0 0 16px rgba(155, 89, 182, 0.4));
        }

        .shop-item.rarity-legendary .shop-item-icon {
            filter: drop-shadow(0 0 8px rgba(243, 156, 18, 0.8)) drop-shadow(0 0 16px rgba(243, 156, 18, 0.5)) drop-shadow(0 0 24px rgba(243, 156, 18, 0.3));
        }

        .shop-item.rarity-mythical .shop-item-icon {
            filter: drop-shadow(0 0 8px rgba(233, 30, 99, 0.8)) drop-shadow(0 0 16px rgba(233, 30, 99, 0.5)) drop-shadow(0 0 24px rgba(233, 30, 99, 0.3));
        }

        .shop-item.rarity-ultra_mythical .shop-item-icon {
            filter: drop-shadow(0 0 8px rgba(156, 39, 176, 0.9)) drop-shadow(0 0 16px rgba(156, 39, 176, 0.6)) drop-shadow(0 0 32px rgba(156, 39, 176, 0.4));
        }

        .shop-item.rarity-godly .shop-item-icon {
            filter: 
                drop-shadow(0 0 10px rgba(255, 215, 0, 1.0)) 
                drop-shadow(0 0 20px rgba(255, 69, 0, 0.8)) 
                drop-shadow(0 0 30px rgba(255, 20, 147, 0.6))
                drop-shadow(0 0 40px rgba(138, 43, 226, 0.4));
            animation: godlyPulse 2s ease-in-out infinite alternate;
        }

        @keyframes godlyPulse {
            0% { 
                filter: 
                    drop-shadow(0 0 10px rgba(255, 215, 0, 1.0)) 
                    drop-shadow(0 0 20px rgba(255, 69, 0, 0.8)) 
                    drop-shadow(0 0 30px rgba(255, 20, 147, 0.6))
                    drop-shadow(0 0 40px rgba(138, 43, 226, 0.4));
            }
            100% { 
                filter: 
                    drop-shadow(0 0 15px rgba(255, 215, 0, 1.0)) 
                    drop-shadow(0 0 25px rgba(255, 69, 0, 1.0)) 
                    drop-shadow(0 0 35px rgba(255, 20, 147, 0.8))
                    drop-shadow(0 0 50px rgba(138, 43, 226, 0.6));
            }
        }

        .shop-item.available:hover .shop-item-icon {
            transform: scale(1.15);
        }

        .shop-item.available:hover.rarity-common .shop-item-icon {
            filter: drop-shadow(0 0 12px rgba(149, 165, 166, 0.9)) drop-shadow(0 0 24px rgba(149, 165, 166, 0.6));
        }

        .shop-item.available:hover.rarity-uncommon .shop-item-icon {
            filter: drop-shadow(0 0 12px rgba(52, 152, 219, 0.9)) drop-shadow(0 0 24px rgba(52, 152, 219, 0.6));
        }

        .shop-item.available:hover.rarity-rare .shop-item-icon {
            filter: drop-shadow(0 0 12px rgba(155, 89, 182, 0.9)) drop-shadow(0 0 24px rgba(155, 89, 182, 0.6));
        }

        .shop-item.available:hover.rarity-legendary .shop-item-icon {
            filter: drop-shadow(0 0 12px rgba(243, 156, 18, 1.0)) drop-shadow(0 0 24px rgba(243, 156, 18, 0.7)) drop-shadow(0 0 36px rgba(243, 156, 18, 0.4));
        }

        .shop-item.available:hover.rarity-mythical .shop-item-icon {
            filter: drop-shadow(0 0 12px rgba(233, 30, 99, 1.0)) drop-shadow(0 0 24px rgba(233, 30, 99, 0.7)) drop-shadow(0 0 36px rgba(233, 30, 99, 0.4));
        }

        .shop-item.available:hover.rarity-ultra_mythical .shop-item-icon {
            filter: drop-shadow(0 0 15px rgba(156, 39, 176, 1.0)) drop-shadow(0 0 30px rgba(156, 39, 176, 0.8)) drop-shadow(0 0 45px rgba(156, 39, 176, 0.5));
        }

        .shop-item.available:hover.rarity-godly .shop-item-icon {
            filter: 
                drop-shadow(0 0 15px rgba(255, 215, 0, 1.0)) 
                drop-shadow(0 0 30px rgba(255, 69, 0, 1.0)) 
                drop-shadow(0 0 45px rgba(255, 20, 147, 0.8))
                drop-shadow(0 0 60px rgba(138, 43, 226, 0.6));
        }

        .shop-item.unavailable .shop-item-icon {
            filter: drop-shadow(0 0 6px rgba(127, 140, 141, 0.4));
            opacity: 0.5;
        }

        .shop-item-price {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #4A4A4A;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 20px;
            border: 2px solid #8B4513;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        .shop-item-stock {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            text-shadow: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .shop-item-stock.low-stock {
            background: linear-gradient(135deg, #FF6B6B, #E74C3C);
            color: white;
            animation: lowStockPulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes lowStockPulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .shop-item-status {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 3px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .shop-item-status.too-expensive {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            color: white;
            border: 1px solid #A93226;
            animation: expensivePulse 2s ease-in-out infinite alternate;
        }

        .shop-item-status.out-of-stock {
            background: linear-gradient(135deg, #95A5A6, #7F8C8D);
            color: #2C3E50;
            border: 1px solid #5D6D7E;
            animation: stockPulse 1.8s ease-in-out infinite alternate;
        }

        @keyframes expensivePulse {
            0% { opacity: 0.8; box-shadow: 0 0 5px rgba(231, 76, 60, 0.3); }
            100% { opacity: 1; box-shadow: 0 0 10px rgba(231, 76, 60, 0.6); }
        }

        @keyframes stockPulse {
            0% { opacity: 0.7; }
            100% { opacity: 0.9; }
        }



        .shop-item.unavailable {
            opacity: 0.6;
            background: linear-gradient(135deg, #7F8C8D, #95A5A6);
            border-color: #BDC3C7;
            cursor: not-allowed;
        }

        .shop-item.unavailable:hover {
            transform: none;
            box-shadow: none;
            border-color: #BDC3C7;
        }

        /* Purchase Modal Styles */
        .purchase-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .purchase-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .purchase-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.7);
            background: linear-gradient(145deg, #2C3E50, #34495E);
            border: 3px solid #4CAF50;
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(76, 175, 80, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 400px;
            max-width: 500px;
        }

        .purchase-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .purchase-modal-content {
            padding: 0;
        }

        .purchase-header {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            padding: 20px;
            border-radius: 17px 17px 0 0;
            border-bottom: 2px solid #1B5E20;
        }

        .purchase-header h3 {
            margin: 0;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .purchase-body {
            padding: 25px;
        }

        .purchase-item-preview {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .purchase-item-icon {
            width: 60px;
            height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 10px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .purchase-item-details {
            flex-grow: 1;
        }

        .purchase-item-details h4 {
            margin: 0 0 5px 0;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 18px;
        }

        .purchase-item-rarity {
            margin: 0 0 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .purchase-item-rarity.common { color: #95A5A6; }
        .purchase-item-rarity.uncommon { color: #3498DB; }
        .purchase-item-rarity.rare { color: #9B59B6; }
        .purchase-item-rarity.legendary { color: #F39C12; }
        .purchase-item-rarity.mythical { color: #E91E63; }
        .purchase-item-rarity.ultra_mythical { color: #9C27B0; }
        .purchase-item-rarity.godly { 
            background: linear-gradient(90deg, #FFD700, #FF4500, #FF1493, #8A2BE2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        .purchase-item-stock {
            margin: 0;
            color: #BDC3C7;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .purchase-price-section {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .purchase-price {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .purchase-balance, .purchase-remaining {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: white;
            margin: 5px 0;
        }

        .purchase-remaining #purchaseRemainingAmount {
            color: #4CAF50;
            font-weight: bold;
        }

        .purchase-remaining #purchaseRemainingAmount.negative {
            color: #E74C3C;
        }

        .purchase-buttons {
            display: flex;
            gap: 15px;
            padding: 0 25px 25px;
        }

        .purchase-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .purchase-confirm {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: 2px solid #1B5E20;
        }

        .purchase-confirm:hover {
            background: linear-gradient(135deg, #5CBF60, #388E3C);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.3);
        }

        .purchase-cancel {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            color: white;
            border: 2px solid #A93226;
        }

        .purchase-cancel:hover {
            background: linear-gradient(135deg, #EC7063, #CD6155);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
        }

        .purchase-btn-icon {
            font-size: 18px;
        }

        /* Burn Modal Styles */
        .burn-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 9998;
        }

        .burn-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .burn-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.7);
            background: linear-gradient(145deg, #8B0000, #B22222);
            color: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 9999;
            min-width: 350px;
            max-width: 400px;
            border: 3px solid #FF6B6B;
        }

        .burn-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .burn-modal-content {
            padding: 0;
        }

        .burn-header {
            background: linear-gradient(135deg, #FF4444, #8B0000);
            padding: 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #FF6B6B;
        }

        .burn-header h3 {
            margin: 0;
            font-size: 1.3em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .burn-body {
            padding: 20px;
        }

        .burn-item-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .burn-item-icon {
            font-size: 3em;
            line-height: 1;
        }

        .burn-item-details h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: #FFE5E5;
        }

        .burn-warning {
            margin: 8px 0;
            color: #FFD700;
            font-weight: bold;
            font-size: 0.9em;
        }

        .burn-description {
            margin: 8px 0;
            color: #FFCCCC;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .burn-buttons {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 12px 12px;
        }

        .burn-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .burn-confirm {
            background: linear-gradient(135deg, #FF4444, #CC0000);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
        }

        .burn-confirm:hover {
            background: linear-gradient(135deg, #FF6666, #DD0000);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.6);
        }

        .burn-cancel {
            background: linear-gradient(135deg, #666, #444);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .burn-cancel:hover {
            background: linear-gradient(135deg, #777, #555);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .burn-btn:active {
            transform: translateY(2px);
        }

        /* Toast Notification Styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #34495E, #2C3E50);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            border: 2px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            z-index: 2000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }

        .toast-error {
            border-color: #E74C3C;
            background: linear-gradient(135deg, #E74C3C, #C0392B);
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast-message {
            flex-grow: 1;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- Shop Notification Banner -->
    <div class="shop-notification" id="shopNotification">
         Shop refreshing soon!
    </div>
    
    <!-- Tutorial Objective Display -->
    <div class="tutorial-objective" id="tutorialObjective">
        <div class="tutorial-objective-content">
            <div class="tutorial-objective-header">
                <span class="tutorial-objective-icon" id="tutorialObjectiveIcon"></span>
            <span class="tutorial-objective-text" id="tutorialObjectiveText">Click the inventory button to get started!</span>
            </div>
            <div class="tutorial-progress-container" id="tutorialProgressContainer" style="display: none;">
                <div class="tutorial-progress-bar">
                    <div class="tutorial-progress-fill" id="tutorialProgressFill"></div>
                </div>
                <div class="tutorial-progress-text" id="tutorialProgressText">0 / 25 beans collected</div>
            </div>
        </div>
    </div>
    
    <!-- Tutorial System -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-modal">
            <div class="tutorial-header">
                <h2 id="tutorialTitle"> Welcome to Grow a Beanstalk!</h2>
            </div>
            <div class="tutorial-content">
                <div class="tutorial-step" id="tutorialStep">
                    <div class="tutorial-icon"></div>
                    <p id="tutorialText">Let's learn how to grow your first beanstalk!</p>
                </div>
                <div class="tutorial-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="tutorialProgress"></div>
                    </div>
                    <span class="progress-text" id="tutorialProgressText">Step 1 of 5</span>
                </div>
            </div>
            <div class="tutorial-actions">
                <button class="tutorial-btn next-btn" id="tutorialNext" style="display: none;">Next Step</button>
            </div>
        </div>
    </div>
    
    <div class="start-screen" id="startScreen">
        <h1> Grow A Beanstock </h1>
        <button class="start-button" id="startButton">Start Growing!</button>
    </div>

    <div class="game-container" id="gameContainer">
        <div class="background"></div>
        
        <div class="clouds-container" id="cloudsContainer">
            <!-- Clouds will be dynamically added here -->
        </div>

        <div class="pots-container" id="potsContainer">
            <!-- 12 pots will be dynamically added here -->
        </div>

        <div class="grass-container"></div>

        <!-- UI Container -->
        <div class="ui-container" id="uiContainer">
            <div class="money-display">
                <span class="money-amount" id="moneyAmount">$1,234</span>
            </div>
            <button class="shop-button" id="shopButton">Shop</button>
            <button class="inventory-button" id="inventoryButton">Inventory</button>
        </div>

        <!-- Level 3 Tools (Unlocked at Level 3) -->
        <div class="level3-tools" id="level3Tools" style="display: none;">
            <!-- Bean Collection Button -->
            <button class="bean-collection-button" id="beanCollectionButton">
                <span></span>
                <span>Collection</span>
            </button>
            
            <!-- Fire Burn Tool -->
            <div class="fire-tool" id="fireTool">
                <div class="fire-emoji" id="fireEmoji"></div>
            </div>
        </div>

        <!-- Bean Collection Modal -->
        <div class="bean-collection-modal" id="beanCollectionModal">
            <div class="bean-collection-modal-content">
                <button class="bean-modal-close" id="beanModalClose"></button>
                <div class="bean-modal-header">
                    <span></span>
                    <span>Bean Collection</span>
                    <span id="beanCollectionCount">(0/20)</span>
                </div>
                <div class="bean-grid" id="beanGrid">
                    <!-- Bean slots will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Level Bar -->
        <div class="level-bar-container" id="levelBarContainer">
            <div class="level-info">
                <span class="level-label">Level <span id="currentLevel">1</span></span>
                <span class="xp-label"><span id="currentXP">0.0</span> / <span id="nextLevelXP">1,000</span> XP</span>
            </div>
            <div class="level-bar">
                <div class="level-bar-fill" id="levelBarFill"></div>
                <div class="level-bar-glow"></div>
            </div>
        </div>
        
        <!-- Inventory Panel -->
        <div class="inventory-panel" id="inventoryPanel">
            <div class="inventory-header">
                <h2> Inventory</h2>
                <button class="inventory-close" id="inventoryClose"></button>
            </div>
            <div class="inventory-content">
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- Inventory items will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Inventory Overlay -->
        <div class="inventory-overlay" id="inventoryOverlay"></div>
        
        <!-- Shop Panel -->
        <div class="shop-panel" id="shopPanel">
            <div class="shop-header">
                <h2> Seed Shop</h2>
                <button class="shop-close" id="shopClose"></button>
            </div>
            <div class="shop-content">
                <div class="shop-grid" id="shopGrid">
                    <!-- Shop items will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Shop Overlay -->
        <div class="shop-overlay" id="shopOverlay"></div>



        <!-- Purchase Confirmation Modal -->
        <div class="purchase-modal" id="purchaseModal">
            <div class="purchase-modal-content">
                <div class="purchase-header">
                    <h3> Confirm Purchase</h3>
                </div>
                <div class="purchase-body">
                    <div class="purchase-item-preview" id="purchaseItemPreview">
                        <div class="purchase-item-icon" id="purchaseItemIcon"></div>
                        <div class="purchase-item-details">
                            <h4 id="purchaseItemName">Item Name</h4>
                            <p class="purchase-item-rarity" id="purchaseItemRarity">Common</p>
                            <p class="purchase-item-stock" id="purchaseItemStock">Stock: 3</p>
                        </div>
                    </div>
                    <div class="purchase-price-section">
                        <div class="purchase-price" id="purchasePrice">$1,000</div>
                        <div class="purchase-balance">
                            <span>Your Balance: </span>
                            <span id="purchaseBalance">$5,000</span>
                        </div>
                        <div class="purchase-remaining" id="purchaseRemaining">
                            <span>After Purchase: </span>
                            <span id="purchaseRemainingAmount">$4,000</span>
                        </div>
                    </div>
                </div>
                <div class="purchase-buttons">
                    <button class="purchase-btn purchase-confirm" id="purchaseConfirm">
                        <span class="purchase-btn-icon"></span>
                        <span>Purchase</span>
                    </button>
                    <button class="purchase-btn purchase-cancel" id="purchaseCancel">
                        <span class="purchase-btn-icon"></span>
                        <span>Cancel</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="purchase-modal-overlay" id="purchaseModalOverlay"></div>

        <!-- Burn Confirmation Modal -->
        <div class="burn-modal" id="burnModal">
            <div class="burn-modal-content">
                <div class="burn-header">
                    <h3> Burn Plant</h3>
                </div>
                <div class="burn-body">
                    <div class="burn-item-preview" id="burnItemPreview">
                        <div class="burn-item-icon" id="burnItemIcon"></div>
                        <div class="burn-item-details">
                            <h4 id="burnItemName">Plant Name</h4>
                            <p class="burn-warning"> This action cannot be undone!</p>
                            <p class="burn-description">This will burn the plant, causing it to shrink back into the pot as a burnt remnant. You can still replant over it later.</p>
                        </div>
                    </div>
                </div>
                <div class="burn-buttons">
                    <button class="burn-btn burn-confirm" id="burnConfirm">
                        <span class="burn-btn-icon"></span>
                        <span>Burn Plant</span>
                    </button>
                    <button class="burn-btn burn-cancel" id="burnCancel">
                        <span class="burn-btn-icon"></span>
                        <span>Cancel</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="burn-modal-overlay" id="burnModalOverlay"></div>
    </div>

    <script>
        class GameManager {
            constructor() {
                this.isFullscreen = false;
                this.clouds = [];
                this.pots = [];
                this.gameState = null;
                this.currentMoney = 100; // Starting money - will be updated from API
                this.plantData = this.initializePlantData();
                this.modifierData = this.initializeModifierData();
                this.playerInventory = [
                    { id: 1, name: 'Beanstalk', type: 'seed', rarity: 'common', quantity: 1, image: 'Assets/PlantSeeds/Beanstalkseeds.png' }
                ];
                this.isInventoryOpen = false;
                this.isShopOpen = false;
                this.shopInventory = [];
                this.shopData = null; // Current shop data from API
                this.shopTimer = null; // Shop refresh timer interval
                this.notificationShown = { twoMinute: false, oneMinute: false }; // Track shown notifications
                this.isDragging = false;
                this.draggedItem = null;
                this.dragElement = null;
                this.hoveredPot = null;
                this.growingPlants = new Map(); // Track growing plants by pot index
                this.seedTooltip = null; // For seed tooltips
                this.pendingPurchase = null; // Track current purchase being considered
                this.pendingBurn = null; // Track current burn being considered
                this.moneySyncTimeout = null; // For debounced money syncing
                
                // Level System
                this.currentLevel = 1;
                this.currentXP = 0;
                this.baseXPRequirement = 1000; // XP needed for level 2
                this.fireUnlocked = false; // Fire burn tool unlocked at level 3
                
                // Tutorial System
                this.tutorialActive = false;
                this.tutorialStep = 0;
                this.tutorialData = {
                    beansCollected: 0,
                    seedsPurchased: 0,
                    plantsPlanted: 0,
                    inventoryOpened: false,
                    silverBeansCollected: 0,
                    goldBeansCollected: 0
                };

                // Bean Collection Index System
                this.beanCollection = new Set(); // Track unlocked beans
                this.beanCollectionUnlocked = false; // Bean collection unlocked at level 3
                this.allBeanTypes = [
                    { name: 'Beanstalk', image: 'Assets/BasicBeans/beanstalkbean.png' },
                    { name: 'Snap Pea', image: 'Assets/BasicBeans/Snappeabean.png' },
                    { name: 'Jellybean Vine', image: 'Assets/BasicBeans/Jellybean.png' },
                    { name: 'Bamboo-Bean', image: 'Assets/BasicBeans/Bamboobean.png' },
                    { name: 'Coffee Beanstalk', image: 'Assets/BasicBeans/Coffebean.png' },
                    { name: 'Corn Bean', image: 'Assets/BasicBeans/Cornbean.png' },
                    { name: 'Cloud Bean', image: 'Assets/BasicBeans/Cloudbean.png' },
                    { name: 'Crystal Bean', image: 'Assets/BasicBeans/Crystalbean.png' },
                    { name: 'Fire Pod', image: 'Assets/BasicBeans/Firebean.png' },
                    { name: 'Frost Pea', image: 'Assets/BasicBeans/Frostbean.png' },
                    { name: 'Choco Vine', image: 'Assets/BasicBeans/Chocobean.png' },
                    { name: 'Ironvine', image: 'Assets/BasicBeans/Ironbean.png' },
                    { name: 'Honeyvine', image: 'Assets/BasicBeans/Honeybean.png' },
                    { name: 'Sunbean', image: 'Assets/BasicBeans/Sunbean.png' },
                    { name: 'Moonbean', image: 'Assets/BasicBeans/Moombean.png' },
                    { name: 'Neon Soy', image: 'Assets/BasicBeans/Neonbean.png' },
                    { name: 'Prism Stalk', image: 'Assets/BasicBeans/Prysmbean.png' },
                    { name: 'Royal Stalk', image: 'Assets/BasicBeans/Royalbean.png' },
                    { name: 'Shadow Bean', image: 'Assets/BasicBeans/Shadowbean.png' },
                    { name: 'Thunder Pod', image: 'Assets/BasicBeans/Thunderboltpeabean.png' }
                ];
                
                // Audio system - always enabled
                this.volume = 0.7;
                this.sounds = {};
                this.backgroundMusic = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.createPots();
                this.startCloudAnimation();
                this.initializeGameState();
                
                // Initialize level system early
                setTimeout(() => {
                    this.initializeLevelBar();
                }, 500); // Give DOM time to load
            }

            // Initialize game state from API
            async initializeGameState() {
                try {
                    const response = await fetch('/api/game-state');
                    if (response.ok) {
                        const gameState = await response.json();
                        this.currentMoney = gameState.coins;
                        this.updateMoneyDisplay();
                        console.log('Game state initialized from API');
                    }
                } catch (error) {
                    console.log('Could not load game state from API, using defaults:', error);
                }
                
                // Start background shop refresh checking
                this.startBackgroundShopRefresh();
                
                // Initialize audio system
                this.initializeAudioSystem();
            }

            // Background shop refresh checking
            startBackgroundShopRefresh() {
                // Check for shop refreshes every 30 seconds
                setInterval(async () => {
                    try {
                        const response = await fetch('/api/shop');
                        if (response.ok) {
                            const newShopData = await response.json();
                            // If shop has refreshed and shop is currently open, update display
                            if (this.isShopOpen && this.shopData && 
                                newShopData.refresh_at !== this.shopData.refresh_at) {
                                this.shopData = newShopData;
                                this.populateShop();
                                this.showShopNotification(' Shop refreshed! Check out the new items!', 'refresh');
                                console.log('Shop refreshed automatically');
                            } else if (!this.shopData) {
                                this.shopData = newShopData;
                            }
                        }
                    } catch (error) {
                        console.log('Background shop refresh check failed:', error);
                    }
                }, 30000);
            }

            setupEventListeners() {
                const startButton = document.getElementById('startButton');
                startButton.addEventListener('click', () => {
                    // Start background music on user interaction (bypasses autoplay restrictions)
                    this.startBackgroundMusic();
                    this.startGame();
                });
                
                const shopButton = document.getElementById('shopButton');
                shopButton.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.onShopClick();
                });
                
                const inventoryButton = document.getElementById('inventoryButton');
                inventoryButton.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.onInventoryClick();
                });
                
                const inventoryClose = document.getElementById('inventoryClose');
                inventoryClose.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.closeInventory();
                });
                
                const inventoryOverlay = document.getElementById('inventoryOverlay');
                inventoryOverlay.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.closeInventory();
                });
                
                const shopClose = document.getElementById('shopClose');
                shopClose.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.closeShop();
                });
                
                const shopOverlay = document.getElementById('shopOverlay');
                shopOverlay.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.closeShop();
                });
                
                // Add global drag event listeners
                document.addEventListener('mousemove', (e) => this.onMouseMove(e));
                document.addEventListener('mouseup', (e) => this.onMouseUp(e));

                // Purchase modal event listeners
                const purchaseConfirm = document.getElementById('purchaseConfirm');
                purchaseConfirm.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.confirmPurchase();
                });
                
                const purchaseCancel = document.getElementById('purchaseCancel');
                purchaseCancel.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.cancelPurchase();
                });
                
                const purchaseModalOverlay = document.getElementById('purchaseModalOverlay');
                purchaseModalOverlay.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.cancelPurchase();
                });
                
                // Burn modal event listeners
                const burnConfirm = document.getElementById('burnConfirm');
                burnConfirm.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.confirmBurn();
                });
                
                const burnCancel = document.getElementById('burnCancel');
                burnCancel.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.cancelBurn();
                });
                
                const burnModalOverlay = document.getElementById('burnModalOverlay');
                burnModalOverlay.addEventListener('click', () => {
                    this.playSound('swoosh');
                    this.cancelBurn();
                });

            }

            async startGame() {
                try {
                    // Request fullscreen
                    await this.enterFullscreen();
                    
                    // Hide start screen and show game
                    document.getElementById('startScreen').classList.add('hidden');
                    document.getElementById('gameContainer').style.display = 'block';
                    
                    // Load initial game state
                    await this.loadGameState();
                    
                    // Start background music immediately after game starts
                    this.startBackgroundMusic();
                    
                    // Start tutorial for new players when they enter the game
                    this.startTutorial();
                    
                    // Initialize level bar
                    this.initializeLevelBar();
                    
                    // Initialize bean collection index
                    this.initializeBeanIndex();
                    
                } catch (error) {
                    console.warn('Fullscreen not supported or denied, continuing anyway');
                    // Still start the game even if fullscreen fails
                    document.getElementById('startScreen').classList.add('hidden');
                    document.getElementById('gameContainer').style.display = 'block';
                    
                    // Load initial game state
                    await this.loadGameState();
                    
                    // Start background music immediately after game starts
                    this.startBackgroundMusic();
                    
                    // Start tutorial for new players when they enter the game
                    this.startTutorial();
                    
                    // Initialize level bar
                    this.initializeLevelBar();
                    
                    // Initialize bean collection index
                    this.initializeBeanIndex();
                }
            }

            async enterFullscreen() {
                const element = document.documentElement;
                
                if (element.requestFullscreen) {
                    await element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    await element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    await element.msRequestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    await element.mozRequestFullScreen();
                }
                
                this.isFullscreen = true;
            }

            async loadGameState() {
                try {
                    const response = await fetch('/api/game-state');
                    this.gameState = await response.json();
                    
                    // Only sync money from server if our local money hasn't increased from bean collection
                    console.log(' DEBUG: Loading game state. Current money:', this.currentMoney, 'Server money:', this.gameState.coins);
                    if (this.currentMoney <= 100) { // Only sync if we're at starting amount or below
                        console.log(' DEBUG: Syncing money from server (no local earnings detected)');
                        this.currentMoney = this.gameState.coins;
                        this.updateMoneyDisplay();
                    } else {
                        console.log(' DEBUG: Keeping local money (bean earnings detected):', this.currentMoney);
                        // Send our earned money to the server
                        this.syncMoneyToServer();
                    }
                    
                    this.updatePotVisuals();
                    console.log(' Game state loaded:', this.gameState);
                } catch (error) {
                    console.error(' Failed to load game state:', error);
                }
            }

            createPots() {
                const potsContainer = document.getElementById('potsContainer');
                
                for (let i = 0; i < 12; i++) {
                    const pot = document.createElement('div');
                    pot.className = 'pot';
                    pot.dataset.potIndex = i;
                    // Pot clicking disabled - only hover for growth info
                    // pot.addEventListener('click', () => this.onPotClick(i));
                    
                    // Add hover listeners for growth progress display
                    pot.addEventListener('mouseenter', () => this.onPotHover(i));
                    pot.addEventListener('mouseleave', () => this.onPotHoverEnd(i));
                    
                    potsContainer.appendChild(pot);
                    this.pots.push({
                        element: pot,
                        index: i,
                        state: 'empty'
                    });
                }
            }

            updatePotVisuals() {
                if (!this.gameState || !this.gameState.pots) return;
                
                this.gameState.pots.forEach((potData, index) => {
                    const potElement = this.pots[index].element;
                    potElement.className = `pot ${potData.state}`;
                    
                    // Update pot data
                    this.pots[index].state = potData.state;
                    this.pots[index].data = potData;
                });
            }

            // Pot hover to show growth progress
            onPotHover(index) {
                const potData = this.pots[index];
                
                if (potData && potData.state === 'growing') {
                    // Show growth progress tooltip
                    const plantData = this.growingPlants.get(index);
                    if (plantData) {
                        const elapsed = Date.now() - plantData.startTime;
                        const progress = Math.min((elapsed / plantData.growthTime) * 100, 100);
                        this.showGrowthTooltip(index, plantData.seedName, progress);
                    }
                }
            }

            onPotHoverEnd(index) {
                // Hide any tooltips
                this.hideGrowthTooltip();
            }

            showGrowthTooltip(potIndex, seedName, progress) {
                // Remove any existing tooltip
                this.hideGrowthTooltip();
                
                const pot = this.pots[potIndex].element;
                const potRect = pot.getBoundingClientRect();
                
                const tooltip = document.createElement('div');
                tooltip.id = 'growth-tooltip';
                tooltip.className = 'growth-tooltip';
                tooltip.innerHTML = `
                    <div class="tooltip-header">${seedName}</div>
                    <div class="tooltip-progress">Growth: ${progress.toFixed(1)}%</div>
                    <div class="tooltip-bar">
                        <div class="tooltip-fill" style="width: ${progress}%"></div>
                    </div>
                `;
                
                // Position tooltip above the pot
                tooltip.style.position = 'fixed';
                tooltip.style.left = (potRect.left + potRect.width / 2) + 'px';
                tooltip.style.bottom = (window.innerHeight - potRect.top + 10) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.zIndex = '1000';
                
                document.body.appendChild(tooltip);
            }

            hideGrowthTooltip() {
                const existing = document.getElementById('growth-tooltip');
                if (existing) {
                    existing.remove();
                }
            }

            // Legacy pot click function (disabled but kept for reference)
            async onPotClick(index) {
                // Pot clicking disabled - functionality moved to other interactions
                console.log(`Pot clicking disabled for pot ${index}`);
            }

            startCloudAnimation() {
                // Create initial clouds
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => this.createCloud(), i * 2000);
                }
                
                // Create new clouds more frequently
                setInterval(() => {
                    if (Math.random() > 0.4) { // 60% chance every interval
                        this.createCloud();
                    }
                }, 2000); // Check every 2 seconds
                
                // Additional cloud bursts occasionally
                setInterval(() => {
                    if (Math.random() > 0.8) { // 20% chance for burst
                        for (let i = 0; i < 2; i++) {
                            setTimeout(() => this.createCloud(), i * 1000);
                        }
                    }
                }, 8000); // Check every 8 seconds
            }

            createCloud() {
                const cloudsContainer = document.getElementById('cloudsContainer');
                const cloud = document.createElement('div');
                
                // Randomly choose between cloud.png and cloud2.png
                const cloudAsset = Math.random() > 0.5 ? 'cloud.png' : 'cloud2.png';
                cloud.style.backgroundImage = `url('Assets/${cloudAsset}')`;
                cloud.style.backgroundSize = 'contain';
                cloud.style.backgroundRepeat = 'no-repeat';
                cloud.style.position = 'absolute';
                cloud.style.width = '200px';
                cloud.style.height = '100px';
                
                // Random direction (left to right or right to left)
                const direction = Math.random() > 0.5 ? 'right' : 'left';
                cloud.className = `cloud moving-${direction}`;
                
                // Random vertical position (anywhere on screen, avoiding bottom 250px for grass/pots)
                const topPosition = Math.random() * (window.innerHeight - 250);
                cloud.style.top = `${topPosition}px`;
                
                // Set up dynamic scaling variables
                const startScale = 0.5 + Math.random() * 0.8; // 0.5 to 1.3
                const midScale = startScale + (Math.random() * 0.6 - 0.3); // 0.3 variation
                const endScale = startScale + (Math.random() * 0.4 - 0.2); // 0.2 variation
                
                // Set up drift variables for vertical movement
                const drift1 = (Math.random() * 40 - 20) + 'px'; // 20px
                const drift2 = (Math.random() * 60 - 30) + 'px'; // 30px
                
                // Apply CSS variables
                cloud.style.setProperty('--start-scale', startScale);
                cloud.style.setProperty('--mid-scale', Math.max(0.3, midScale));
                cloud.style.setProperty('--end-scale', Math.max(0.3, endScale));
                cloud.style.setProperty('--drift-1', drift1);
                cloud.style.setProperty('--drift-2', drift2);
                
                // Random opacity variation
                const opacity = 0.3 + Math.random() * 0.5; // 0.3 to 0.8
                cloud.style.opacity = opacity;
                
                // Random animation duration (20-45 seconds)
                const duration = 20 + Math.random() * 25;
                cloud.style.animationDuration = `${duration}s`;
                
                cloudsContainer.appendChild(cloud);
                this.clouds.push(cloud);
                
                // Remove cloud after animation completes
                setTimeout(() => {
                    if (cloud.parentNode) {
                        cloud.parentNode.removeChild(cloud);
                        const index = this.clouds.indexOf(cloud);
                        if (index > -1) {
                            this.clouds.splice(index, 1);
                        }
                    }
                }, duration * 1000);
            }

            // Money Management Methods
            updateMoneyDisplay() {
                const moneyElement = document.getElementById('moneyAmount');
                if (moneyElement) {
                    // Add changing animation
                    moneyElement.classList.add('changing');
                    
                    // Format money with commas
                    const formattedMoney = '$' + this.currentMoney.toLocaleString();
                    moneyElement.textContent = formattedMoney;
                    
                    // Remove animation class after animation completes
                    setTimeout(() => {
                        moneyElement.classList.remove('changing');
                    }, 500);
                }
            }



            // Update money from game state (for later use)
            updateMoneyFromGameState() {
                if (this.gameState && this.gameState.coins !== undefined) {
                    this.currentMoney = this.gameState.coins;
                    this.updateMoneyDisplay();
                }
            }

            // Shop functionality
            onShopClick() {
                console.log('Shop button clicked!');
                this.toggleShop();
            }

            toggleShop() {
                if (this.isShopOpen) {
                    this.closeShop();
                } else {
                    this.openShop();
                }
            }

            async openShop() {
                this.isShopOpen = true;
                document.getElementById('shopPanel').classList.add('active');
                document.getElementById('shopOverlay').classList.add('active');
                await this.loadShopData();
                this.populateShop();
                this.startShopNotifications();
                
                // Hide tutorial objective when shop is open
                if (this.tutorialActive) {
                    document.getElementById('tutorialObjective').classList.remove('active');
                }
                
                console.log('Shop opened');
            }

            // API Functions
            async loadShopData() {
                try {
                    const response = await fetch('/api/shop');
                    if (response.ok) {
                        this.shopData = await response.json();
                        console.log('Shop data loaded:', this.shopData);
                    } else {
                        console.error('Failed to load shop data');
                        // Fallback to create local shop inventory if API fails
                        this.createShopInventory();
                    }
                } catch (error) {
                    console.error('Error loading shop data:', error);
                    this.createShopInventory();
                }
            }

            startShopNotifications() {
                if (this.shopTimer) {
                    clearInterval(this.shopTimer);
                }
                
                // Reset notification tracking
                this.notificationShown = {
                    twoMinute: false,
                    oneMinute: false
                };
                
                this.shopTimer = setInterval(() => {
                    this.checkShopNotifications();
                }, 1000);
                
                this.checkShopNotifications(); // Check immediately
            }

            checkShopNotifications() {
                if (!this.shopData || !this.shopData.refresh_at) {
                    return;
                }
                
                const now = Date.now() / 1000; // Current time in seconds
                const timeUntilRefresh = Math.max(0, this.shopData.refresh_at - now);
                
                if (timeUntilRefresh <= 0) {
                    // Shop has refreshed!
                    this.hideShopNotification();
                    this.showShopNotification(' Shop has been refreshed! New items available!', 'refresh');
                    this.loadShopData().then(() => {
                        if (this.isShopOpen) {
                            this.populateShop();
                        }
                    });
                    return;
                }
                
                // Show 2-minute warning
                if (timeUntilRefresh <= 120 && timeUntilRefresh > 60 && !this.notificationShown.twoMinute) {
                    this.showShopNotification(' Shop refreshing in 2 minutes!', 'warning-2min');
                    this.notificationShown.twoMinute = true;
                    console.log(' 2-minute shop notification shown');
                }
                
                // Show 1-minute warning
                if (timeUntilRefresh <= 60 && !this.notificationShown.oneMinute) {
                    this.showShopNotification(' Shop refreshing in 1 minute!', 'warning-1min');
                    this.notificationShown.oneMinute = true;
                    console.log(' 1-minute shop notification shown');
                }
            }
            
            showShopNotification(message, cssClass = '') {
                const notification = document.getElementById('shopNotification');
                if (notification) {
                    notification.textContent = message;
                    notification.className = 'shop-notification show ' + cssClass;
                    
                    // Play notification sound
                    this.playSound('notification');
                    
                    // Auto-hide after 6 seconds (slightly longer for better visibility)
                    setTimeout(() => {
                        this.hideShopNotification();
                    }, 6000);
                }
            }
            
            hideShopNotification() {
                const notification = document.getElementById('shopNotification');
                if (notification) {
                    notification.classList.remove('show');
                }
            }

            closeShop() {
                this.isShopOpen = false;
                document.getElementById('shopPanel').classList.remove('active');
                document.getElementById('shopOverlay').classList.remove('active');
                this.hideSeedTooltip(); // Hide tooltip when closing shop
                
                // Show tutorial objective when shop is closed (if tutorial is active)
                if (this.tutorialActive) {
                    document.getElementById('tutorialObjective').classList.add('active');
                }
                
                // Clear the shop timer when closing
                if (this.shopTimer) {
                    clearInterval(this.shopTimer);
                    this.shopTimer = null;
                }
                
                console.log('Shop closed');
            }

            populateShop() {
                const shopGrid = document.getElementById('shopGrid');
                shopGrid.innerHTML = '';

                console.log('Populating shop with shopData:', this.shopData);

                if (this.shopData && this.shopData.slots) {
                    // Use API data to populate shop
                    console.log('Using API data, slots:', this.shopData.slots);
                    this.shopData.slots.forEach((slot, index) => {
                        console.log(`Creating shop item for slot ${index}:`, slot);
                        const itemElement = this.createShopItemElement(slot, index);
                        shopGrid.appendChild(itemElement);
                    });
                } else {
                    console.log('Using fallback shop inventory');
                    // Fallback to hardcoded inventory if no API data
                    if (this.shopInventory.length === 0) {
                        this.createShopInventory();
                    }
                    this.shopInventory.forEach(item => {
                        const itemElement = this.createShopItemElement(item);
                        shopGrid.appendChild(itemElement);
                    });
                }
            }

            createShopInventory() {
                // Create one of each seed type for the shop
                this.shopInventory = [
                    { id: 1, name: 'Beanstalk', type: 'seed', rarity: 'common', price: 50, image: 'Assets/PlantSeeds/Beanstalkseeds.png', available: true },
                    { id: 2, name: 'Snap Pea', type: 'seed', rarity: 'common', price: 90, image: 'Assets/PlantSeeds/SnappeaSeeds.png', available: true },
                    { id: 3, name: 'Bamboo Bean', type: 'seed', rarity: 'common', price: 300, image: 'Assets/PlantSeeds/Bamboobeanseeds.png', available: true },
                    { id: 4, name: 'Jellybean Vine', type: 'seed', rarity: 'common', price: 170, image: 'Assets/PlantSeeds/jellybeanvineseeds.png', available: true },
                    { id: 5, name: 'Coffee Creeper', type: 'seed', rarity: 'common', price: 540, image: 'Assets/PlantSeeds/coffeebeanstalkseeds.png', available: true },
                    { id: 6, name: 'Frost Pea', type: 'seed', rarity: 'common', price: 1700, image: 'Assets/PlantSeeds/frostpeaseeds.png', available: true },
                    { id: 7, name: 'Thunder Pod', type: 'seed', rarity: 'uncommon', price: 970, image: 'Assets/PlantSeeds/thunderpodseeds.png', available: true },
                    { id: 8, name: 'Choco Vine', type: 'seed', rarity: 'uncommon', price: 3000, image: 'Assets/PlantSeeds/Chocovineseeds.png', available: true },
                    { id: 9, name: 'Ironvine', type: 'seed', rarity: 'uncommon', price: 5300, image: 'Assets/PlantSeeds/Ironvineseeds.png', available: true },
                    { id: 10, name: 'Honeyvine', type: 'seed', rarity: 'uncommon', price: 9300, image: 'Assets/PlantSeeds/Honeyvineseeds.png', available: true },
                    { id: 11, name: 'Sunbean', type: 'seed', rarity: 'uncommon', price: 16000, image: 'Assets/PlantSeeds/Sunbeanseeds.png', available: true },
                    { id: 12, name: 'Moonbean', type: 'seed', rarity: 'uncommon', price: 28000, image: 'Assets/PlantSeeds/Moonbeanseeds.png', available: true },
                    { id: 13, name: 'Cloud Creeper', type: 'seed', rarity: 'uncommon', price: 49000, image: 'Assets/PlantSeeds/Cloudcreeperseeds.png', available: true },
                    { id: 14, name: 'Royal Stalk', type: 'seed', rarity: 'uncommon', price: 86000, image: 'Assets/PlantSeeds/Royalstalkseeds.png', available: true },
                    { id: 15, name: 'Crystal Bean', type: 'seed', rarity: 'rare', price: 150000, image: 'Assets/PlantSeeds/CrystalBeanseeds.png', available: true },
                    { id: 16, name: 'Neon Soy', type: 'seed', rarity: 'rare', price: 260000, image: 'Assets/PlantSeeds/Neonsoyseeds.png', available: true },
                    { id: 17, name: 'Vinecorn', type: 'seed', rarity: 'rare', price: 450000, image: 'Assets/PlantSeeds/Vinecornseeds.png', available: true },
                    { id: 18, name: 'Fire Pod', type: 'seed', rarity: 'rare', price: 780000, image: 'Assets/PlantSeeds/Firepodseeds.png', available: true },
                    { id: 19, name: 'Shadow Bean', type: 'seed', rarity: 'rare', price: 1350000, image: 'Assets/PlantSeeds/Shadowbeanseeds.png', available: true },
                    { id: 20, name: 'Prism Stalk', type: 'seed', rarity: 'legendary', price: 2340000, image: 'Assets/PlantSeeds/Prismstalkseeds.png', available: true },
                ];
            }

            createShopItemElement(item, slotIndex = null) {
                const itemDiv = document.createElement('div');
                
                console.log('Creating shop item element for:', item, 'slotIndex:', slotIndex);
                
                // Handle both API format (slot) and legacy format (item)
                const isApiFormat = item.species_id !== undefined;
                const name = isApiFormat ? item.species_name : item.name;
                const price = isApiFormat ? item.price : item.price;
                const rarity = isApiFormat ? item.rarity : item.rarity;
                const stock = isApiFormat ? item.stock : null;
                const available = isApiFormat ? (item.stock > 0) : item.available;
                const image = isApiFormat ? this.getSeedImageForSpecies(item.species_id) : item.image;
                
                console.log(`Item details - name: ${name}, price: ${price}, stock: ${stock}, available: ${available}`);
                
                const canAfford = this.currentMoney >= price;
                // Items are "available" if they have stock, regardless of whether player can afford them
                // We'll show price/affordability separately 
                const availabilityClass = available ? 'available' : 'unavailable';
                
                itemDiv.className = `shop-item ${availabilityClass} rarity-${rarity}`;
                itemDiv.onclick = () => this.onShopItemClick(isApiFormat ? { ...item, slotIndex } : item);

                // Always show price
                const priceContent = `<div class="shop-item-price">$${price.toLocaleString()}</div>`;
                
                // Show availability status if there's an issue
                let statusContent = '';
                if (!available) {
                    statusContent = `<div class="shop-item-status out-of-stock">OUT OF STOCK!</div>`;
                } else if (!canAfford) {
                    statusContent = `<div class="shop-item-status too-expensive">NEED $${(price - this.currentMoney).toLocaleString()} MORE</div>`;
                }

                // Stock display for API format - lowered threshold for low stock warning
                const stockContent = isApiFormat ? 
                    `<div class="shop-item-stock ${stock <= 1 ? 'low-stock' : ''}">Stock: ${stock}</div>` : '';

                itemDiv.innerHTML = `
                    <div class="shop-item-icon" style="background-image: url('${image}')"></div>
                    <h3 style="color: white; font-size: 14px; margin: 5px 0; text-align: center;">${name}</h3>
                    ${priceContent}
                    ${statusContent}
                    ${stockContent}
                `;

                return itemDiv;
            }

            // Map species IDs to seed images
            getSeedImageForSpecies(speciesId) {
                const seedImageMap = {
                    'beanstalk': 'Assets/PlantSeeds/Beanstalkseeds.png',
                    'snap_pea': 'Assets/PlantSeeds/SnappeaSeeds.png',
                    'jellybean_vine': 'Assets/PlantSeeds/jellybeanvineseeds.png',
                    'bamboo_bean': 'Assets/PlantSeeds/Bamboobeanseeds.png',
                    'coffee_beanstalk': 'Assets/PlantSeeds/coffeebeanstalkseeds.png',
                    'thunder_pod': 'Assets/PlantSeeds/thunderpodseeds.png',
                    'frost_pea': 'Assets/PlantSeeds/frostpeaseeds.png',
                    'choco_vine': 'Assets/PlantSeeds/Chocovineseeds.png',
                    'ironvine': 'Assets/PlantSeeds/Ironvineseeds.png',
                    'honeyvine': 'Assets/PlantSeeds/Honeyvineseeds.png',
                    'sunbean': 'Assets/PlantSeeds/Sunbeanseeds.png',
                    'moonbean': 'Assets/PlantSeeds/Moonbeanseeds.png',
                    'cloud_creeper': 'Assets/PlantSeeds/Cloudcreeperseeds.png',
                    'royal_stalk': 'Assets/PlantSeeds/Royalstalkseeds.png',
                    'crystal_bean': 'Assets/PlantSeeds/CrystalBeanseeds.png',
                    'neon_soy': 'Assets/PlantSeeds/Neonsoyseeds.png',
                    'vinecorn': 'Assets/PlantSeeds/Vinecornseeds.png',
                    'fire_pod': 'Assets/PlantSeeds/Firepodseeds.png',
                    'shadow_bean': 'Assets/PlantSeeds/Shadowbeanseeds.png',
                    'prism_stalk': 'Assets/PlantSeeds/Prismstalkseeds.png'
                };
                return seedImageMap[speciesId] || 'Assets/PlantSeeds/Beanstalkseeds.png'; // Fallback
            }

            onShopItemClick(item) {
                console.log(' DEBUG: Shop item clicked:', item);
                console.log(' DEBUG: Current money:', this.currentMoney);
                console.log(' DEBUG: Item price:', item.price);
                console.log(' DEBUG: Can afford?', this.currentMoney >= item.price);
                
                // Handle both API format (has slotIndex) and legacy format
                const isApiFormat = item.slotIndex !== undefined;
                const name = isApiFormat ? item.species_name : item.name;
                const price = item.price;
                const available = isApiFormat ? (item.stock > 0) : item.available;
                
                // Always show purchase modal - players can attempt to buy anything with stock
                // Backend will handle validation (coins, etc.)
                this.showPurchaseModal(item);
            }

            showPurchaseModal(item) {
                // Handle both API format and legacy format
                const isApiFormat = item.slotIndex !== undefined;
                const name = isApiFormat ? item.species_name : item.name;
                const price = item.price;
                const rarity = isApiFormat ? item.rarity : item.rarity;
                const stock = isApiFormat ? item.stock : null;
                const image = isApiFormat ? this.getSeedImageForSpecies(item.species_id) : item.image;
                const available = isApiFormat ? (item.stock > 0) : item.available;
                
                // Store the pending purchase
                this.pendingPurchase = {
                    item,
                    isApiFormat,
                    name,
                    price,
                    available,
                    canAfford: this.currentMoney >= price
                };
                
                // Populate modal content
                document.getElementById('purchaseItemIcon').style.backgroundImage = `url('${image}')`;
                document.getElementById('purchaseItemName').textContent = name;
                
                const rarityElement = document.getElementById('purchaseItemRarity');
                rarityElement.textContent = rarity.charAt(0).toUpperCase() + rarity.slice(1).replace('_', '-');
                rarityElement.className = `purchase-item-rarity ${rarity}`;
                
                document.getElementById('purchaseItemStock').textContent = stock ? `Stock: ${stock}` : '';
                document.getElementById('purchasePrice').textContent = `$${price.toLocaleString()}`;
                document.getElementById('purchaseBalance').textContent = `$${this.currentMoney.toLocaleString()}`;
                
                const remainingAmount = this.currentMoney - price;
                const remainingElement = document.getElementById('purchaseRemainingAmount');
                remainingElement.textContent = `$${remainingAmount.toLocaleString()}`;
                remainingElement.className = remainingAmount < 0 ? 'negative' : '';
                
                // Update confirm button based on affordability and availability
                const confirmButton = document.getElementById('purchaseConfirm');
                if (!available) {
                    confirmButton.innerHTML = '<span class="purchase-btn-icon"></span><span>Out of Stock</span>';
                    confirmButton.disabled = true;
                    confirmButton.style.opacity = '0.5';
                } else {
                    // Always allow clicking the button - we'll check affordability at confirmation time
                    confirmButton.innerHTML = '<span class="purchase-btn-icon"></span><span>Purchase</span>';
                    confirmButton.disabled = false;
                    confirmButton.style.opacity = '1';
                }
                
                // Show modal
                document.getElementById('purchaseModal').classList.add('active');
                document.getElementById('purchaseModalOverlay').classList.add('active');
            }

            cancelPurchase() {
                // Hide modal
                document.getElementById('purchaseModal').classList.remove('active');
                document.getElementById('purchaseModalOverlay').classList.remove('active');
                
                // Clear pending purchase
                this.pendingPurchase = null;
            }

            async confirmPurchase() {
                if (!this.pendingPurchase) {
                    console.log(' DEBUG: No pending purchase');
                    return;
                }
                
                // Re-check affordability and availability at purchase time (not modal open time)
                const canAffordNow = this.currentMoney >= this.pendingPurchase.price;
                const isAvailable = this.pendingPurchase.available;
                
                console.log(' DEBUG: Confirming purchase:');
                console.log('   - Item:', this.pendingPurchase.name);
                console.log('   - Price:', this.pendingPurchase.price);
                console.log('   - Current Money:', this.currentMoney);
                console.log('   - Can Afford Now:', canAffordNow);
                console.log('   - Is Available:', isAvailable);
                
                if (!isAvailable) {
                    this.showErrorMessage(' This item is out of stock!');
                    return;
                }
                
                if (!canAffordNow) {
                    this.showErrorMessage(` Not enough coins! You need ${this.pendingPurchase.price} but only have ${this.currentMoney}.`);
                    return;
                }
                
                // Play purchase sound effect
                this.playSound('purchase');
                
                // Process the purchase
                if (this.pendingPurchase.isApiFormat) {
                    await this.purchaseItemFromAPI(this.pendingPurchase.item);
                } else {
                    this.purchaseItem(this.pendingPurchase.item);
                }
                
                // Hide modal after purchase
                this.cancelPurchase();
            }

            purchaseItem(item) {
                // Deduct money
                this.currentMoney -= item.price;
                this.updateMoneyDisplay();
                
                // Add to player inventory
                const existingItem = this.playerInventory.find(invItem => invItem.name === item.name);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    this.playerInventory.push({
                        id: Date.now(), // Simple ID generation
                        name: item.name,
                        type: item.type,
                        rarity: item.rarity,
                        quantity: 1,
                        image: item.image
                    });
                }
                
                // Update shop display to reflect affordability changes
                this.populateShop();
                
                // Update inventory display if it's open
                if (this.isInventoryOpen) {
                    this.populateInventory();
                }
                
                console.log(`Purchased ${item.name} for $${item.price}`);
                
                // Tutorial tracking
                this.onTutorialSeedPurchased();
                
                this.showSuccessMessage(`Successfully purchased ${item.name}! Check your inventory.`);
            }

            async purchaseItemFromAPI(item) {
                console.log(' DEBUG: Starting API purchase for:', item);
                console.log(' DEBUG: Sending request with slot_index:', item.slotIndex);
                
                try {
                    const response = await fetch('/api/buy-seed', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            slot_index: item.slotIndex,
                            pot_index: -1 // -1 means add to inventory instead of planting directly
                        })
                    });

                    console.log(' DEBUG: HTTP Response status:', response.status);
                    console.log(' DEBUG: HTTP Response ok:', response.ok);
                    
                    const result = await response.json();
                    
                    console.log(' DEBUG: API Response:', result);
                    console.log(' DEBUG: Response success:', result.success);
                    console.log(' DEBUG: Response success type:', typeof result.success);
                    console.log(' DEBUG: Response coins:', result.coins);
                    console.log(' DEBUG: Full response keys:', Object.keys(result));
                    
                    if (result.success) {
                        console.log(`Successfully purchased ${item.species_name}!`);
                        console.log('Purchase result:', result);
                        
                        // Update local money from server response
                        this.currentMoney = result.coins;
                        this.updateMoneyDisplay();
                        
                        // Add to inventory
                        const existingItem = this.playerInventory.find(invItem => invItem.name === item.species_name);
                        if (existingItem) {
                            existingItem.quantity += 1;
                            console.log(`Updated existing item: ${item.species_name}, new quantity: ${existingItem.quantity}`);
                        } else {
                            const newItem = {
                                id: Date.now(),
                                name: item.species_name,
                                type: 'seed',
                                rarity: item.rarity,
                                quantity: 1,
                                image: this.getSeedImageForSpecies(item.species_id)
                            };
                            this.playerInventory.push(newItem);
                            console.log(`Added new item to inventory:`, newItem);
                        }
                        
                        // Use the shop data returned from the purchase instead of making another API call
                        if (result.shop) {
                            this.shopData = result.shop;
                            console.log('Updated shop data from purchase response:', this.shopData);
                        }
                        this.populateShop();
                        
                        // Update inventory display if it's open
                        if (this.isInventoryOpen) {
                            this.populateInventory();
                        }
                        
                        console.log('Current inventory after purchase:', this.playerInventory);
                        
                        // Tutorial tracking
                        this.onTutorialSeedPurchased();
                        
                        this.showSuccessMessage(`Successfully purchased ${item.species_name}! Check your inventory.`);
                    } else {
                        console.log(' DEBUG: Purchase failed - result.success is:', result.success);
                        console.log(' DEBUG: Full failed response:', result);
                        
                        // Update money display with server response
                        if (result.coins !== undefined) {
                            this.currentMoney = result.coins;
                            this.updateMoneyDisplay();
                        }
                        
                        // Check if it's an insufficient funds error
                        const currentCoins = result.coins || this.currentMoney;
                        if (currentCoins < item.price) {
                            this.showErrorMessage(` Not enough coins! You need ${item.price} but only have ${currentCoins}.`);
                        } else if (item.stock <= 0) {
                            this.showErrorMessage(' This item is out of stock!');
                        } else {
                            this.showErrorMessage(' Purchase failed. Please try again.');
                        }
                    }
                } catch (error) {
                    console.error('Error purchasing item:', error);
                    this.showErrorMessage(' Network error. Please check your connection and try again.');
                }
            }

            // Notification system
            showSuccessMessage(message) {
                console.log('SUCCESS:', message);
                this.showToast(message, 'success');
            }

            showErrorMessage(message) {
                console.error('ERROR:', message);
                this.showToast(message, 'error');
            }

            showToast(message, type = 'info') {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">${type === 'success' ? '' : type === 'error' ? '' : ''}</div>
                    <div class="toast-message">${message}</div>
                `;

                // Add to page
                document.body.appendChild(toast);

                // Animate in
                setTimeout(() => toast.classList.add('show'), 100);

                // Remove after delay
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Inventory functionality
            onInventoryClick() {
                console.log('Inventory button clicked!');
                this.toggleInventory();
            }

            toggleInventory() {
                if (this.isInventoryOpen) {
                    this.closeInventory();
                } else {
                    this.openInventory();
                }
            }

            openInventory() {
                this.isInventoryOpen = true;
                document.getElementById('inventoryPanel').classList.add('active');
                document.getElementById('inventoryOverlay').classList.add('active');
                this.populateInventory();
                
                // Tutorial tracking
                this.onTutorialInventoryOpened();
                
                console.log('Inventory opened');
            }

            closeInventory() {
                this.isInventoryOpen = false;
                document.getElementById('inventoryPanel').classList.remove('active');
                document.getElementById('inventoryOverlay').classList.remove('active');
                this.hideSeedTooltip(); // Hide tooltip when closing inventory
                console.log('Inventory closed');
            }

            populateInventory() {
                const inventoryGrid = document.getElementById('inventoryGrid');
                inventoryGrid.innerHTML = '';

                // No longer using dummy data - player starts with one beanstalk seed

                console.log('Populating inventory with playerInventory:', this.playerInventory);

                // Populate the grid with inventory items
                if (this.playerInventory.length === 0) {
                    console.log('Inventory is empty, showing empty message');
                    // Show empty inventory message
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'inventory-empty';
                    emptyMessage.innerHTML = `
                        <div class="inventory-empty-icon"></div>
                        <p>Your inventory is empty!</p>
                        <p>Buy some seeds from the shop to get started.</p>
                    `;
                    inventoryGrid.appendChild(emptyMessage);
                } else {
                    console.log(`Showing ${this.playerInventory.length} inventory items`);
                    // Show inventory items
                    this.playerInventory.forEach((item, index) => {
                        console.log(`Creating inventory item ${index}:`, item);
                        const itemElement = this.createInventoryItemElement(item);
                        inventoryGrid.appendChild(itemElement);
                    });
                }
            }



            createInventoryItemElement(item) {
                const itemDiv = document.createElement('div');
                itemDiv.className = `inventory-item ${item.type} rarity-${item.rarity}`;
                
                // Add drag functionality
                itemDiv.addEventListener('mousedown', (e) => {
                    console.log(' DEBUG: mousedown on inventory item:', item.name);
                    this.startDragging(e, item, itemDiv);
                });
                itemDiv.onclick = (e) => {
                    // Only trigger click if not dragging
                    if (!this.isDragging) {
                        this.onInventoryItemClick(item);
                    }
                };

                // Add tooltip functionality
                itemDiv.addEventListener('mouseenter', (e) => {
                    if (!this.isDragging) {
                        const rect = itemDiv.getBoundingClientRect();
                        this.showSeedTooltip(item, rect.right + 10, rect.top + rect.height / 2);
                    }
                });

                itemDiv.addEventListener('mouseleave', () => {
                    this.hideSeedTooltip();
                });

                // Use image if available, fallback to icon
                const iconContent = item.image 
                    ? `<div class="inventory-item-icon" style="background-image: url('${item.image}')"></div>`
                    : `<div class="inventory-item-icon">${item.icon || ''}</div>`;

                itemDiv.innerHTML = `
                    ${iconContent}
                    <div class="inventory-item-quantity"> ${item.quantity}</div>
                `;

                return itemDiv;
            }

            onInventoryItemClick(item) {
                console.log('Inventory item clicked:', item);
                // TODO: Implement item interaction (planting, selling, etc.)
                // Note: Click handling is primarily for drag-and-drop functionality
                // No alert needed - just log for debugging
            }

            // Drag and Drop Methods
            startDragging(e, item, sourceElement) {
                e.preventDefault();
                
                console.log(' DEBUG: startDragging called');
                console.log(' DEBUG: Item:', item);
                console.log(' DEBUG: Mouse position:', e.clientX, e.clientY);
                
                this.isDragging = true;
                this.draggedItem = { ...item }; // Clone the item
                
                // Hide tooltip immediately when dragging starts
                this.hideSeedTooltip();
                
                // Add dragging class to source element
                sourceElement.classList.add('dragging');
                
                // Create drag visual
                this.createDragElement(item);
                
                // Close inventory
                this.closeInventory();
                
                // Don't update inventory yet - only update on successful drop
                
                console.log(` DEBUG: Started dragging: ${item.name}, isDragging: ${this.isDragging}`);
            }

            createDragElement(item) {
                console.log(' DEBUG: createDragElement called');
                this.dragElement = document.createElement('div');
                this.dragElement.className = `dragging-seed rarity-${item.rarity}`;
                this.dragElement.style.backgroundImage = `url('${item.image}')`;
                this.dragElement.style.pointerEvents = 'none';
                
                document.body.appendChild(this.dragElement);
                console.log(' DEBUG: Drag element created and added to body');
                console.log(' DEBUG: Element classes:', this.dragElement.className);
            }

            onMouseMove(e) {
                if (!this.isDragging || !this.dragElement) return;
                
                // Update drag element position
                this.dragElement.style.left = e.clientX + 'px';
                this.dragElement.style.top = e.clientY + 'px';
                
                // Check if we're over a pot for visual feedback
                this.checkPotHover(e);
            }

            checkPotHover(e) {
                // Get element under cursor (drag element already has pointer-events: none)
                const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                
                // Check if we're over a pot
                const potElement = elementBelow?.closest('.pot');
                
                if (potElement) {
                    const potIndex = parseInt(potElement.dataset.potIndex);
                    const potData = this.pots[potIndex];
                    
                    // Check if pot is empty or burnt - just highlight, no pouring yet
                    if (potData && (potData.state === 'empty' || potData.state === 'burnt')) {
                        if (this.hoveredPot !== potIndex) {
                            this.hoveredPot = potIndex;
                            potElement.classList.add('drag-hover');
                        }
                    } else {
                        // Over a non-empty pot - remove effects
                        this.clearPotHover();
                    }
                } else {
                    // Not over any pot - remove effects
                    this.clearPotHover();
                }
            }

            clearPotHover() {
                if (this.hoveredPot !== null) {
                    // Remove hover effect from pot
                    const potElement = document.querySelector(`[data-pot-index="${this.hoveredPot}"]`);
                    if (potElement) {
                        potElement.classList.remove('drag-hover');
                    }
                    
                    this.hoveredPot = null;
                }
            }

            onMouseUp(e) {
                console.log(' DEBUG: onMouseUp called');
                console.log(' DEBUG: isDragging:', this.isDragging);
                console.log(' DEBUG: draggedItem:', this.draggedItem?.name);
                console.log(' DEBUG: Mouse position:', e.clientX, e.clientY);
                
                if (!this.isDragging) {
                    console.log(' DEBUG: Not dragging, returning early');
                    return;
                }
                
                console.log(` DEBUG: Dropped seed: ${this.draggedItem.name} at position ${e.clientX}, ${e.clientY}`);
                
                // Check if we're dropping over an empty pot
                const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                console.log(' DEBUG: Element below on drop:', elementBelow?.tagName, elementBelow?.className);
                
                const potElement = elementBelow?.closest('.pot');
                console.log(' DEBUG: Found pot element:', !!potElement, potElement?.dataset?.potIndex);
                
                if (potElement) {
                    const potIndex = parseInt(potElement.dataset.potIndex);
                    const potData = this.pots[potIndex];
                    
                    console.log(' DEBUG: Pot index:', potIndex, 'Pot data:', potData);
                    
                    // Check if pot is empty or burnt
                    if (potData && (potData.state === 'empty' || potData.state === 'burnt')) {
                        console.log(' DEBUG: Valid drop! Planting', this.draggedItem.name, 'in pot', potIndex);
                        this.plantSeedInPot(potIndex);
                        return; // plantSeedInPot will handle ending the drag
                    } else {
                        console.log(' DEBUG: Pot not empty, state:', potData?.state);
                    }
                } else {
                    console.log(' DEBUG: No pot element found');
                }
                
                // If we get here, it's not a valid drop - just end dragging
                console.log(' DEBUG: Invalid drop location, ending drag');
                this.endDragging();
            }

            endDragging() {
                this.isDragging = false;
                
                // Clear pot hover effects
                this.clearPotHover();
                
                // Remove drag element
                if (this.dragElement) {
                    // Make sure to remove any pouring class before removing element
                    this.dragElement.classList.remove('pouring');
                    this.dragElement.remove();
                    this.dragElement = null;
                }
                
                // Clear dragging state
                this.draggedItem = null;
                
                // Remove dragging class from any elements
                document.querySelectorAll('.inventory-item.dragging').forEach(el => {
                    el.classList.remove('dragging');
                });
                
                // Remove any lingering drag-hover classes from pots
                document.querySelectorAll('.pot.drag-hover').forEach(el => {
                    el.classList.remove('drag-hover');
                });
                
                console.log('Drag ended');
            }

            updateInventoryForDrag(item) {
                const inventoryItem = this.playerInventory.find(invItem => invItem.id === item.id);
                
                if (!inventoryItem) return;
                
                if (inventoryItem.quantity > 1) {
                    // Decrease quantity by 1
                    inventoryItem.quantity -= 1;
                } else {
                    // Remove item completely
                    const index = this.playerInventory.indexOf(inventoryItem);
                    this.playerInventory.splice(index, 1);
                }
                
                console.log(`Updated inventory: ${item.name} - Remaining quantity: ${inventoryItem ? inventoryItem.quantity : 0}`);
            }

            plantSeedInPot(potIndex) {
                console.log(' DEBUG: plantSeedInPot called with potIndex:', potIndex);
                console.log(' DEBUG: dragElement exists:', !!this.dragElement);
                console.log(' DEBUG: draggedItem:', this.draggedItem?.name);
                
                // Clear pot hover effects first
                this.clearPotHover();
                
                // Add pouring animation to the seed
                if (this.dragElement) {
                    console.log(' DEBUG: Adding pouring class to dragElement');
                    console.log(' DEBUG: dragElement classes before:', this.dragElement.className);
                    this.dragElement.classList.add('pouring');
                    console.log(' DEBUG: dragElement classes after:', this.dragElement.className);
                } else {
                    console.log(' DEBUG: No dragElement found!');
                }
                
                // Get the pot element for visual feedback
                const potElement = document.querySelector(`[data-pot-index="${potIndex}"]`);
                console.log(' DEBUG: Found potElement:', !!potElement);
                if (potElement) {
                    potElement.classList.add('drag-hover');
                }
                
                console.log(' DEBUG: Starting 300ms timeout for planting animation');
                
                // Wait for the pouring animation, then plant the seed
                setTimeout(() => {
                    console.log(' DEBUG: Timeout completed, starting vine growth');
                    
                    // Play plant sound when seeds are poured into pot
                    this.playSound('plant');
                    
                    try {
                        // Start growing the vine
                        const success = this.startVineGrowth(potIndex, this.draggedItem.name);
                        
                        if (success) {
                            console.log(` DEBUG: Successfully planted ${this.draggedItem.name} in pot ${potIndex}`);
                            
                            // Tutorial tracking
                            this.onTutorialPlantPlanted();
                            
                            // Now that the plant is successful, update the inventory to remove the seed
                            this.updateInventoryForDrag(this.draggedItem);
                        } else {
                            console.log(` DEBUG: Failed to plant ${this.draggedItem.name} in pot ${potIndex}`);
                            // Don't remove from inventory if planting failed
                        }
                    } catch (error) {
                        console.error(' DEBUG: Error during planting:', error);
                        // Don't remove from inventory if there was an error
                    }
                    
                    // Always end the dragging operation (cleanup visual state)
                    this.endDragging();
                    
                }, 300); // Wait 300ms for the pouring animation
            }

            startVineGrowth(potIndex, seedName) {
                console.log(' DEBUG: startVineGrowth called for', seedName, 'in pot', potIndex);
                
                // Validate pot index and state
                if (!this.pots[potIndex]) {
                    console.error(' DEBUG: Invalid pot index:', potIndex);
                    return false;
                }
                
                if (this.pots[potIndex].state !== 'empty' && this.pots[potIndex].state !== 'burnt') {
                    console.error(' DEBUG: Pot is not available for planting, state:', this.pots[potIndex].state);
                    return false;
                }
                
                // If pot has burnt remnant, clear it before planting new seed
                if (this.pots[potIndex].state === 'burnt') {
                    console.log(' Clearing burnt remnant from pot', potIndex);
                    
                    // Remove burnt vine element if it exists
                    const existingPlantData = this.growingPlants.get(potIndex);
                    if (existingPlantData && existingPlantData.vineElement) {
                        existingPlantData.vineElement.remove();
                        console.log(' Removed burnt vine element');
                    }
                    
                    // Clear plant data and pot state
                    this.growingPlants.delete(potIndex);
                    const pot = document.querySelector(`.pot[data-pot-index="${potIndex}"]`);
                    if (pot) {
                        pot.classList.remove('burnt');
                        pot.classList.add('empty');
                    }
                    
                    // Update pot state
                    this.pots[potIndex].state = 'empty';
                    
                    console.log(' Burnt remnant cleared, pot ready for new planting');
                }
                
                const growthData = this.getPlantGrowthData()[seedName];
                if (!growthData) {
                    console.error(' DEBUG: No growth data found for', seedName);
                    return false; // Return false to indicate failure
                }
                
                console.log(' DEBUG: Growth data:', growthData);
                
                // Update pot state
                if (this.pots[potIndex]) {
                    this.pots[potIndex].state = 'growing';
                    this.pots[potIndex].data = {
                        state: 'growing',
                        seedName: seedName,
                        plantedTime: Date.now()
                    };
                }
                
                // Create vine element
                const vineElement = document.createElement('div');
                vineElement.className = 'vine growing';
                vineElement.style.backgroundImage = `url('${growthData.vineImage}')`;
                vineElement.style.animationDuration = `${growthData.growthTime}s`;
                
                // Position vine relative to pot
                const potElement = document.querySelector(`[data-pot-index="${potIndex}"]`);
                if (potElement) {
                    // Position vine in same container as pots but absolutely positioned over the specific pot
                    const potsContainer = document.getElementById('potsContainer');
                    if (potsContainer) {
                        // Get pot position relative to container
                        const potRect = potElement.getBoundingClientRect();
                        const containerRect = potsContainer.getBoundingClientRect();
                        
                        vineElement.style.left = (potRect.left - containerRect.left + potRect.width/2) + 'px';
                        vineElement.style.transform = 'translateX(-50%) scale(0.3, 0)';
                        
                        potsContainer.appendChild(vineElement);
                        console.log(' DEBUG: Vine element created and positioned at pot', potIndex);
                        
                        // Add animation end listener to ensure smooth transition
                        vineElement.addEventListener('animationend', () => {
                            console.log(' DEBUG: Growth animation completed for pot', potIndex);
                            // Force the grown state if animation completes
                            if (vineElement.classList.contains('growing')) {
                                vineElement.classList.remove('growing');
                                vineElement.classList.add('grown');
                                vineElement.style.transform = 'translateX(-50%) scale(1, 1)';
                                console.log(' DEBUG: Forced vine to grown state after animation');
                            }
                        });
                    }
                }
                
                // Track growing plant
                this.growingPlants.set(potIndex, {
                    vineElement: vineElement,
                    seedName: seedName,
                    startTime: Date.now(),
                    growthTime: growthData.growthTime * 1000, // Convert to milliseconds
                    ready: false
                });
                
                // Set timer for when plant is ready
                setTimeout(() => {
                    this.makeVineReady(potIndex);
                }, growthData.growthTime * 1000);
                
                console.log(` DEBUG: Started growing ${seedName} for ${growthData.growthTime} seconds`);
                return true; // Return true to indicate success
            }

            makeVineReady(potIndex) {
                console.log(' DEBUG: makeVineReady called for pot', potIndex);
                
                const plantData = this.growingPlants.get(potIndex);
                if (!plantData) {
                    console.error(' DEBUG: No growing plant found for pot', potIndex);
                    return;
                }
                
                // Update vine visual state - vine stays fully grown but gets golden glow
                if (plantData.vineElement) {
                    plantData.vineElement.classList.remove('growing');
                    plantData.vineElement.classList.add('grown', 'ready');
                    console.log(' DEBUG: Vine is now fully grown and ready to harvest!');
                    console.log(' DEBUG: Vine element classes:', plantData.vineElement.className);
                    console.log(' DEBUG: Vine element style:', plantData.vineElement.style.transform);
                    
                    //  SPAWN BEANS AROUND THE GROWN VINE!
                    this.spawnBeansAroundVine(potIndex, plantData.seedName, plantData.vineElement);
                }
                
                // Update pot state
                if (this.pots[potIndex]) {
                    this.pots[potIndex].state = 'ready';
                    this.pots[potIndex].data.state = 'ready';
                    
                    const potElement = document.querySelector(`[data-pot-index="${potIndex}"]`);
                    if (potElement) {
                        potElement.className = 'pot ready';
                    }
                }
                
                // Update plant data
                plantData.ready = true;
                this.growingPlants.set(potIndex, plantData);
                
                console.log(` DEBUG: ${plantData.seedName} in pot ${potIndex} is ready for harvest!`);
            }

            harvestPlant(potIndex) {
                console.log(' DEBUG: harvestPlant called for pot', potIndex);
                
                const plantData = this.growingPlants.get(potIndex);
                if (!plantData) {
                    console.error(' DEBUG: No plant data found for pot', potIndex);
                    return;
                }
                
                //  REMOVE BEANS FIRST!
                this.removeBeansFromVine(potIndex);
                
                // Remove vine element
                if (plantData.vineElement) {
                    plantData.vineElement.remove();
                    console.log(' DEBUG: Vine element removed');
                }
                
                // Reset pot state
                if (this.pots[potIndex]) {
                    this.pots[potIndex].state = 'empty';
                    this.pots[potIndex].data = { state: 'empty' };
                    
                    const potElement = document.querySelector(`[data-pot-index="${potIndex}"]`);
                    if (potElement) {
                        potElement.className = 'pot';
                    }
                }
                
                // Remove from growing plants tracking
                this.growingPlants.delete(potIndex);
                
                // TODO: Add harvested plant to inventory or give coins
                console.log(` DEBUG: Harvested ${plantData.seedName} from pot ${potIndex}!`);
                alert(`Harvested ${plantData.seedName}! \n\n(Harvesting rewards coming soon!)`);
            }

            // Plant growth data and vine mapping
            getPlantGrowthData() {
                return {
                    'Beanstalk': { growthTime: 25, vineImage: 'Assets/Vines/Beanstalkvine.png', type: 'Picker' },
                    'Snap Pea': { growthTime: 75, vineImage: 'Assets/Vines/peaseedvine.png', type: 'Picker' },
                    'Jellybean Vine': { growthTime: 90, vineImage: 'Assets/Vines/Jellybeanvine.png', type: 'Picker' },
                    'Bamboo-Bean': { growthTime: 120, vineImage: 'Assets/Vines/bamboovine.png', type: 'Cutter' },
                    'Coffee Beanstalk': { growthTime: 120, vineImage: 'Assets/Vines/Coffebeanvine.png', type: 'Picker' },
                    'Thunder Pod': { growthTime: 150, vineImage: 'Assets/Vines/Thunderpodvine.png', type: 'Cutter' },
                    'Frost Pea': { growthTime: 150, vineImage: 'Assets/Vines/frostvine.png', type: 'Picker' },
                    'Choco Vine': { growthTime: 180, vineImage: 'Assets/Vines/Chocovine.png', type: 'Picker' },
                    'Ironvine': { growthTime: 210, vineImage: 'Assets/Vines/Ironvine.png', type: 'Cutter' },
                    'Honeyvine': { growthTime: 180, vineImage: 'Assets/Vines/Honeyvine.png', type: 'Picker' },
                    'Sunbean': { growthTime: 240, vineImage: 'Assets/Vines/Sunbeanvine.png', type: 'Picker' },
                    'Moonbean': { growthTime: 240, vineImage: 'Assets/Vines/moonbeanvine.png', type: 'Picker' },
                    'Cloud Creeper': { growthTime: 270, vineImage: 'Assets/Vines/Cloudvine.png', type: 'Picker' },
                    'Royal Stalk': { growthTime: 300, vineImage: 'Assets/Vines/Royalstalkvine.png', type: 'Cutter' },
                    'Crystal Bean': { growthTime: 300, vineImage: 'Assets/Vines/Crystalbeanvine.png', type: 'Picker' },
                    'Neon Soy': { growthTime: 330, vineImage: 'Assets/Vines/Neonsoyvine.png', type: 'Cutter' },
                    'Vinecorn': { growthTime: 240, vineImage: 'Assets/Vines/Cornvine.png', type: 'Cutter' },
                    'Fire Pod': { growthTime: 360, vineImage: 'Assets/Vines/Firepodvine.png', type: 'Cutter' },
                    'Shadow Bean': { growthTime: 300, vineImage: 'Assets/Vines/Shadowbeanvine.png', type: 'Picker' },
                    'Prism Stalk': { growthTime: 480, vineImage: 'Assets/Vines/Prysmvine.png', type: 'Picker' }
                };
            }

            // Bean mapping for different plant types
            getBeanImageForPlant(plantName) {
                const beanMapping = {
                    'Beanstalk': 'Assets/BasicBeans/beanstalkbean.png', // Correct bean for basic beanstalk
                    'Snap Pea': 'Assets/BasicBeans/Snappeabean.png',
                    'Jellybean Vine': 'Assets/BasicBeans/Jellybean.png',
                    'Bamboo-Bean': 'Assets/BasicBeans/Bamboobean.png',
                    'Coffee Beanstalk': 'Assets/BasicBeans/Coffebean.png',
                    'Thunder Pod': 'Assets/BasicBeans/Thunderboltpeabean.png',
                    'Frost Pea': 'Assets/BasicBeans/Frostbean.png',
                    'Choco Vine': 'Assets/BasicBeans/Chocobean.png',
                    'Ironvine': 'Assets/BasicBeans/Ironbean.png',
                    'Honeyvine': 'Assets/BasicBeans/Honeybean.png',
                    'Sunbean': 'Assets/BasicBeans/Sunbean.png',
                    'Moonbean': 'Assets/BasicBeans/Moombean.png',
                    'Cloud Creeper': 'Assets/BasicBeans/Cloudbean.png',
                    'Royal Stalk': 'Assets/BasicBeans/Royalbean.png',
                    'Crystal Bean': 'Assets/BasicBeans/Crystalbean.png',
                    'Neon Soy': 'Assets/BasicBeans/Neonbean.png',
                    'Vinecorn': 'Assets/BasicBeans/Cornbean.png',
                    'Fire Pod': 'Assets/BasicBeans/Firebean.png',
                    'Shadow Bean': 'Assets/BasicBeans/Shadowbean.png',
                    'Prism Stalk': 'Assets/BasicBeans/Prysmbean.png'
                };
                
                return beanMapping[plantName] || 'Assets/BasicBeans/Jellybean.png'; // Default fallback
            }

            // Get spawn interval based on plant rarity - rarer plants spawn beans much slower
            getSpawnIntervalForPlant(plantName) {
                // Plant rarity mapping based on Setup.py PLANT_SPECIES
                const plantRarityMap = {
                    // Common - fastest spawning (3-5 seconds)
                    'Beanstalk': 'common',
                    'Snap Pea': 'common',
                    
                    // Uncommon - slower (8 seconds)  
                    'Jellybean Vine': 'uncommon',
                    'Bamboo-Bean': 'uncommon', 
                    'Coffee Beanstalk': 'uncommon',
                    
                    // Rare - much slower (10-14 seconds)
                    'Thunder Pod': 'rare',
                    'Frost Pea': 'rare',
                    'Choco Vine': 'rare',
                    
                    // Legendary - very slow (15-20 seconds)
                    'Ironvine': 'legendary',
                    'Honeyvine': 'legendary',
                    'Sunbean': 'legendary',
                    
                    // Mythical - extremely slow (25-35 seconds)
                    'Moonbean': 'mythical',
                    'Cloud Creeper': 'mythical',
                    
                    // Ultra-Mythical - painfully slow (40-60 seconds)
                    'Royal Stalk': 'ultra_mythical',
                    'Crystal Bean': 'ultra_mythical', 
                    'Neon Soy': 'ultra_mythical',
                    
                    // Godly - glacially slow (60-120 seconds)
                    'Vinecorn': 'godly',
                    'Fire Pod': 'godly',
                    'Shadow Bean': 'godly', 
                    'Prism Stalk': 'godly'
                };
                
                // Spawn interval mapping by rarity (in milliseconds) - MUCH SLOWER FOR BETTER PLANTS
                const rarityIntervals = {
                    'common': 2000,        // 2 seconds - fast and frequent
                    'uncommon': 8000,      // 8 seconds - noticeably slower
                    'rare': 20000,         // 20 seconds - much slower  
                    'legendary': 45000,    // 45 seconds - very slow
                    'mythical': 90000,     // 1.5 minutes - extremely slow
                    'ultra_mythical': 180000, // 3 minutes - painfully slow
                    'godly': 300000        // 5 minutes!! - ultra strategic
                };
                
                const rarity = plantRarityMap[plantName] || 'common';
                const interval = rarityIntervals[rarity];
                
                console.log(` DEBUG: ${plantName} (${rarity}) will spawn beans every ${interval/1000}s`);
                return interval;
            }

            // Bean value mapping based on plant types with rarity and size multipliers
            getBeanValueForPlant(plantName, rarity = 'none', size = 'normal') {
                const beanValues = {
                    'Beanstalk': () => 12 + Math.floor(Math.random() * 5), // 12-16 random
                    'Snap Pea': 90,
                    'Jellybean Vine': 170,
                    'Bamboo-Bean': 300,
                    'Coffee Beanstalk': 540,
                    'Thunder Pod': 970,
                    'Frost Pea': 2700,
                    'Choco Vine': 3500,
                    'Ironvine': 15300,
                    'Honeyvine': 19300,
                    'Sunbean': 25500,
                    'Moonbean': 43000,
                    'Cloud Creeper': 49000,
                    'Royal Stalk': 86000,
                    'Crystal Bean': 120000,
                    'Neon Soy': 160000,
                    'Vinecorn': 210000,
                    'Fire Pod': 280000,
                    'Shadow Bean': 320000,
                    'Prism Stalk': 340000
                };
                
                let baseValue = beanValues[plantName];
                if (typeof baseValue === 'function') {
                    baseValue = baseValue();
                } else if (!baseValue) {
                    baseValue = 10;
                }
                
                // Apply rarity multipliers
                let rarityMultiplier = 1.0;
                if (rarity === 'shiny') {
                    rarityMultiplier = 3.0; // 200% more valuable (3x multiplier) - 1.5% chance
                } else if (rarity === 'golden') {
                    rarityMultiplier = 6.0; // 500% more valuable (6x multiplier) - 1.5% chance
                }
                
                // Apply size multipliers (compound with rarity!)
                let sizeMultiplier = 1.0;
                if (size === 'big') {
                    sizeMultiplier = 3.0; // 200% more valuable (3x multiplier) - 2% chance
                } else if (size === 'massive') {
                    sizeMultiplier = 6.0; // 500% more valuable (6x multiplier) - 0.5% chance
                }
                
                const totalMultiplier = rarityMultiplier * sizeMultiplier;
                const finalValue = Math.floor(baseValue * totalMultiplier);
                
                // Log special beans for excitement!
                if (rarity !== 'none' || size !== 'normal') {
                    const rarityName = rarity === 'shiny' ? 'SILVER SHINY' : rarity === 'golden' ? 'GOLDEN' : '';
                    const sizeName = size === 'big' ? 'BIG' : size === 'massive' ? 'MASSIVE' : '';
                    const specialName = [sizeName, rarityName].filter(name => name).join(' ');
                    console.log(` ${specialName} BEAN! ${plantName} worth ${finalValue} coins (${totalMultiplier}x total multiplier!)`);
                }
                
                return finalValue;
            }

            // Get detailed seed information for tooltips
            getSeedInfo(seedName) {
                const seedData = {
                    'Beanstalk': { 
                        growthTime: 25, type: 'Picker', rarity: 'common', 
                        sellValue: '12-16', cost: 120, 
                        description: 'A humble beginning to your farming empire.' 
                    },
                    'Snap Pea': { 
                        growthTime: 75, type: 'Picker', rarity: 'common', 
                        sellValue: '90', cost: 560, 
                        description: 'Quick to grow, satisfying to harvest.' 
                    },
                    'Jellybean Vine': { 
                        growthTime: 90, type: 'Picker', rarity: 'uncommon', 
                        sellValue: '170', cost: 1285, 
                        description: 'Sweet rewards for patient gardeners.' 
                    },
                    'Bamboo-Bean': { 
                        growthTime: 120, type: 'Cutter', rarity: 'uncommon', 
                        sellValue: '300', cost: 5410, 
                        description: 'Strong and resilient, like bamboo itself.' 
                    },
                    'Coffee Beanstalk': { 
                        growthTime: 120, type: 'Picker', rarity: 'uncommon', 
                        sellValue: '540', cost: 9300, 
                        description: 'Energizing profits from caffeine-rich beans.' 
                    },
                    'Thunder Pod': { 
                        growthTime: 150, type: 'Cutter', rarity: 'rare', 
                        sellValue: '970', cost: 17000, 
                        description: 'Electrifying yields that strike like lightning.' 
                    },
                    'Frost Pea': { 
                        growthTime: 150, type: 'Picker', rarity: 'rare', 
                        sellValue: '2,700', cost: 31000, 
                        description: 'Cool profits from icy cold harvests.' 
                    },
                    'Choco Vine': { 
                        growthTime: 180, type: 'Picker', rarity: 'rare', 
                        sellValue: '3,500', cost: 35200, 
                        description: 'Sweet as chocolate, rich as gold.' 
                    },
                    'Ironvine': { 
                        growthTime: 210, type: 'Cutter', rarity: 'legendary', 
                        sellValue: '15,300', cost: 90000, 
                        description: 'Forged in nature, stronger than steel.' 
                    },
                    'Honeyvine': { 
                        growthTime: 180, type: 'Picker', rarity: 'legendary', 
                        sellValue: '19,300', cost: 180000, 
                        description: 'Golden nectar flows from these vines.' 
                    },
                    'Sunbean': { 
                        growthTime: 240, type: 'Picker', rarity: 'legendary', 
                        sellValue: '25,500', cost: 193000, 
                        description: 'Harness the power of the sun itself.' 
                    },
                    'Moonbean': { 
                        growthTime: 240, type: 'Picker', rarity: 'mythical', 
                        sellValue: '43,000', cost: 253000, 
                        description: 'Mystical beans blessed by lunar energy.' 
                    },
                    'Cloud Creeper': { 
                        growthTime: 270, type: 'Picker', rarity: 'mythical', 
                        sellValue: '49,000', cost: 295000, 
                        description: 'Floating profits from sky-high yields.' 
                    },
                    'Royal Stalk': { 
                        growthTime: 300, type: 'Cutter', rarity: 'ultra-mythical', 
                        sellValue: '86,000', cost: 465000, 
                        description: 'Fit for kings, priced for emperors.' 
                    },
                    'Crystal Bean': { 
                        growthTime: 300, type: 'Picker', rarity: 'ultra-mythical', 
                        sellValue: '120,000', cost: 600000, 
                        description: 'Crystalline perfection in bean form.' 
                    },
                    'Neon Soy': { 
                        growthTime: 330, type: 'Cutter', rarity: 'ultra-mythical', 
                        sellValue: '160,000', cost: 570000, 
                        description: 'Glowing with otherworldly profits.' 
                    },
                    'Vinecorn': { 
                        growthTime: 240, type: 'Cutter', rarity: 'godly', 
                        sellValue: '210,000', cost: 1200000, 
                        description: 'Divine fusion of vine and grain.' 
                    },
                    'Fire Pod': { 
                        growthTime: 360, type: 'Cutter', rarity: 'godly', 
                        sellValue: '280,000', cost: 1800000, 
                        description: 'Burning bright with eternal flame.' 
                    },
                    'Shadow Bean': { 
                        growthTime: 300, type: 'Picker', rarity: 'godly', 
                        sellValue: '320,000', cost: 3182000, 
                        description: 'Dark power yields illuminating profits.' 
                    },
                    'Prism Stalk': { 
                        growthTime: 480, type: 'Picker', rarity: 'godly', 
                        sellValue: '340,000', cost: 5620000, 
                        description: 'Refracts light into pure prosperity.' 
                    }
                };
                
                return seedData[seedName] || {
                    growthTime: 60, type: 'Unknown', rarity: 'common', 
                    sellValue: '?', cost: 0, description: 'Mystery seed with unknown properties.'
                };
            }

            // Create and show seed tooltip
            createSeedTooltip() {
                if (this.seedTooltip) return;
                
                this.seedTooltip = document.createElement('div');
                this.seedTooltip.className = 'seed-tooltip';
                document.body.appendChild(this.seedTooltip);
            }

            // Show seed tooltip with information
            showSeedTooltip(seedItem, anchorX, anchorY) {
                if (!this.seedTooltip) this.createSeedTooltip();
                
                const seedInfo = this.getSeedInfo(seedItem.name);
                
                this.seedTooltip.innerHTML = `
                    <div class="tooltip-header">
                        <div class="tooltip-icon" style="background-image: url('${seedItem.image}')"></div>
                        <div class="tooltip-title">
                            <h3 class="tooltip-name">${seedItem.name}</h3>
                            <p class="tooltip-rarity ${seedInfo.rarity}">${seedInfo.rarity}</p>
                        </div>
                    </div>
                    <div class="tooltip-stats">
                        <div class="tooltip-stat">
                            <span class="stat-icon"></span>
                            <span>${seedInfo.growthTime}s</span>
                        </div>
                        <div class="tooltip-stat">
                            <span class="stat-icon"></span>
                            <span>$${seedInfo.sellValue}</span>
                        </div>
                        <div class="tooltip-stat">
                            <span class="stat-icon">${seedInfo.type === 'Picker' ? '' : ''}</span>
                            <span>${seedInfo.type}</span>
                        </div>
                        <div class="tooltip-stat">
                            <span class="stat-icon"></span>
                            <span>${seedItem.quantity}</span>
                        </div>
                    </div>
                    <div class="tooltip-description">${seedInfo.description}</div>
                `;
                
                // Show tooltip first to get accurate dimensions
                this.seedTooltip.style.visibility = 'hidden';
                this.seedTooltip.classList.add('visible');
                
                // Now get accurate dimensions for positioning
                const tooltipRect = this.seedTooltip.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // Start with tooltip to the right of the anchor point
                let tooltipX = anchorX;
                let tooltipY = anchorY - (tooltipRect.height / 2); // Center vertically on the item
                
                // If tooltip goes off the right edge, show it on the left side
                if (tooltipX + tooltipRect.width > screenWidth - 20) {
                    tooltipX = anchorX - tooltipRect.width - 20;
                }
                
                // If tooltip goes off the bottom, push it up
                if (tooltipY + tooltipRect.height > screenHeight - 20) {
                    tooltipY = screenHeight - tooltipRect.height - 20;
                }
                
                // If tooltip goes off the top, push it down
                if (tooltipY < 20) {
                    tooltipY = 20;
                }
                
                // Apply final position and make visible
                this.seedTooltip.style.left = tooltipX + 'px';
                this.seedTooltip.style.top = tooltipY + 'px';
                this.seedTooltip.style.visibility = 'visible';
            }

            // Hide seed tooltip
            hideSeedTooltip() {
                if (this.seedTooltip) {
                    this.seedTooltip.classList.remove('visible');
                }
            }

            // Spawn beans around a grown beanstalk
            spawnBeansAroundVine(potIndex, plantName, vineElement) {
                console.log(' DEBUG: spawnBeansAroundVine called for', plantName, 'in pot', potIndex);
                
                // Check if beans are already spawning for this vine
                const plantData = this.growingPlants.get(potIndex);
                if (plantData && plantData.isSpawningBeans) {
                    console.log(' DEBUG: Beans already spawning for pot', potIndex);
                    return;
                }
                
                const beanImage = this.getBeanImageForPlant(plantName);
                const potsContainer = document.getElementById('potsContainer');
                
                if (!potsContainer || !vineElement) {
                    console.error(' DEBUG: Missing potsContainer or vineElement');
                    return;
                }
                
                // Mark as spawning to prevent duplicate calls
                if (plantData) {
                    plantData.isSpawningBeans = true;
                    plantData.beanCount = 0;
                    plantData.beanSpawnIndex = 0; // Track spawn index for unique IDs
                    this.growingPlants.set(potIndex, plantData);
                }
                
                // Get vine position
                const vineRect = vineElement.getBoundingClientRect();
                const containerRect = potsContainer.getBoundingClientRect();
                
                // Calculate relative position
                const vineX = vineRect.left - containerRect.left + (vineRect.width / 2);
                const vineY = vineRect.top - containerRect.top + (vineRect.height / 2);
                
                console.log(' DEBUG: Starting continuous bean spawning around vine at', vineX, vineY);
                
                // Start initial burst of beans (8-12 beans immediately)
                const initialBeans = Math.floor(Math.random() * 5) + 8; // 8-12 initial beans
                const initialSpawnInterval = 600; // 600ms between initial beans
                
                for (let i = 0; i < initialBeans; i++) {
                    setTimeout(() => {
                        this.spawnSingleBeanRandomly(potIndex, beanImage, vineX, vineY, plantData.beanSpawnIndex++, plantName);
                    }, i * initialSpawnInterval + Math.random() * 200);
                }
                
                // Start continuous spawning system to maintain 20 beans max
                this.startContinuousSpawning(potIndex, beanImage, vineX, vineY, plantName);
                
                console.log(` DEBUG: Started initial batch of ${initialBeans} beans + continuous spawning system`);
            }

            // Start continuous spawning system to maintain max beans
            startContinuousSpawning(potIndex, beanImage, vineX, vineY, plantName) {
                const plantData = this.growingPlants.get(potIndex);
                if (!plantData) return;
                
                // Store spawning info for continuous use
                plantData.continuousSpawning = {
                    beanImage: beanImage,
                    vineX: vineX,
                    vineY: vineY,
                    plantName: plantName,
                    intervalId: null
                };
                
                // Rarity-based spawning intervals - rarer plants spawn beans much slower
                const baseInterval = this.getSpawnIntervalForPlant(plantName);
                const checkInterval = baseInterval + Math.random() * (baseInterval * 0.5); // Add 0-50% random variation
                plantData.continuousSpawning.intervalId = setInterval(() => {
                    this.checkAndSpawnBeans(potIndex);
                }, checkInterval);
                
                this.growingPlants.set(potIndex, plantData);
                console.log(` DEBUG: Started continuous spawning for pot ${potIndex} (checking every ${Math.round(checkInterval/1000)}s)`);
            }

            // Check current bean count and spawn more if needed
            checkAndSpawnBeans(potIndex) {
                const plantData = this.growingPlants.get(potIndex);
                if (!plantData || !plantData.continuousSpawning) return;
                
                // Check if vine is still ready (not harvested)
                if (this.pots[potIndex]?.state !== 'ready') {
                    console.log(' DEBUG: Stopping continuous spawning - vine no longer ready');
                    this.stopContinuousSpawning(potIndex);
                    return;
                }
                
                // Count current beans around this vine
                const currentBeans = document.querySelectorAll(`[data-pot-index="${potIndex}"].vine-bean:not(.flying-to-money)`);
                const currentCount = currentBeans.length;
                const maxBeans = 20;
                
                if (currentCount < maxBeans) {
                    const beansToSpawn = Math.min(maxBeans - currentCount, 3); // Spawn 1-3 beans at a time
                    const spawning = plantData.continuousSpawning;
                    
                    console.log(` DEBUG: Pot ${potIndex} has ${currentCount}/${maxBeans} beans - spawning ${beansToSpawn} more`);
                    
                    // Spawn the needed beans with slight delays
                    for (let i = 0; i < beansToSpawn; i++) {
                        setTimeout(() => {
                            plantData.beanSpawnIndex = (plantData.beanSpawnIndex || 0) + 1;
                            this.spawnSingleBeanRandomly(
                                potIndex, 
                                spawning.beanImage, 
                                spawning.vineX, 
                                spawning.vineY, 
                                plantData.beanSpawnIndex, 
                                spawning.plantName
                            );
                        }, i * 300 + Math.random() * 200); // 300ms between spawns + random delay
                    }
                }
            }

            // Stop continuous spawning (when harvesting)
            stopContinuousSpawning(potIndex) {
                const plantData = this.growingPlants.get(potIndex);
                if (plantData?.continuousSpawning?.intervalId) {
                    clearInterval(plantData.continuousSpawning.intervalId);
                    plantData.continuousSpawning = null;
                    this.growingPlants.set(potIndex, plantData);
                    console.log(` DEBUG: Stopped continuous spawning for pot ${potIndex}`);
                }
            }

            // Spawn a single bean at a random position alongside the vine
            spawnSingleBeanRandomly(potIndex, beanImage, vineX, vineY, beanIndex, plantName) {
                const plantData = this.growingPlants.get(potIndex);
                if (!plantData) {
                    return; // Stop spawning if plant is gone
                }
                
                // Check current bean count via DOM (more reliable than tracking)
                const currentBeans = document.querySelectorAll(`[data-pot-index="${potIndex}"].vine-bean:not(.flying-to-money)`);
                if (currentBeans.length >= 20) {
                    console.log(' DEBUG: Max beans reached for pot', potIndex, '- skipping spawn');
                    return; // Already at max beans
                }
                
                const potsContainer = document.getElementById('potsContainer');
                if (!potsContainer) return;
                
                // Position beans closer to the middle of the vine, shifted slightly left
                const side = Math.random() < 0.5 ? -1 : 1; // -1 = left side, 1 = right side
                const sideDistance = 15 + Math.random() * 25; // Distance 15-40px from vine center (closer!)
                const randomX = (side * sideDistance) - 12; // Left or right of vine, with tiny bit more left shift (-12px)
                
                // Position along the vine height, shifted slightly up
                const vineHeight = 340; // Slightly reduced vine height (was 350)
                const randomY = Math.random() * vineHeight - (vineHeight * 0.4) - 10; // Shifted up by 25px (from +15 to -10)
                
                // Random rotation for orientation - this MUST be preserved!
                const randomRotation = Math.random() * 360; // 0-360 rotation
                const randomScale = 0.8 + Math.random() * 0.4; // Random size 0.8x-1.2x
                
                // Random animation delay
                const randomDelay = Math.random() * 1.5; // 0-1.5s delay
                
                // Generate bean rarity - 1.5% silver shiny, 1.5% golden (much rarer!)
                const rarityRoll = Math.random();
                let beanRarity = 'none';
                if (rarityRoll < 0.015) {
                    beanRarity = 'shiny'; // Silver shiny - 1.5% chance, 200% more valuable
                } else if (rarityRoll < 0.03) {
                    beanRarity = 'golden'; // Golden - 1.5% chance, 500% more valuable  
                }
                
                // Generate bean size - 2% big, 0.5% massive (much rarer, can compound with rarity!)
                const sizeRoll = Math.random();
                let beanSize = 'normal';
                if (sizeRoll < 0.005) {
                    beanSize = 'massive'; // Massive - 0.5% chance, 500% more valuable
                } else if (sizeRoll < 0.025) {
                    beanSize = 'big'; // Big - 2% chance, 200% more valuable
                }
                
                // Create bean element
                const bean = document.createElement('div');
                let className = 'vine-bean';
                if (beanRarity !== 'none') className += ` rarity-${beanRarity}`;
                if (beanSize !== 'normal') className += ` size-${beanSize}`;
                bean.className = className;
                bean.style.backgroundImage = `url('${beanImage}')`;
                bean.style.left = (vineX + randomX) + 'px';
                bean.style.top = (vineY + randomY) + 'px';
                bean.style.animationDelay = randomDelay + 's';
                bean.dataset.potIndex = potIndex;
                bean.dataset.beanIndex = beanIndex;
                bean.dataset.plantName = plantName; // Store plant name for value calculation
                bean.dataset.rarity = beanRarity; // Store rarity for value calculation
                bean.dataset.size = beanSize; // Store size for value calculation
                
                // Store the final transform values as CSS variables for the animation
                bean.style.setProperty('--final-scale', randomScale);
                bean.style.setProperty('--final-rotation', randomRotation + 'deg');
                
                // Add click event handler for amazing bean collection!
                bean.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.collectBean(bean, plantName);
                });
                
                // Bean starts invisible and small (CSS handles this via :not(.spawned))
                
                potsContainer.appendChild(bean);
                
                // Animate bean appearance after a brief delay
                setTimeout(() => {
                    // Add spawned class which triggers the pulse animation and makes it visible
                    bean.classList.add('spawned');
                    // Set the final transform that will be used by the CSS animation
                    bean.style.transform = `scale(${randomScale}) rotate(${randomRotation}deg)`;
                }, 50);
                
                console.log(` DEBUG: Spawned bean ${beanIndex} on ${side === -1 ? 'LEFT' : 'RIGHT'} side at (${Math.round(randomX)}, ${Math.round(randomY)}) with ${Math.round(randomRotation)} rotation (${currentBeans.length + 1}/20)`);
            }

            // Clean up beans when harvesting
            removeBeansFromVine(potIndex) {
                // Stop continuous spawning first
                this.stopContinuousSpawning(potIndex);
                
                const beans = document.querySelectorAll(`[data-pot-index="${potIndex}"].vine-bean`);
                beans.forEach(bean => {
                    bean.remove();
                });
                
                // Reset bean tracking state
                const plantData = this.growingPlants.get(potIndex);
                if (plantData) {
                    plantData.isSpawningBeans = false;
                    plantData.beanCount = 0;
                    this.growingPlants.set(potIndex, plantData);
                }
                
                console.log(' DEBUG: Removed', beans.length, 'beans from pot', potIndex, '+ stopped continuous spawning');
            }

            // AMAZING bean collection with flying animation!
            collectBean(beanElement, plantName) {
                if (beanElement.classList.contains('flying-to-money')) {
                    return; // Already being collected
                }
                
                console.log(' DEBUG: Collecting bean from', plantName);
                console.log(' DEBUG: Bean element:', beanElement);
                console.log(' DEBUG: Bean dataset:', beanElement.dataset);
                
                // Get bean value with rarity and size multipliers
                const beanRarity = beanElement.dataset.rarity || 'none';
                const beanSize = beanElement.dataset.size || 'normal';
                const beanValue = this.getBeanValueForPlant(plantName, beanRarity, beanSize);
                
                // IMMEDIATE SATISFYING CLICK EFFECTS! 
                this.playClickEffects(beanElement);
                
                // Tutorial tracking
                this.onTutorialBeanCollected(beanRarity, beanSize);
                
                // Unlock this bean type in the collection index
                this.unlockBean(plantName);
                
                // Play special collection sound based on bean attributes (priority: golden > shiny > massive > big)
                if (beanRarity === 'golden') {
                    this.playSound('goldcollect'); // Special golden bean sound
                } else if (beanRarity === 'shiny') {
                    this.playSound('collectsilver'); // Special silver shiny bean sound
                } else if (beanSize === 'massive') {
                    this.playSound('goldcollect'); // Massive beans use premium sound
                } else if (beanSize === 'big') {
                    this.playSound('collectsilver'); // Big beans use enhanced sound
                } else {
                    // Regular bean collection - alternate between two sounds for variety
                    const beanSounds = ['collectbean', 'collectbean2'];
                    const randomSound = beanSounds[Math.floor(Math.random() * beanSounds.length)];
                    this.playSound(randomSound);
                }
                
                // Mark bean as flying to prevent multiple clicks
                beanElement.classList.add('flying-to-money');
                
                // Start the flying animation after click effect (300ms delay for satisfaction)
                setTimeout(() => {
                    this.animateBeanToMoney(beanElement, beanValue);
                }, 300);
            }

            // Play immediate satisfying click effects
            playClickEffects(beanElement) {
                // Add satisfying pop animation to the bean
                beanElement.classList.add('clicked');
                
                // Create burst effect around the bean
                const beanRect = beanElement.getBoundingClientRect();
                const potsContainer = document.getElementById('potsContainer');
                
                const burst = document.createElement('div');
                burst.className = 'click-burst';
                burst.style.position = 'fixed';
                burst.style.left = (beanRect.left + beanRect.width/2 - 60) + 'px'; // Center the 120px burst
                burst.style.top = (beanRect.top + beanRect.height/2 - 60) + 'px';
                burst.style.zIndex = '99';
                
                document.body.appendChild(burst);
                
                // Remove burst after animation
                setTimeout(() => {
                    burst.remove();
                }, 400);
                
                // Add screen shake effect for extra satisfaction
                this.addScreenShake();
                
                console.log(' DEBUG: Click effects triggered!');
            }

            // Add subtle screen shake for satisfying feedback
            addScreenShake() {
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                    gameContainer.style.animation = 'screenShake 0.2s ease-in-out';
                    
                    setTimeout(() => {
                        gameContainer.style.animation = '';
                    }, 200);
                }
            }

            // Amazing flying animation from bean to money display
            animateBeanToMoney(beanElement, beanValue) {
                // Get current positions
                const beanRect = beanElement.getBoundingClientRect();
                const moneyElement = document.getElementById('moneyAmount');
                const moneyRect = moneyElement.getBoundingClientRect();
                
                // Calculate the flight path
                const startX = beanRect.left + beanRect.width / 2;
                const startY = beanRect.top + beanRect.height / 2;
                const endX = moneyRect.left + moneyRect.width / 2;
                const endY = moneyRect.top + moneyRect.height / 2;
                
                // Create a clone for the animation
                const flyingBean = beanElement.cloneNode(true);
                flyingBean.style.position = 'fixed';
                flyingBean.style.left = startX + 'px';
                flyingBean.style.top = startY + 'px';
                flyingBean.style.zIndex = '100';
                flyingBean.style.pointerEvents = 'none';
                flyingBean.classList.add('flying-to-money');
                flyingBean.style.width = '40px';
                flyingBean.style.height = '40px';
                
                document.body.appendChild(flyingBean);
                
                // REMOVE THE ORIGINAL BEAN IMMEDIATELY when flight starts!
                beanElement.remove();
                
                console.log(` DEBUG: Flying bean from (${Math.round(startX)}, ${Math.round(startY)}) to (${Math.round(endX)}, ${Math.round(endY)})`);
                
                // Calculate flight duration based on distance (longer for dramatic effect)
                const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                const duration = Math.min(Math.max(distance / 300, 1.2), 2.5); // 1.2-2.5 seconds (longer)
                
                // Apply the flying animation with calculated duration
                flyingBean.style.animation = `beanFlyToMoney ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`;
                
                // Create beautiful curved path animation
                this.animateAlongCurvedPath(flyingBean, startX, startY, endX, endY, duration);
                
                // Add money and effects when bean reaches destination
                setTimeout(() => {
                    console.log(' DEBUG: Bean collection timeout triggered!');
                    
                    // Add the money!
                    this.addMoney(beanValue);
                    
                    // Get bean rarity and size from the flying bean element dataset
                    const beanRarity = flyingBean.dataset.rarity || 'none';
                    const beanSize = flyingBean.dataset.size || 'normal';
                    console.log(` DEBUG: Bean rarity from dataset: ${beanRarity}`);
                    console.log(` DEBUG: Bean size from dataset: ${beanSize}`);
                    
                    // Add XP based on bean rarity and size (10-20 XP range with decimals)
                    let baseXP = Math.random() * 10 + 10; // Random 10.0 - 20.0
                    console.log(` DEBUG: Base XP rolled: ${baseXP}`);
                    
                    // Apply rarity XP multipliers
                    if (beanRarity === 'shiny') {
                        baseXP *= 1.5; // Silver beans give 50% more XP
                        console.log(` DEBUG: Silver bean multiplier applied: ${baseXP}`);
                    } else if (beanRarity === 'golden') {
                        baseXP *= 2.0; // Golden beans give 100% more XP
                        console.log(` DEBUG: Golden bean multiplier applied: ${baseXP}`);
                    }
                    
                    // Apply size XP multipliers (compound with rarity!)
                    if (beanSize === 'big') {
                        baseXP *= 1.5; // Big beans give 50% more XP
                        console.log(` DEBUG: Big bean size multiplier applied: ${baseXP}`);
                    } else if (beanSize === 'massive') {
                        baseXP *= 2.0; // Massive beans give 100% more XP
                        console.log(` DEBUG: Massive bean size multiplier applied: ${baseXP}`);
                    }
                    const finalXP = Math.round(baseXP * 10) / 10; // Round to 1 decimal place
                    
                    const beanDescription = [beanSize !== 'normal' ? beanSize : '', beanRarity !== 'none' ? beanRarity : ''].filter(desc => desc).join(' ') || 'normal';
                    console.log(` DEBUG: Bean collected! Value: $${beanValue}, Rarity: ${beanRarity}, Size: ${beanSize}, Final XP: ${finalXP}`);
                    this.addXP(finalXP, `${beanDescription} bean`);
                
                // Show money burst effect
                this.showMoneyBurst(endX, endY, beanValue);
                    
                    // Remove the flying bean
                    flyingBean.remove();
                    
                    console.log(` DEBUG: Bean collected! Added $${beanValue.toLocaleString()}`);
                    
                    // Trigger immediate check for spawning replacement bean (after a short delay)
                    const potIndex = parseInt(flyingBean.dataset.potIndex); // Use flyingBean since original is gone
                    if (!isNaN(potIndex)) {
                        setTimeout(() => {
                            this.checkAndSpawnBeans(potIndex);
                        }, 500 + Math.random() * 1000); // 0.5-1.5 second delay
                    }
                    
                }, duration * 1000);
            }

            // Animate bean along a beautiful curved path across the screen
            animateAlongCurvedPath(beanElement, startX, startY, endX, endY, duration) {
                // Calculate control points for a dramatic arc
                const midX = (startX + endX) / 2;
                const midY = Math.min(startY, endY) - 150 - Math.random() * 50; // Higher arc (150-200px up)
                
                // Use requestAnimationFrame for smooth animation
                const startTime = performance.now();
                
                const animateStep = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    let progress = Math.min(elapsed / (duration * 1000), 1);
                    
                    // Apply easing for more satisfying movement (ease-in-out-back)
                    progress = progress < 0.5 
                        ? 2 * progress * progress 
                        : -1 + (4 - 2 * progress) * progress;
                    
                    // Quadratic Bzier curve calculation
                    const t = progress;
                    const x = Math.pow(1 - t, 2) * startX + 2 * (1 - t) * t * midX + Math.pow(t, 2) * endX;
                    const y = Math.pow(1 - t, 2) * startY + 2 * (1 - t) * t * midY + Math.pow(t, 2) * endY;
                    
                    // Add slight wobble for more organic movement
                    const wobbleX = 5 * Math.sin(progress * Math.PI * 8) * (1 - progress);
                    const wobbleY = 3 * Math.cos(progress * Math.PI * 12) * (1 - progress);
                    
                    // Update position with wobble
                    beanElement.style.left = (x + wobbleX) + 'px';
                    beanElement.style.top = (y + wobbleY) + 'px';
                    
                    // Scale the bean slightly during flight for depth effect
                    const scale = 1.2 + (0.3 * Math.sin(progress * Math.PI));
                    beanElement.style.transform = `scale(${scale}) rotate(${progress * 720}deg)`;
                    
                    // Add subtle opacity pulsing
                    beanElement.style.opacity = 0.95 + (0.05 * Math.sin(progress * Math.PI * 4));
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateStep);
                    } else {
                        // Ensure final position is exact
                        beanElement.style.left = endX + 'px';
                        beanElement.style.top = endY + 'px';
                    }
                };
                
                requestAnimationFrame(animateStep);
            }

            // Add money to player's total
            addMoney(amount) {
                console.log(` DEBUG: Adding ${amount} coins. Before: ${this.currentMoney}, After: ${this.currentMoney + amount}`);
                this.currentMoney += amount;
                this.updateMoneyDisplay();
                
                // Sync money to server after earning (debounced)
                this.debouncedSyncMoney();
                
                // Play coin sound effect
                this.playSound('coin');
            }

            // Sync money to server
            async syncMoneyToServer() {
                try {
                    console.log(' DEBUG: Syncing money to server:', this.currentMoney);
                    const response = await fetch('/api/update-money', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            coins: this.currentMoney
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(' DEBUG: Money synced successfully:', result);
                    } else {
                        console.error(' Failed to sync money to server:', response.status);
                    }
                } catch (error) {
                    console.error(' Error syncing money to server:', error);
                }
            }

            // Debounced money sync to avoid spamming the server
            debouncedSyncMoney() {
                clearTimeout(this.moneySyncTimeout);
                this.moneySyncTimeout = setTimeout(() => {
                    this.syncMoneyToServer();
                }, 1000); // Sync money 1 second after last bean collection
            }

            // ===== LEVEL SYSTEM =====

            // Calculate XP requirement for a specific level
            calculateXPForLevel(level) {
                // 20% growth: level 1->2 = 1000 XP, level 2->3 = 1200 XP, level 3->4 = 1440 XP, etc.
                return Math.floor(this.baseXPRequirement * Math.pow(1.2, level - 2));
            }

            // Get total XP needed to reach a level (cumulative)
            getTotalXPForLevel(level) {
                let totalXP = 0;
                for (let i = 2; i <= level; i++) {
                    totalXP += this.calculateXPForLevel(i);
                }
                return totalXP;
            }

            // Add XP and handle level ups
            addXP(amount, source = 'unknown') {
                console.log(` DEBUG: addXP called! Amount: ${amount}, Source: ${source}`);
                const oldLevel = this.currentLevel;
                this.currentXP = Math.round((this.currentXP + amount) * 10) / 10; // Round to 1 decimal place
                
                console.log(` XP: +${amount} from ${source} (Total: ${this.currentXP})`);
                console.log(` Current Level: ${this.currentLevel}, XP needed for next: ${this.getTotalXPForLevel(this.currentLevel + 1)}`);
                
                // Check for level up
                let newLevel = this.currentLevel;
                while (this.currentXP >= this.getTotalXPForLevel(newLevel + 1) && newLevel < 100) {
                    newLevel++;
                }
                
                if (newLevel > oldLevel) {
                    console.log(` LEVEL UP TRIGGERED! ${oldLevel}  ${newLevel}`);
                    this.levelUp(oldLevel, newLevel);
                } else {
                    console.log(` Level bar updating... Level ${this.currentLevel}`);
                    this.updateLevelBar();
                }
            }

            // Handle leveling up
            levelUp(oldLevel, newLevel) {
                this.currentLevel = newLevel;
                console.log(` LEVEL UP! ${oldLevel}  ${newLevel}`);
                
                // Play level up sound! 
                this.playSound('levelup');
                
                // EPIC SCREEN SHAKE! 
                this.triggerScreenShake();
                
                // INTENSE level bar animation
                const levelBarFill = document.getElementById('levelBarFill');
                if (levelBarFill) {
                    levelBarFill.classList.add('level-up-epic');
                    setTimeout(() => {
                        levelBarFill.classList.remove('level-up-epic');
                    }, 3000);
                }
                
                // SCREEN FLASH EFFECT! 
                this.triggerScreenFlash();
                
                // Update the display
                this.updateLevelBar();
                
                // Check for fire unlock at level 3
                if (newLevel >= 3 && !this.fireUnlocked) {
                    this.unlockLevel3Tools();
                }

                // Show EPIC notification
                this.showEpicLevelUpNotification(newLevel);
            }

            // Update the level bar display
            updateLevelBar() {
                const levelElement = document.getElementById('currentLevel');
                const xpElement = document.getElementById('currentXP');
                const nextLevelXPElement = document.getElementById('nextLevelXP');
                const levelBarFill = document.getElementById('levelBarFill');
                
                console.log(` Updating level bar - Elements found:`, {
                    levelElement: !!levelElement,
                    xpElement: !!xpElement,
                    nextLevelXPElement: !!nextLevelXPElement,
                    levelBarFill: !!levelBarFill
                });
                
                if (!levelElement || !xpElement || !nextLevelXPElement || !levelBarFill) {
                    console.error(' Some level bar elements not found!');
                    return;
                }
                
                // Calculate current level progress
                const currentLevelStartXP = this.currentLevel > 1 ? this.getTotalXPForLevel(this.currentLevel) : 0;
                const nextLevelXP = this.getTotalXPForLevel(this.currentLevel + 1);
                const xpInCurrentLevel = this.currentXP - currentLevelStartXP;
                const xpNeededForNext = nextLevelXP - currentLevelStartXP;
                
                // Calculate percentage for progress bar
                const percentage = Math.min((xpInCurrentLevel / xpNeededForNext) * 100, 100);
                
                console.log(` Level calculation:`, {
                    currentLevel: this.currentLevel,
                    totalXP: this.currentXP,
                    currentLevelStartXP: currentLevelStartXP,
                    nextLevelXP: nextLevelXP,
                    xpInCurrentLevel: xpInCurrentLevel,
                    xpNeededForNext: xpNeededForNext,
                    percentage: percentage.toFixed(1) + '%'
                });
                
                // Update display with decimal places
                levelElement.textContent = this.currentLevel;
                xpElement.textContent = xpInCurrentLevel.toFixed(1); // Show 1 decimal place
                nextLevelXPElement.textContent = xpNeededForNext.toLocaleString(); // Format with commas
                levelBarFill.style.width = percentage + '%';
                
                console.log(` Level bar updated! Level ${this.currentLevel}: ${xpInCurrentLevel.toFixed(1)}/${xpNeededForNext} XP (${percentage.toFixed(1)}%)`);
            }

            // EPIC SCREEN SHAKE EFFECT! 
            triggerScreenShake() {
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                    gameContainer.classList.add('epic-screen-shake');
                    setTimeout(() => {
                        gameContainer.classList.remove('epic-screen-shake');
                    }, 2000);
                }
            }

            // INTENSE SCREEN FLASH EFFECT! 
            triggerScreenFlash() {
                const flash = document.createElement('div');
                flash.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: radial-gradient(circle, 
                        rgba(255, 215, 0, 0.9) 0%, 
                        rgba(255, 140, 0, 0.7) 30%, 
                        rgba(255, 69, 0, 0.5) 60%, 
                        transparent 100%);
                    z-index: 9999;
                    pointer-events: none;
                    animation: epicFlash 2s ease-out forwards;
                `;
                document.body.appendChild(flash);

                // Multiple flash waves
                setTimeout(() => {
                    const flash2 = flash.cloneNode();
                    flash2.style.animation = 'epicFlash 1.5s ease-out forwards';
                    flash2.style.background = `radial-gradient(circle, 
                        rgba(0, 255, 255, 0.6) 0%, 
                        rgba(255, 0, 255, 0.4) 50%, 
                        transparent 100%)`;
                    document.body.appendChild(flash2);
                    setTimeout(() => flash2.remove(), 1500);
                }, 300);

                setTimeout(() => flash.remove(), 2000);
            }

            // PARTICLE EXPLOSION SYSTEM REMOVED - keeping only text

            // ===== FIRE BURN TOOL SYSTEM =====
            
            // Unlock level 3 tools (fire burn tool + bean collection)
            unlockLevel3Tools() {
                console.log(' Unlocking Level 3 tools!');
                this.fireUnlocked = true;
                this.beanCollectionUnlocked = true;
                
                const level3Tools = document.getElementById('level3Tools');
                if (level3Tools) {
                    level3Tools.style.display = 'flex';
                    
                    // Setup fire tool drag functionality
                    this.setupFireDragAndDrop();
                    
                    console.log(' Level 3 tools unlocked and visible!');
                }
            }

            // Legacy function name for compatibility
            unlockFireTool() {
                this.unlockLevel3Tools();
            }

            // Setup custom drag functionality for fire emoji (like inventory items)
            setupFireDragAndDrop() {
                const fireEmoji = document.getElementById('fireEmoji');
                if (!fireEmoji) return;

                let isDragging = false;

                // Mouse down - start drag
                fireEmoji.addEventListener('mousedown', (e) => {
                    console.log(' Fire drag started');
                    isDragging = true;
                    
                    fireEmoji.classList.add('dragging');
                    
                    e.preventDefault();
                });

                // Mouse move - update drag position
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    // Position the fire emoji at cursor
                    fireEmoji.style.position = 'fixed';
                    fireEmoji.style.left = (e.clientX - 24) + 'px'; // Center on cursor (24px = half of 48px emoji)
                    fireEmoji.style.top = (e.clientY - 24) + 'px';
                    fireEmoji.style.zIndex = '1000';
                    
                    // Visual feedback - check for nearby vines (throttle to reduce spam)
                    if (!this.lastVineCheck || Date.now() - this.lastVineCheck > 100) {
                        this.lastVineCheck = Date.now();
                        const vineResult = this.getClosestVine(e.clientX, e.clientY);
                        if (vineResult && vineResult.distance <= 50) {
                            // Add visual feedback for nearby vine
                            console.log(` Near ${vineResult.plantName} (${vineResult.distance.toFixed(0)}px)`);
                            vineResult.vine.style.filter = 'brightness(1.2) drop-shadow(0 0 10px rgba(255, 100, 0, 0.8))';
                        } else {
                            // Remove visual feedback from all vines
                            const gameContainer = document.getElementById('gameContainer');
                            const allVines = gameContainer.querySelectorAll('.vine, .plant-background');
                            allVines.forEach(vine => {
                                vine.style.filter = '';
                            });
                        }
                    }
                });

                // Mouse up - end drag
                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    
                    console.log(' Fire drag ended at position:', e.clientX, e.clientY);
                    isDragging = false;
                    fireEmoji.classList.remove('dragging');
                    
                    // Check if dropped near a vine
                    const vineResult = this.getClosestVine(e.clientX, e.clientY);
                    console.log(' Vine result:', vineResult);
                    
                    if (vineResult) {
                        this.handleFireDropOnVine(vineResult.potIndex, vineResult.plantName, vineResult.distance);
                    } else {
                        console.log(' No vine found within range');
                    }
                    
                    // Reset position and styling
                    fireEmoji.style.position = '';
                    fireEmoji.style.left = '';
                    fireEmoji.style.top = '';
                    fireEmoji.style.zIndex = '';
                    
                    // Clear visual feedback from all vines
                    const gameContainer = document.getElementById('gameContainer');
                    const allVines = gameContainer.querySelectorAll('.vine, .plant-background');
                    allVines.forEach(vine => {
                        vine.style.filter = '';
                    });
                });
            }

            // Find closest vine to cursor position
            getClosestVine(x, y) {
                console.log(` Looking for closest vine to position: (${x}, ${y})`);
                
                let closestVine = null;
                let closestDistance = Infinity;
                const maxDistance = 100; // Maximum distance to consider "close"
                
                console.log(` Found ${this.growingPlants.size} growing plants to check`);
                
                // Iterate through the growingPlants Map instead of trying to find vines as pot children
                for (const [potIndex, plantData] of this.growingPlants.entries()) {
                    if (!plantData.vineElement) {
                        console.log(` Pot ${potIndex} has no vine element, skipping`);
                        continue;
                    }
                    
                    const vine = plantData.vineElement;
                    console.log(` Found vine in pot ${potIndex}:`, vine.className);
                    
                    // Get vine center position
                    const vineRect = vine.getBoundingClientRect();
                    const vineCenterX = vineRect.left + vineRect.width / 2;
                    const vineCenterY = vineRect.top + vineRect.height / 2;
                    
                    // Calculate distance from cursor to vine center
                    const distance = Math.sqrt(
                        Math.pow(x - vineCenterX, 2) + Math.pow(y - vineCenterY, 2)
                    );
                    
                    console.log(` Pot ${potIndex}: vine center at (${vineCenterX.toFixed(0)}, ${vineCenterY.toFixed(0)}), distance: ${distance.toFixed(0)}px`);
                    
                    if (distance < closestDistance && distance <= maxDistance) {
                        closestDistance = distance;
                        
                        // Get plant name from seed name or use fallback
                        const plantName = plantData.seedName ? plantData.seedName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown Plant';
                        
                        closestVine = {
                            potIndex: potIndex,
                            plantName: plantName,
                            distance: distance,
                            vine: vine
                        };
                        
                        console.log(` New closest vine found: ${plantName} at distance ${distance.toFixed(0)}px`);
                    }
                }
                
                if (closestVine) {
                    console.log(` Final result: ${closestVine.plantName} (pot ${closestVine.potIndex}) at ${closestVine.distance.toFixed(0)}px distance `);
                } else {
                    console.log(` No vine found within ${maxDistance}px range`);
                }
                
                return closestVine;
            }

            // Setup visual feedback for pot drop zones during fire drag
            setupPotDropZones() {
                // This is now handled in the mouse move/up events above
                console.log(' Drop zones setup completed (custom drag system)');
            }

            // Handle fire drop on vine
            handleFireDropOnVine(potIndex, plantName, distance) {
                console.log(` Fire dropped near ${plantName} (${distance.toFixed(0)}px away)`);
                this.showBurnConfirmation(potIndex, plantName);
            }

            // Show burn confirmation modal
            showBurnConfirmation(potIndex, plantName) {
                // Store the pending burn data
                this.pendingBurn = {
                    potIndex: potIndex,
                    plantName: plantName
                };
                
                // Update modal content
                document.getElementById('burnItemName').textContent = plantName;
                
                // Show modal
                document.getElementById('burnModal').classList.add('active');
                document.getElementById('burnModalOverlay').classList.add('active');
                
                console.log(` Showing burn confirmation for ${plantName} in pot ${potIndex}`);
            }

            // Cancel burn action
            cancelBurn() {
                // Hide modal
                document.getElementById('burnModal').classList.remove('active');
                document.getElementById('burnModalOverlay').classList.remove('active');
                
                // Clear pending burn
                if (this.pendingBurn) {
                    console.log(` Burn cancelled for ${this.pendingBurn.plantName}`);
                    this.pendingBurn = null;
                }
            }

            // Confirm burn action
            confirmBurn() {
                if (!this.pendingBurn) {
                    console.error(' No pending burn to confirm');
                    return;
                }
                
                console.log(` Confirmed burning ${this.pendingBurn.plantName} in pot ${this.pendingBurn.potIndex}`);
                this.burnPlant(this.pendingBurn.potIndex);
                
                // Hide modal and clear pending burn
                this.cancelBurn();
            }

            // Burn the plant (replace with burnt vine and animate)
            burnPlant(potIndex) {
                console.log(` Starting burn process for pot ${potIndex}`);
                
                // Get the vine element from the growingPlants Map
                const plantData = this.growingPlants.get(potIndex);
                if (!plantData || !plantData.vineElement) {
                    console.log(' No growing plant found to burn for pot', potIndex);
                    return;
                }

                const vine = plantData.vineElement;
                
                // Play burn sound effect
                this.playSound('burn');
                console.log(' Playing burn sound effect');
                
                // Replace vine image with burnt version
                vine.style.backgroundImage = "url('Assets/burtvine.png')";
                vine.classList.add('burning');
                
                // Remove all beans from this pot
                this.removeBeansFromVine(potIndex);
                
                // Clear any existing transforms and animations so burn animation can take over
                vine.style.transform = 'translateX(-50%) scale(1, 1)'; // Start from full grown state
                vine.style.animation = '';
                vine.style.transformOrigin = 'bottom center'; // Make sure it shrinks into the pot
                vine.style.visibility = 'visible'; // Ensure vine stays visible during burn
                
                console.log(' Vine setup for burn:', {
                    transform: vine.style.transform,
                    visibility: vine.style.visibility,
                    className: vine.className
                });
                
                // Animate burn shrinking (reverse of growth)
                setTimeout(() => {
                    console.log(' Starting burn shrink animation - reversing growth');
                    vine.style.animation = 'burnShrink 2s ease-in-out forwards';
                    
                    // ONLY remove after shrink animation completes
                    setTimeout(() => {
                        console.log(' Shrink animation completed, now removing vine');
                        this.completeBurn(potIndex);
                    }, 2000); // Match exact animation duration
                }, 200);
            }

            // Complete the burn process and keep burnt remnant in pot
            completeBurn(potIndex) {
                console.log(` Completing burn for pot ${potIndex}`);
                
                const pot = document.querySelector(`.pot[data-pot-index="${potIndex}"]`);
                
                // Get vine element from growingPlants Map and keep it as burnt remnant
                const plantData = this.growingPlants.get(potIndex);
                if (plantData && plantData.vineElement) {
                    // Don't remove the vine - keep it as a burnt stub in the pot
                    const vine = plantData.vineElement;
                    vine.classList.add('burnt-remnant');
                    vine.classList.remove('growing', 'ready', 'grown', 'burning');
                    
                    // Ensure it stays in the shrunken state (in case animation doesn't stick)
                    vine.style.transform = 'translateX(-50%) scale(0.3, 0)';
                    vine.style.filter = 'brightness(0.6) sepia(1) hue-rotate(35deg)';
                    vine.style.opacity = '0.8';
                    
                    console.log(' Vine kept as burnt remnant in pot');
                }
                
                // Remove any seeds that might be in the pot (these should be direct children)
                const seeds = pot?.querySelector('.seeds');
                if (seeds) seeds.remove();
                
                // Update pot state to burnt (not empty)
                pot.classList.remove('planted', 'growing', 'ready');
                pot.classList.add('burnt');
                
                // Keep plant data but mark it as burnt
                if (plantData) {
                    plantData.state = 'burnt';
                    plantData.burntAt = Date.now();
                }
                
                // Update pot data attribute
                pot.dataset.state = 'burnt';
                
                // IMMEDIATELY update local pot state to allow replanting
                if (this.pots[potIndex]) {
                    this.pots[potIndex].state = 'empty';  // Allow immediate replanting
                    this.pots[potIndex].data = { state: 'empty' };
                    console.log(` DEBUG: Local pot state updated to empty for pot ${potIndex}`);
                }
                
                // Sync with backend - clear the plant from the server
                this.syncBurnWithBackend(potIndex);
                
                console.log(` Pot ${potIndex} now contains burnt plant remnant (can be replanted over)`);
            }

            // Sync burn action with backend
            async syncBurnWithBackend(potIndex) {
                try {
                    console.log(` DEBUG: Syncing burn with backend for pot ${potIndex}`);
                    
                    const response = await fetch('/api/burn-plant', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            pot_index: potIndex
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log(` DEBUG: Backend burn sync successful for pot ${potIndex}`);
                        // Local state was already updated in completeBurn()
                    } else {
                        console.error(` DEBUG: Backend burn sync failed for pot ${potIndex}:`, result.message);
                    }
                } catch (error) {
                    console.error(` DEBUG: Error syncing burn with backend for pot ${potIndex}:`, error);
                }
            }

            // Show EPIC level up notification
            showEpicLevelUpNotification(newLevel) {
                // Clean text notification without box
                const notification = document.createElement('div');
                notification.className = 'epic-level-up-notification';
                notification.innerHTML = `
                    <div class="epic-level-up-text">LEVEL UP!</div>
                    <div class="epic-level-up-number">LEVEL ${newLevel}</div>
                `;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-weight: bold;
                    text-align: center;
                    z-index: 10000;
                    animation: cleanLevelUpAnimation 4s ease-out forwards;
                    pointer-events: none;
                    text-shadow: 
                        0 0 20px rgba(255, 215, 0, 1),
                        0 0 40px rgba(255, 215, 0, 0.8),
                        0 0 60px rgba(255, 215, 0, 0.6);
                `;

                // Add epic animation styles
                this.addEpicAnimationStyles();
                
                document.body.appendChild(notification);
                
                // Remove notification after animation
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 4000);
            }

            // Add all epic animation keyframes
            addEpicAnimationStyles() {
                if (!document.querySelector('style[data-epic-level-up]')) {
                    const style = document.createElement('style');
                    style.setAttribute('data-epic-level-up', 'true');
                    style.textContent = `
                        @keyframes cleanLevelUpAnimation {
                            0% { 
                                transform: translate(-50%, -50%) scale(0);
                                opacity: 0;
                            }
                            15% {
                                transform: translate(-50%, -50%) scale(1.5);
                                opacity: 1;
                            }
                            30% {
                                transform: translate(-50%, -50%) scale(1.2);
                            }
                            45% {
                                transform: translate(-50%, -50%) scale(1.3);
                            }
                            75% {
                                transform: translate(-50%, -50%) scale(1);
                                opacity: 1;
                            }
                            100% {
                                transform: translate(-50%, -200%) scale(0.7);
                                opacity: 0;
                            }
                        }

                        @keyframes epicFlash {
                            0% { opacity: 0; }
                            20% { opacity: 1; }
                            100% { opacity: 0; }
                        }

                        /* Particle animation removed */

                        @keyframes epicScreenShake {
                            0%, 100% { transform: translateX(0); }
                            10% { transform: translateX(-10px) translateY(5px); }
                            20% { transform: translateX(10px) translateY(-5px); }
                            30% { transform: translateX(-8px) translateY(8px); }
                            40% { transform: translateX(8px) translateY(-8px); }
                            50% { transform: translateX(-6px) translateY(3px); }
                            60% { transform: translateX(6px) translateY(-3px); }
                            70% { transform: translateX(-4px) translateY(4px); }
                            80% { transform: translateX(4px) translateY(-4px); }
                            90% { transform: translateX(-2px) translateY(2px); }
                        }

                        .level-bar-fill.level-up-epic {
                            animation: epicLevelBarPulse 3s ease-in-out;
                        }

                        @keyframes epicLevelBarPulse {
                            0%, 100% {
                                background: linear-gradient(90deg, #4CAF50, #8BC34A);
                                box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
                            }
                            25% {
                                background: linear-gradient(90deg, #FFD700, #FFC107);
                                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
                                transform: scaleY(1.3);
                            }
                            50% {
                                background: linear-gradient(90deg, #FF5722, #FF9800);
                                box-shadow: 0 0 60px rgba(255, 87, 34, 1);
                                transform: scaleY(1.5);
                            }
                            75% {
                                background: linear-gradient(90deg, #E91E63, #9C27B0);
                                box-shadow: 0 0 80px rgba(233, 30, 99, 1);
                                transform: scaleY(1.2);
                            }
                        }

                        .epic-screen-shake {
                            animation: epicScreenShake 2s linear;
                        }

                        .epic-level-up-text { 
                            font-size: 32px; 
                            margin-bottom: 10px; 
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                            animation: textGlow 1s ease-in-out infinite alternate;
                        }
                        
                        .epic-level-up-number { 
                            font-size: 48px; 
                            font-weight: 900;
                            margin-bottom: 10px;
                            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
                            animation: numberPulse 1.5s ease-in-out infinite;
                        }

                        @keyframes textGlow {
                            from { 
                                text-shadow: 
                                    0 0 20px rgba(255, 215, 0, 1),
                                    0 0 40px rgba(255, 215, 0, 0.8),
                                    0 0 60px rgba(255, 215, 0, 0.6); 
                            }
                            to { 
                                text-shadow: 
                                    0 0 30px rgba(255, 215, 0, 1),
                                    0 0 50px rgba(255, 215, 0, 1),
                                    0 0 80px rgba(255, 215, 0, 0.8); 
                            }
                        }

                        @keyframes numberPulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.1); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            // Initialize level bar on game start
            initializeLevelBar() {
                console.log(' Initializing level system...');
                console.log(` Starting level: ${this.currentLevel}, XP: ${this.currentXP.toFixed(1)}, Base requirement: ${this.baseXPRequirement}`);
                
                // Make sure level bar is visible
                const levelBarContainer = document.getElementById('levelBarContainer');
                if (levelBarContainer) {
                    levelBarContainer.style.display = 'block';
                    console.log(' Level bar container found and made visible');
                } else {
                    console.error(' Level bar container not found!');
                }
                
                // Only initialize XP to 0.0 if it hasn't been set yet (preserve existing XP)
                if (typeof this.currentXP === 'undefined' || this.currentXP === null) {
                    this.currentXP = 0.0;
                    console.log(' XP initialized to 0.0');
                } else {
                    console.log(` XP preserved at ${this.currentXP.toFixed(1)}`);
                }
                
                // Fire tool will be unlocked automatically when reaching level 3
                // (removed testing code that always unlocked it)
                
                this.updateLevelBar();
                console.log(' Level system initialized successfully');
                console.log(` XP needed for level 2: ${this.getTotalXPForLevel(2)}`);
                console.log(` XP needed for level 3: ${this.getTotalXPForLevel(3)}`);
            }

            // ===== AUDIO SYSTEM =====
            
            initializeAudioSystem() {
                console.log(' Initializing enhanced audio system...');
                
                // Preload background music tracks (only 2 now, loop between them)
                this.backgroundTracks = [
                    new Audio('Sound/backgroundmusic1.mp3'),
                    new Audio('Sound/backgroundmusic2.mp3')
                ];
                
                // Configure background music tracks for seamless rotation
                this.currentTrackIndex = 0;
                this.backgroundTracks.forEach((track, index) => {
                    track.volume = 0.4; // Background music quieter
                    track.preload = 'auto';
                    track.addEventListener('ended', () => this.playNextBackgroundTrack());
                });
                
                this.backgroundMusic = this.backgroundTracks[0]; // Current playing track
                
                // Preload all sound effects including new ones
                this.sounds = {
                    coin: new Audio('Sound/coin.mp3'),
                    collectbean: new Audio('Sound/collectbean.mp3'),
                    collectbean2: new Audio('Sound/collectbean2.mp3'),
                    collectsilver: new Audio('Sound/collectsilver.mp3'),
                    goldcollect: new Audio('Sound/goldcollect.mp3'),
                    purchase: new Audio('Sound/purchase.mp3'),
                    levelup: new Audio('Sound/levelup.mp3'),
                    burn: new Audio('Sound/burn.mp3'),
                    swoosh: new Audio('Sound/swoosh.mp3'),
                    notification: new Audio('Sound/notification.mp3'),
                    plant: new Audio('Sound/plant.mp3')
                };
                
                // Set volume for all sounds
                Object.values(this.sounds).forEach(sound => {
                    sound.volume = this.volume;
                    sound.preload = 'auto';
                });
                
                console.log(' Enhanced audio system initialized with 3 background tracks and special effects!');
            }

            startBackgroundMusic() {
                if (this.backgroundMusic) {
                    // Start with track 1, will rotate automatically
                    this.currentTrackIndex = 0;
                    this.backgroundMusic = this.backgroundTracks[this.currentTrackIndex];
                    
                    // Try to play immediately, but handle autoplay restrictions
                    this.backgroundMusic.play().then(() => {
                        console.log(' Background music started successfully - Track ' + (this.currentTrackIndex + 1));
                    }).catch(error => {
                        console.log(' Background music autoplay blocked - will start on first user interaction');
                        // Add a one-time click listener to start music on first interaction
                        const startMusicOnClick = () => {
                            this.backgroundMusic.play().then(() => {
                                console.log(' Background music started after user interaction - Track ' + (this.currentTrackIndex + 1));
                            });
                            document.removeEventListener('click', startMusicOnClick);
                        };
                        document.addEventListener('click', startMusicOnClick);
                    });
                }
            }
            
            playNextBackgroundTrack() {
                // Rotate to next track
                this.currentTrackIndex = (this.currentTrackIndex + 1) % this.backgroundTracks.length;
                this.backgroundMusic = this.backgroundTracks[this.currentTrackIndex];
                
                // Play the next track
                this.backgroundMusic.play().then(() => {
                    console.log(' Switched to background music track ' + (this.currentTrackIndex + 1));
                }).catch(error => {
                    console.log(' Failed to switch background track:', error);
                });
            }

            playSound(soundName) {
                const sound = this.sounds[soundName];
                if (sound) {
                    // Create a clone for overlapping sounds
                    const soundClone = sound.cloneNode();
                    soundClone.volume = this.volume;
                    soundClone.play().catch(error => {
                        console.log(` Failed to play sound: ${soundName}`, error);
                    });
                }
            }

            // ===== BEAN COLLECTION INDEX SYSTEM =====
            
            initializeBeanIndex() {
                console.log(' Initializing bean collection system');
                
                const beanButton = document.getElementById('beanCollectionButton');
                const beanModal = document.getElementById('beanCollectionModal');
                const beanGrid = document.getElementById('beanGrid');
                const beanModalClose = document.getElementById('beanModalClose');
                
                if (!beanButton || !beanModal || !beanGrid || !beanModalClose) {
                    console.error(' Bean collection elements not found!');
                    return;
                }
                
                // Don't show the button yet - it unlocks at level 3
                
                // Clear existing grid
                beanGrid.innerHTML = '';
                
                // Create slots for all bean types
                this.allBeanTypes.forEach((beanType, index) => {
                    const slot = document.createElement('div');
                    slot.className = 'bean-slot locked';
                    slot.dataset.beanName = beanType.name;
                    
                    // Show locked state initially
                    slot.innerHTML = `
                        <img class="bean-slot-image" src="${beanType.image}" alt="${beanType.name}" />
                        <div class="bean-slot-name">???</div>
                    `;
                    
                    beanGrid.appendChild(slot);
                });
                
                // Setup modal event listeners
                beanButton.addEventListener('click', () => {
                    this.playSound('swoosh');
                    beanModal.classList.add('active');
                    this.updateBeanCollectionCount();
                });
                
                beanModalClose.addEventListener('click', () => {
                    this.playSound('swoosh');
                    beanModal.classList.remove('active');
                });
                
                // Close modal when clicking outside
                beanModal.addEventListener('click', (e) => {
                    if (e.target === beanModal) {
                        this.playSound('swoosh');
                        beanModal.classList.remove('active');
                    }
                });
                
                console.log(' Bean collection system initialized with', this.allBeanTypes.length, 'beans');
            }
            
            updateBeanCollectionCount() {
                const countElement = document.getElementById('beanCollectionCount');
                if (countElement) {
                    countElement.textContent = `(${this.beanCollection.size}/${this.allBeanTypes.length})`;
                }
            }
            
            unlockBean(plantName) {
                if (!this.beanCollection.has(plantName)) {
                    this.beanCollection.add(plantName);
                    console.log(' Bean unlocked:', plantName);
                    
                    // Find the matching bean type
                    const beanType = this.allBeanTypes.find(bean => bean.name === plantName);
                    if (beanType) {
                        // Update the visual slot
                        const slot = document.querySelector(`[data-bean-name="${plantName}"]`);
                        if (slot) {
                            slot.className = 'bean-slot unlocked';
                            slot.innerHTML = `
                                <img class="bean-slot-image" src="${beanType.image}" alt="${beanType.name}" />
                                <div class="bean-slot-name">${beanType.name}</div>
                            `;
                            
                            // Add unlock animation
                            slot.style.animation = 'beanUnlock 1.2s ease-out';
                            setTimeout(() => {
                                slot.style.animation = '';
                            }, 1200);
                        }
                        
                        // Play unlock sound
                        this.playSound('coin'); // Use coin sound for bean unlock
                        
                        // Update collection count
                        this.updateBeanCollectionCount();
                        
                        console.log(` Bean unlocked: ${plantName} (${this.beanCollection.size}/${this.allBeanTypes.length})`);
                    }
                }
            }

            // ===== TUTORIAL SYSTEM =====
            
            getTutorialSteps() {
                return [
                    {
                        title: " Welcome to Grow a Beanstalk!",
                        icon: "",
                        text: "Let's learn how to grow your first beanstalk! Click anywhere to start your gardening journey.",
                        checkComplete: () => true // Always complete immediately
                    },
                    {
                        title: " Open Your Inventory",
                        icon: "",
                        text: "First, open your inventory by clicking the inventory button at the bottom of the screen. You should see your first seed waiting for you!",
                        checkComplete: () => this.tutorialData.inventoryOpened
                    },
                    {
                        title: " Plant Your First Seed",
                        icon: "",
                        text: "Great! Now drag your seed from the inventory and drop it on any empty pot to plant it. Watch as your beanstalk starts to grow!",
                        checkComplete: () => this.tutorialData.plantsPlanted >= 1
                    },
                    {
                        title: " Wait & Harvest Beans",
                        icon: "",
                        text: "Perfect! Your plant is growing. Wait for it to mature, then collect 25 beans by clicking on them. Each bean gives you money!",
                        checkComplete: () => this.tutorialData.beansCollected >= 25
                    },
                    {
                        title: " Buy Your Next Seed",
                        icon: "",
                        text: "Excellent work! Now use your earnings to buy a new seed from the shop. Open the shop and purchase any seed you can afford!",
                        checkComplete: () => this.tutorialData.seedsPurchased >= 1
                    },
                                    {
                    title: " Collect Silver Beans",
                    icon: "",
                    text: "Amazing! Now find and collect 3 silver beans (shiny variants). These are more valuable and appear randomly!",
                    checkComplete: () => this.tutorialData.silverBeansCollected >= 3
                },
                {
                    title: " Collect Golden Beans",
                    icon: "",
                    text: "Incredible progress! Now find and collect 3 golden beans (the rarest variants). These are extremely valuable!",
                    checkComplete: () => this.tutorialData.goldBeansCollected >= 3
                    }
                ];
            }
            
            startTutorial() {
                console.log(' DEBUG: Starting tutorial every time game starts...');
                this.tutorialActive = true;
                this.tutorialStep = 0;
                
                // Reset tutorial data
                this.tutorialData = {
                    beansCollected: 0,
                    seedsPurchased: 0,
                    plantsPlanted: 0,
                    inventoryOpened: false,
                    silverBeansCollected: 0,
                    goldBeansCollected: 0
                };
                
                // Add a small delay to ensure DOM elements are ready
                setTimeout(() => {
                this.showTutorialStep();
                this.setupTutorialEventListeners();
                this.showTutorialObjective();
                    console.log(' Tutorial started! Should be visible now.');
                }, 100);
            }
            
            setupTutorialEventListeners() {
                // No event listeners needed since we're only using the top-left objective box
                // Tutorial progresses automatically when tasks are completed
            }
            
            showTutorialStep() {
                const steps = this.getTutorialSteps();
                const currentStep = steps[this.tutorialStep];
                
                if (!currentStep) {
                    this.completeTutorial();
                    return;
                }
                
                // Don't show the modal overlay - only use the top-left objective box
                // The tutorial will guide through the top-left box only
                
                // Update the objective text immediately
                this.updateTutorialObjectiveText();
                
                // Check if step can be completed immediately (like welcome step)
                if (currentStep.checkComplete()) {
                    // Auto-advance after 2 seconds for steps that are immediately complete
                    setTimeout(() => {
                        if (this.tutorialActive && this.tutorialStep < steps.length - 1) {
                            this.nextTutorialStep();
                } else {
                            this.completeTutorial();
                        }
                    }, 2000);
                } else {
                    // Start checking for completion
                    this.checkTutorialStepCompletion();
                }
            }
            
            hideTutorial() {
                // No modal to hide since we only use the top-left objective box
                // This function is kept for compatibility but does nothing now
            }
            
            nextTutorialStep() {
                this.tutorialStep++;
                this.showTutorialStep();
                this.updateTutorialObjectiveText(); // Update objective text when step advances
            }
            
            checkTutorialStepCompletion() {
                if (!this.tutorialActive) return;
                
                const steps = this.getTutorialSteps();
                const currentStep = steps[this.tutorialStep];
                
                if (currentStep && currentStep.checkComplete()) {
                    // Step completed! Show next button or auto-advance
                    document.getElementById('tutorialNext').style.display = 'inline-block';
                    
                    // Auto-advance after 2 seconds for better UX
                    setTimeout(() => {
                        if (this.tutorialActive && this.tutorialStep < steps.length - 1) {
                            this.nextTutorialStep();
                        } else {
                            this.completeTutorial();
                        }
                    }, 2000);
                } else {
                    // Keep checking every second
                    setTimeout(() => this.checkTutorialStepCompletion(), 1000);
                }
            }
            
            skipTutorial() {
                console.log(' Tutorial cannot be skipped - this functionality has been disabled');
                // Tutorial skip functionality has been disabled
                return false;
            }
            
            completeTutorial() {
                this.tutorialActive = false;
                
                // Show completion message in tutorial UI
                this.showTutorialCompletionMessage();
                
                console.log(' Tutorial completed!');
            }

            showTutorialCompletionMessage() {
                const objective = document.getElementById('tutorialObjective');
                const objectiveTextElement = document.getElementById('tutorialObjectiveText');
                const objectiveIconElement = document.getElementById('tutorialObjectiveIcon');
                const progressContainer = document.getElementById('tutorialProgressContainer');

                if (objective && objectiveTextElement && objectiveIconElement) {
                    // Hide progress bar for completion message
                    progressContainer.style.display = 'none';
                    
                    // Update content for completion message
                    objectiveIconElement.textContent = '';
                    objectiveTextElement.innerHTML = `
                        <div class="tutorial-completion-message">
                            <div class="tutorial-completion-title">Tutorial Complete!</div>
                            <div class="tutorial-completion-content">
                                Reach 100 Million as fast as you can.
                            </div>
                            <button class="tutorial-dismiss-btn" onclick="gameManager.dismissTutorialCompletion()">
                                 Got it!
                            </button>
                        </div>
                    `;
                    
                    // Add special styling for completion message
                    objective.classList.add('tutorial-completed');
                    
                    // Show the tutorial objective with completion message
                    this.showTutorialObjective();
                }
            }

            dismissTutorialCompletion() {
                const objective = document.getElementById('tutorialObjective');
                if (objective) {
                    objective.classList.remove('tutorial-completed');
                    this.hideTutorialObjective();
                }
            }
            
            // Tutorial event tracking methods
            onTutorialInventoryOpened() {
                if (this.tutorialActive) {
                    this.tutorialData.inventoryOpened = true;
                    console.log(' Tutorial: Inventory opened!');
                    this.updateTutorialObjectiveText(); // Update progress bar
                }
            }
            
            onTutorialPlantPlanted() {
                if (this.tutorialActive) {
                    this.tutorialData.plantsPlanted++;
                    console.log(' Tutorial: Plant planted! Total:', this.tutorialData.plantsPlanted);
                    this.updateTutorialObjectiveText(); // Update progress bar
                }
            }
            
            onTutorialBeanCollected(beanRarity = 'none', beanSize = 'normal') {
                if (this.tutorialActive) {
                    // Always count regular beans
                    this.tutorialData.beansCollected++;
                    console.log(' Tutorial: Bean collected! Total:', this.tutorialData.beansCollected);
                    
                    // Count special beans separately
                    if (beanRarity === 'shiny') {
                        this.tutorialData.silverBeansCollected++;
                        console.log(' Tutorial: Silver bean collected! Total:', this.tutorialData.silverBeansCollected);
                    } else if (beanRarity === 'golden') {
                        this.tutorialData.goldBeansCollected++;
                        console.log(' Tutorial: Golden bean collected! Total:', this.tutorialData.goldBeansCollected);
                    }
                    
                    // Log size information for future tutorial expansion
                    if (beanSize === 'big') {
                        console.log(' Tutorial: Big bean collected!');
                    } else if (beanSize === 'massive') {
                        console.log(' Tutorial: Massive bean collected!');
                    }
                    
                    this.updateTutorialObjectiveText(); // Update objective and progress bar
                    
                    // Add a slight delay to make the progress bar animation more noticeable
                    setTimeout(() => {
                        this.updateTutorialObjectiveText();
                    }, 50);
                }
            }
            
            onTutorialSeedPurchased() {
                if (this.tutorialActive) {
                    this.tutorialData.seedsPurchased++;
                    console.log(' Tutorial: Seed purchased! Total:', this.tutorialData.seedsPurchased);
                    this.updateTutorialObjectiveText(); // Update progress bar
                }
            }
            
            // Developer helper method to reset tutorial (call from console: window.gameManager.resetTutorial())
            resetTutorial() {
                console.log(' Tutorial reset! Starting tutorial now...');
                this.startTutorial();
            }
            
            // Force start tutorial (call from console: window.gameManager.forceStartTutorial())
            forceStartTutorial() {
                console.log(' DEBUG: Force starting tutorial...');
                this.tutorialActive = true;
                this.tutorialStep = 0;
                this.showTutorialStep();
                this.setupTutorialEventListeners();
                this.showTutorialObjective();
                console.log(' Tutorial force started!');
            }
            
            // Console command to level up (call from console: levelUp() or levelUp(5) for multiple levels)
            levelUpConsole(levels = 1) {
                console.log(` Console Level Up! Adding ${levels} level(s)...`);
                for (let i = 0; i < levels; i++) {
                    const xpNeeded = this.getTotalXPForLevel(this.currentLevel + 1) - this.currentXP;
                    this.addXP(xpNeeded, 'console_command');
                }
                console.log(` Level up complete! Current level: ${this.currentLevel}`);
            }
            
            // Tutorial Objective UI Management
            showTutorialObjective() {
                console.log(' DEBUG: showTutorialObjective called, tutorialActive:', this.tutorialActive);
                const objectiveElement = document.getElementById('tutorialObjective');
                console.log(' DEBUG: Found objective element:', !!objectiveElement);
                
                if (this.tutorialActive && objectiveElement) {
                    objectiveElement.classList.add('active');
                    this.updateTutorialObjectiveText();
                    console.log(' DEBUG: Tutorial objective should now be visible!');
                } else {
                    console.log(' DEBUG: Tutorial objective not shown - tutorialActive:', this.tutorialActive, 'element found:', !!objectiveElement);
                }
            }
            
            hideTutorialObjective() {
                const objectiveElement = document.getElementById('tutorialObjective');
                objectiveElement.classList.remove('active');
            }
            
            updateTutorialObjectiveText() {
                const steps = this.getTutorialSteps();
                const currentStep = steps[this.tutorialStep];
                const objectiveTextElement = document.getElementById('tutorialObjectiveText');
                const objectiveIconElement = document.getElementById('tutorialObjectiveIcon');
                const progressContainer = document.getElementById('tutorialProgressContainer');
                const progressFill = document.getElementById('tutorialProgressFill');
                const progressText = document.getElementById('tutorialProgressText');
                
                if (currentStep) {
                    // Create detailed objective text with improved wording
                    let objectiveText = '';
                    let icon = '';
                    let showProgress = false;
                    let progressPercent = 0;
                    let progressTextContent = '';
                    
                    switch(this.tutorialStep) {
                        case 0:
                            icon = '';
                            objectiveText = 'Welcome to Grow a Beanstalk! Let\'s get started!';
                            break;
                        case 1:
                            icon = '';
                            if (this.tutorialData.inventoryOpened) {
                                objectiveText = 'Step 1: Perfect! Inventory opened ';
                                showProgress = true;
                                progressPercent = 100;
                                progressTextContent = 'Inventory opened!';
                            } else {
                                objectiveText = 'Step 1: Click the inventory button';
                                showProgress = true;
                                progressPercent = 0;
                                progressTextContent = 'Click the inventory button';
                            }
                            break;
                        case 2:
                            icon = '';
                            if (this.tutorialData.plantsPlanted >= 1) {
                                objectiveText = 'Step 2: Excellent! Seed planted ';
                                showProgress = true;
                                progressPercent = 100;
                                progressTextContent = 'Seed planted successfully!';
                            } else {
                                objectiveText = 'Step 2: Drag a seed from your inventory onto an empty pot';
                                showProgress = true;
                                progressPercent = this.tutorialData.inventoryOpened ? 50 : 0;
                                progressTextContent = this.tutorialData.inventoryOpened ? 'Now drag a seed to a pot' : 'Open inventory first';
                            }
                            break;
                        case 3:
                            icon = '';
                            const beansNeeded = 25;
                            const beansCollected = this.tutorialData.beansCollected;
                            const beansRemaining = Math.max(0, beansNeeded - beansCollected);
                            
                            if (beansRemaining > 0) {
                                objectiveText = `Step 3: Wait for your plant to grow, then collect 25 beans!`;
                            } else {
                                objectiveText = 'Step 3: Amazing! You\'ve collected enough beans! ';
                            }
                            
                            showProgress = true;
                            progressPercent = Math.min((beansCollected / beansNeeded) * 100, 100);
                            progressTextContent = `${beansCollected} / ${beansNeeded} beans collected`;
                            break;
                        case 4:
                            icon = '';
                            if (this.tutorialData.seedsPurchased >= 1) {
                                objectiveText = 'Step 4: Perfect! Seed purchased ';
                                showProgress = true;
                                progressPercent = 100;
                                progressTextContent = 'Seed purchased successfully!';
                            } else {
                                objectiveText = 'Step 4: Use your coins to buy another seed from the shop!';
                                showProgress = true;
                                progressPercent = 0;
                                progressTextContent = 'Buy a seed from the shop';
                            }
                            break;
                        case 5:
                            icon = '';
                            const silverNeeded = 3;
                            const silverCollected = this.tutorialData.silverBeansCollected;
                            const silverRemaining = Math.max(0, silverNeeded - silverCollected);
                            
                            if (silverRemaining > 0) {
                                objectiveText = `Step 5: Find and collect ${silverRemaining} more silver beans (shiny variants)!`;
                            } else {
                                objectiveText = 'Step 5: Excellent! You\'ve collected all silver beans! ';
                            }
                            
                            showProgress = true;
                            progressPercent = Math.min((silverCollected / silverNeeded) * 100, 100);
                            progressTextContent = `${silverCollected} / ${silverNeeded} silver beans collected`;
                            break;
                        case 6:
                            icon = '';
                            const goldNeeded = 3;
                            const goldCollected = this.tutorialData.goldBeansCollected;
                            const goldRemaining = Math.max(0, goldNeeded - goldCollected);
                            
                            if (goldRemaining > 0) {
                                objectiveText = `Step 6: Find and collect ${goldRemaining} more golden beans (rarest variants)!`;
                            } else {
                                objectiveText = 'Step 6: Fantastic! Tutorial complete! ';
                            }
                            
                            showProgress = true;
                            progressPercent = Math.min((goldCollected / goldNeeded) * 100, 100);
                            progressTextContent = `${goldCollected} / ${goldNeeded} golden beans collected`;
                            break;
                        default:
                            objectiveText = 'Follow the tutorial to learn the game!';
                    }
                    
                    // Update the display
                    objectiveTextElement.textContent = objectiveText;
                    objectiveIconElement.textContent = icon;
                    
                    // Show/hide and update progress bar
                    if (showProgress) {
                        progressContainer.style.display = 'block';
                        progressFill.style.width = progressPercent + '%';
                        progressText.textContent = progressTextContent;
                        
                        // Add completion styling when progress reaches 100%
                        if (progressPercent >= 100) {
                            progressFill.classList.add('complete');
                        } else {
                            progressFill.classList.remove('complete');
                        }
                    } else {
                        progressContainer.style.display = 'none';
                    }
                }
            }

            // Show satisfying money burst effect
            showMoneyBurst(x, y, amount) {
                const burst = document.createElement('div');
                burst.className = 'money-burst';
                burst.textContent = `+$${amount.toLocaleString()}`;
                burst.style.left = (x - 50) + 'px'; // Center the text
                burst.style.top = (y - 10) + 'px';
                
                document.body.appendChild(burst);
                
                // Remove burst after animation
                setTimeout(() => {
                    burst.remove();
                }, 1500);
            }

            // Initialize plant data
            initializePlantData() {
                return [
                    // Common Plants
                    { name: 'Beanstalk', type: 'Picker', growthTime: 25, buyPrice: 50, sellPrice: 14, rarity: 'Common', availability: 8 },
                    { name: 'Snap Pea', type: 'Picker', growthTime: 75, buyPrice: 90, sellPrice: 90, rarity: 'Common', availability: 7 },
                    { name: 'Jellybean Vine', type: 'Picker', growthTime: 90, buyPrice: 170, sellPrice: 170, rarity: 'Common', availability: 6 },
                    { name: 'Bamboo-Bean', type: 'Cutter', growthTime: 120, buyPrice: 300, sellPrice: 300, rarity: 'Common', availability: 6 },
                    { name: 'Coffee Creeper', type: 'Picker', growthTime: 120, buyPrice: 540, sellPrice: 540, rarity: 'Common', availability: 5 },
                    { name: 'Thunder Pod', type: 'Cutter', growthTime: 150, buyPrice: 970, sellPrice: 970, rarity: 'Common', availability: 4 },
                    { name: 'Frost Pea', type: 'Picker', growthTime: 150, buyPrice: 1700, sellPrice: 2700, rarity: 'Common', availability: 3 },
                    { name: 'Choco Vine', type: 'Picker', growthTime: 180, buyPrice: 3000, sellPrice: 3500, rarity: 'Common', availability: 2 },
                    
                    // Uncommon Plants
                    { name: 'Ironvine', type: 'Cutter', growthTime: 210, buyPrice: 5300, sellPrice: 15300, rarity: 'Uncommon', availability: 7 },
                    { name: 'Honeyvine', type: 'Picker', growthTime: 180, buyPrice: 9300, sellPrice: 19300, rarity: 'Uncommon', availability: 6 },
                    { name: 'Sunbean', type: 'Picker', growthTime: 240, buyPrice: 16000, sellPrice: 25500, rarity: 'Uncommon', availability: 5 },
                    { name: 'Moonbean', type: 'Picker', growthTime: 240, buyPrice: 28000, sellPrice: 43000, rarity: 'Uncommon', availability: 4 },
                    { name: 'Cloud Creeper', type: 'Picker', growthTime: 270, buyPrice: 49000, sellPrice: 49000, rarity: 'Uncommon', availability: 3 },
                    { name: 'Royal Stalk', type: 'Cutter', growthTime: 300, buyPrice: 86000, sellPrice: 86000, rarity: 'Uncommon', availability: 2 },
                    { name: 'Crystal Bean', type: 'Picker', growthTime: 300, buyPrice: 150000, sellPrice: 120000, rarity: 'Uncommon', availability: 1 },
                    
                    // Rare Plants
                    { name: 'Neon Soy', type: 'Cutter', growthTime: 330, buyPrice: 260000, sellPrice: 160000, rarity: 'Rare', availability: 5 },
                    { name: 'Vinecorn', type: 'Cutter', growthTime: 240, buyPrice: 450000, sellPrice: 210000, rarity: 'Rare', availability: 4 },
                    { name: 'Fire Pod', type: 'Cutter', growthTime: 360, buyPrice: 780000, sellPrice: 280000, rarity: 'Rare', availability: 3 },
                    { name: 'Shadow Bean', type: 'Picker', growthTime: 300, buyPrice: 1350000, sellPrice: 320000, rarity: 'Rare', availability: 2 },
                    { name: 'Prism Stalk', type: 'Picker', growthTime: 480, buyPrice: 2340000, sellPrice: 340000, rarity: 'Rare', availability: 1 }
                ];
            }

            // Initialize modifier data
            initializeModifierData() {
                return {
                    size: [
                        { name: 'Normal', multiplier: 1.0, probability: 65, description: 'Standard size' },
                        { name: 'Large', multiplier: 1.8, probability: 30, description: '1.8 size boost' },
                        { name: 'Massive', multiplier: 3.2, probability: 5, description: '3.2 size boost' }
                    ],
                    finish: [
                        { name: 'None', multiplier: 1.0, probability: 95, description: 'No special finish' },
                        { name: 'Shiny', multiplier: 1.5, probability: 3, description: '1.5 value boost' },
                        { name: 'Golden', multiplier: 2.0, probability: 2, description: '2.0 value boost' }
                    ]
                };
            }
        }

        // Initialize game when page loads
        window.addEventListener('DOMContentLoaded', () => {
            window.gameManager = new GameManager();
            
            // Add global console commands for debugging
            window.levelUp = (levels = 1) => {
                if (window.gameManager) {
                    window.gameManager.levelUpConsole(levels);
                } else {
                    console.error(' Game not loaded yet! Wait for the game to start.');
                }
            };
            
            window.addXP = (amount) => {
                if (window.gameManager) {
                    window.gameManager.addXP(amount, 'console_command');
                    console.log(` Added ${amount} XP! Current: ${window.gameManager.currentXP} XP, Level: ${window.gameManager.currentLevel}`);
                } else {
                    console.error(' Game not loaded yet! Wait for the game to start.');
                }
            };
        });

        // Handle escape key to exit fullscreen
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && window.gameManager && window.gameManager.isFullscreen) {
                document.exitFullscreen();
                window.gameManager.isFullscreen = false;
            }
        });
    </script>
</body>
</html>
